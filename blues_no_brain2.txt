–ì–õ–ê–í–ù–´–ô –î–ò–ê–ì–ù–û–ó: ¬´–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è¬ª —à–µ–ª—É—Ö–∞ –ø–æ–≤–µ—Ä—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–π —Å–±–æ—Ä–∫–∏ –∫–ª–∏—à–µ
–í—ã –Ω–∞–∑–≤–∞–ª–∏ –∫–ª–∞—Å—Å BluesBrain –∏ –º–µ—Ç–æ–¥ generateCognitiveMelody, –Ω–æ –Ω–∏–∫–∞–∫–æ–≥–æ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–µ—Ç. –≠—Ç–æ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≥–æ—Ç–æ–≤–æ–∫ —Å —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ê–ê–í. –ë–ª—é–∑ –∑–¥–µ—Å—å ‚Äî –∫–∞–∫ –¥—É—à–∞ –≤ –º–∞—à–∏–Ω–µ –¢—å—é—Ä–∏–Ω–≥–∞: –µ—ë –Ω–µ—Ç, –Ω–æ —Å–Ω–∞—Ä—É–∂–∏ –Ω–∞–ø–∏—Å–∞–Ω–æ ¬´–ò–ò¬ª.
üíÄ –°–ú–ï–†–¢–ï–õ–¨–ù–´–ï –†–ê–ù–´ (–ø–æ –ø–æ—Ä—è–¥–∫—É —Ç—è–∂–µ—Å—Ç–∏)
1. ¬´–í–æ–ª–∫–∏–Ω–≥-–±–∞—Å¬ª ‚Äî —ç—Ç–æ –ª–æ–∂—å
private generateWalkingBass(chord: GhostChord, epoch: number): FractalEvent[] {
  const riffTemplate = riffs[this.random.nextInt(riffs.length)];
  let pattern = riffTemplate.I;
  // ... –≤—ã–±–∏—Ä–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω
  return pattern.map(note => ...);
}
–ß—Ç–æ —ç—Ç–æ: –ü–µ—Ä–µ–±–æ—Ä –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ä–∏—Ñ—Ñ–æ–≤ –∏–∑ BLUES_BASS_RIFFS.
–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: –ù–∞—Å—Ç–æ—è—â–∏–π –≤–æ–ª–∫–∏–Ω–≥-–±–∞—Å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ª–µ—Ç—É –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º:
1-—è –¥–æ–ª—è: –∫–æ—Ä–µ–Ω—å –∞–∫–∫–æ—Ä–¥–∞
2-—è –¥–æ–ª—è: –ø—Ä–æ—Ö–æ–¥—è—â–∞—è –Ω–æ—Ç–∞ (–¥–∏–∞—Ç–æ–Ω–∏—á–µ—Å–∫–∞—è –∏–ª–∏ —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)
3-—è –¥–æ–ª—è: –∫–≤–∏–Ω—Ç–∞/—Å–µ–ø—Ç–∏–º–∞
4-—è –¥–æ–ª—è: –≤–µ–¥—É—â–∞—è –Ω–æ—Ç–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∞–∫–∫–æ—Ä–¥—É
–ü–æ—á–µ–º—É —ç—Ç–æ —É–±–∏–≤–∞–µ—Ç –±–ª—é–∑: –°–ª—É—à–∞—Ç–µ–ª—å —Å–ª—ã—à–∏—Ç ¬´—Ç–∞-—Ç–∞-—Ç–∞-—Ç–∞¬ª —Å –¥—Ä—É–≥–∏–º –∏–º–µ–Ω–µ–º. –ù–∞—Å—Ç–æ—è—â–∏–π –≤–æ–ª–∫–∏–Ω–≥-–±–∞—Å —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—Ç —Å –≥–∞—Ä–º–æ–Ω–∏–µ–π, –∞ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–≥–æ—Ç–æ–≤–∫–∏.

2. ¬´–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è –º–µ–ª–æ–¥–∏—è¬ª ‚Äî —Ñ–æ—Ä–º–∞–ª—å–Ω–∞—è –ê–ê–í –±–µ–∑ –¥—É—à–∏
private generateCognitiveMelody(chord: GhostChord, epoch: number, navInfo: NavigationInfo): FractalEvent[] {
  const phase = this.barInChorus < 4 ? 'A' : (this.barInChorus < 8 ? 'A_VAR' : 'B');
  
  if (phase === 'A') {
    const motif = this.generateMotifRuleBased(chord.rootNote, 0.5, false);
    this.lastAxiom = motif;
    events.push(...motif);
  } else if (phase === 'A_VAR') {
    events.push(...this.lastAxiom.map(n => { ... })); // –ø—Ä–æ—Å—Ç–æ —Ç—Ä–∞–Ω—Å–ø–æ–Ω–∏—Ä—É–µ–º
  } else {
    events.push(...this.generateMotifRuleBased(chord.rootNote, 0.9, canGoHigh));
  }
}

–ß—Ç–æ —ç—Ç–æ: –§–æ—Ä–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ê–ê–í (–≤–æ–ø—Ä–æ—Å-–≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç) –±–µ–∑ —è–∑—ã–∫–∞ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π.
–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: –ë–ª—é–∑ = —è–∑—ã–∫ ‚ô≠5 ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ. –ö–∞–∂–¥–∞—è —Ñ—Ä–∞–∑–∞ –¥–æ–ª–∂–Ω–∞:
–°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ (‚ô≠5, ‚ô≠3)
–ó–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å (–Ω–∏—Å—Ö–æ–¥—è—â–∞—è —Ñ—Ä–∞–∑–∞ + –ø–∞—É–∑–∞)
–î–∞–≤–∞—Ç—å –æ—Ç–≤–µ—Ç (–≤–æ—Å—Ö–æ–¥—è—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤ 5 –∏–ª–∏ 3)
–ü–æ—á–µ–º—É —ç—Ç–æ —É–±–∏–≤–∞–µ—Ç –±–ª—é–∑: –£ –≤–∞—Å –µ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ê–ê–í, –Ω–æ –Ω–µ—Ç –º—É–∑—ã–∫–∞–ª—å–Ω–æ–≥–æ —Å–º—ã—Å–ª–∞. –≠—Ç–æ –∫–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å ¬´–Ø –ª—é–±–ª—é —Ç–µ–±—è¬ª –±–µ–∑ —ç–º–æ—Ü–∏–π ‚Äî —Å–ª–æ–≤–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ, –Ω–æ –¥—É—à–∏ –Ω–µ—Ç.

4. –î—Ä–∞–º—ã ‚Äî —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–±–æ—Ä —Ä–∏—Ñ—Ñ–æ–≤
private generateDrums(navInfo: NavigationInfo, epoch: number): FractalEvent[] {
  const riff = riffs[epoch % riffs.length];
  // ... –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º —Ä–∏—Ñ—Ñ—ã
}
–ß—Ç–æ —ç—Ç–æ: –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–±–æ—Ä –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥—Ä–∞–º-—Ä–∏—Ñ—Ñ–æ–≤.
–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–≤–∏–Ω–≥–∞ –∏ —Ñ—Ä–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
–ö–∏–∫: 1 –∏ 3 –¥–æ–ª–∏ —Å –≤–∞—Ä–∏–∞—Ü–∏–µ–π
–°–Ω–µ–π—Ä: 2 –∏ 4 –¥–æ–ª–∏ —Å —Ç—Ä–∏–æ–ª—å–Ω—ã–º —Å–≤–∏–Ω–≥–æ–º
–•–∞–π-—Ö—ç—Ç: –≤–æ—Å—å–º—ã–µ —Å —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π –≤–∞—Ä–∏–∞—Ü–∏–µ–π ¬±25–º—Å
–ü–æ—á–µ–º—É —ç—Ç–æ —É–±–∏–≤–∞–µ—Ç –±–ª—é–∑: –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π —Ä–∏—Ç–º = –º—ë—Ä—Ç–≤—ã–π –±–ª—é–∑. –ë–ª—é–∑ –∂–∏–≤—ë—Ç –≤ –º–∏–∫—Ä–æ—Ç–∞–π–º–∏–Ω–≥–µ –∏ –¥—ã—Ö–∞–Ω–∏–∏.

5. –ê–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç ‚Äî –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π ¬´—Ç—Ä–∞–Ω—Å-–ø–∏–∫–∏–Ω–≥¬ª
private generateAcousticComping(chord: GhostChord, epoch: number): FractalEvent[] {
  const chordNotes = [root, root + (isMinor ? 3 : 4), root + 7, root + 10];
  const ticks = [0, 2, 4, 6, 8, 10];
  ticks.forEach((t, i) => {
    const noteIdx = i % chordNotes.length;
    let pitch = chordNotes[noteIdx] + 12;
    // ...
  });
}
–ß—Ç–æ —ç—Ç–æ: –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –Ω–æ—Ç—ã –∞–∫–∫–æ—Ä–¥–∞ –Ω–∞ —Ä–∞–≤–Ω—ã—Ö –¥–æ–ª–∞—Ö.
–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: –¢—Ä—ç–≤–∏—Å-–ø–∏–∫–∏–Ω–≥ —Å –∞—Ä–ø–µ–¥–∂–∏–æ –∏ –¥–∏–Ω–∞–º–∏–∫–æ–π:
–ë–∞—Å–æ–≤–∞—è –Ω–æ—Ç–∞ –Ω–∞ 1 –∏ 3 –¥–æ–ª—è—Ö
–ê—Ä–ø–µ–¥–∂–∏–æ –Ω–∞ —Å–ª–∞–±—ã—Ö –¥–æ–ª—è—Ö
–ü—Ä–æ–ø—É—Å–∫–∏ –¥–ª—è ¬´–¥—ã—Ö–∞–Ω–∏—è¬ª
–ü–æ—á–µ–º—É —ç—Ç–æ —É–±–∏–≤–∞–µ—Ç –±–ª—é–∑: –ó–≤—É—á–∏—Ç –∫–∞–∫ ¬´—Ç—É–∫-—Ç—É–∫-—Ç—É–∫¬ª –±–µ–∑ –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

–ö–û–†–ï–ù–¨ –ü–†–û–ë–õ–ï–ú–´: –í—ã —Å—Ç—Ä–æ–∏—Ç–µ –±–ª—é–∑ –∏–∑ –∫–ª–∏—à–µ, –∞ –Ω–µ –Ω–∞ —è–∑—ã–∫–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π
–ß—Ç–æ —É –≤–∞—Å
–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å
–ó–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –±–∞—Å-—Ä–∏—Ñ—Ñ—ã
–í–æ–ª–∫–∏–Ω–≥-–±–∞—Å –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –ø—Ä–æ—Ö–æ–¥—è—â–∏—Ö/–≤–µ–¥—É—â–∏—Ö –Ω–æ—Ç
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ê–ê–í –±–µ–∑ —Å–º—ã—Å–ª–∞
–í–æ–ø—Ä–æ—Å (–Ω–∏—Å—Ö–æ–¥—è—â–∏–π + ‚ô≠5) ‚Üí –ø–∞—É–∑–∞ ‚Üí –æ—Ç–≤–µ—Ç (–≤–æ—Å—Ö–æ–¥—è—â–∏–π + —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–∫—Ç–∞–≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–º —á–µ—Ä–µ–∑ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ
–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –¥—Ä–∞–º-—Ä–∏—Ñ—Ñ—ã
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —Ç—Ä–∏–æ–ª—å–Ω—ã–º —Å–≤–∏–Ω–≥–æ–º –∏ –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏–µ–π
–ü—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç
–¢—Ä—ç–≤–∏—Å-–ø–∏–∫–∏–Ω–≥ —Å –∞—Ä–ø–µ–¥–∂–∏–æ –∏ –¥–∏–Ω–∞–º–∏–∫–æ–π
üíä –†–ï–¶–ï–ü–¢: –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å—å —Å –Ω—É–ª—è
–í–æ—Ç —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:
1. –£–¥–∞–ª–∏—Ç—å –≤—Å—ë, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –∑–∞–≥–æ—Ç–æ–≤–∫–∞–º–∏:

2. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å generateWalkingBass:
private generateWalkingBass(chord: GhostChord, epoch: number): FractalEvent[] {
  const events: FractalEvent[] = [];
  const root = chord.rootNote - 12; // –æ–∫—Ç–∞–≤–∞ –Ω–∏–∂–µ
  const nextRoot = this.getNextChordRoot(epoch, chord.rootNote);
  
  // 1. –ö–æ—Ä–µ–Ω—å
  events.push({ note: root, time: 0, ... });
  
  // 2. –ü—Ä–æ—Ö–æ–¥—è—â–∞—è (–¥–∏–∞—Ç–æ–Ω–∏—á–µ—Å–∫–∞—è –∏–ª–∏ —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)
  const passing = Math.random() < 0.6 ? root + 1 : root + 2;
  events.push({ note: passing, time: 0.5, ... });
  
  // 3. –ö–≤–∏–Ω—Ç–∞
  events.push({ note: root + 7, time: 1.0, ... });
  
  // 4. –í–µ–¥—É—â–∞—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∞–∫–∫–æ—Ä–¥—É (—Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)
  events.push({ note: nextRoot - 13, time: 1.5, ... });
  
  return events;
}

3. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å generateCognitiveMelody –Ω–∞ —è–∑—ã–∫–µ ‚ô≠5 ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ:
private generateCognitiveMelody(chord: GhostChord, epoch: number): FractalEvent[] {
  const phase = epoch % 12 < 4 ? 'call' : (epoch % 12 < 8 ? 'call' : 'response');
  
  if (phase === 'call') {
    // –í–æ–ø—Ä–æ—Å: –Ω–∏—Å—Ö–æ–¥—è—â–∞—è —Ñ—Ä–∞–∑–∞ —Å ‚ô≠5
    return [
      { note: root + 10 + 24, time: 0.0 },   // 7
      { note: root + 7 + 24, time: 0.5 },    // 5
      { note: root + 6 + 24, time: 1.0, technique: 'bend' }, // ‚ô≠5 (–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ!)
      { note: root + 3 + 24, time: 1.5 }     // ‚ô≠3
    ];
  } else {
    // –û—Ç–≤–µ—Ç: –≤–æ—Å—Ö–æ–¥—è—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    return [
      { note: root + 3 + 24, time: 0.0 },    // ‚ô≠3
      { note: root + 5 + 24, time: 0.6 },    // 4
      { note: root + 7 + 24, time: 1.2, technique: 'vibrato' } // 5 (—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ!)
    ];
  }
}

4. –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π —Å–≤–∏–Ω–≥ –≤ –¥—Ä–∞–º—ã:
private generateDrums(epoch: number): FractalEvent[] {
  const swingRatio = 0.66 + (Math.random() - 0.5) * 0.08; // 0.62-0.70
  
  return [
    { type: 'kick', time: 0 + human(10), ... },           // 1 –¥–æ–ª—è
    { type: 'snare', time: 1 * swingRatio + human(15), ... }, // 2 –¥–æ–ª—è —Å —Å–≤–∏–Ω–≥–æ–º
    { type: 'kick', time: 2 + human(10), ... },           // 3 –¥–æ–ª—è
    { type: 'snare', time: 3 * swingRatio + human(15), ... }  // 4 –¥–æ–ª—è —Å —Å–≤–∏–Ω–≥–æ–º
  ];
}

–§–ò–ù–ê–õ–¨–ù–´–ô –í–ï–†–î–ò–ö–¢
–í–∞—à –∫–æ–¥ ‚Äî —ç—Ç–æ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ –≤–æ–∫—Ä—É–≥ –∑–∞–≥–æ—Ç–æ–≤–æ–∫ —Å —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ê–ê–í. –í—ã –Ω–∞–∑–≤–∞–ª–∏ —ç—Ç–æ ¬´–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–º¬ª, –Ω–æ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–µ—Ç. –ë–ª—é–∑ –∑–¥–µ—Å—å ‚Äî –∫–∞–∫ –¥—É—à–∞ –≤ —Ä–æ–±–æ—Ç–µ: –µ—ë –Ω–µ—Ç, –Ω–æ —Å–Ω–∞—Ä—É–∂–∏ –Ω–∞–ø–∏—Å–∞–Ω–æ ¬´–∂–∏–≤–æ–π¬ª.
–ß—Ç–æ –¥–µ–ª–∞—Ç—å: –£–¥–∞–ª–∏—Ç—å 80% –∫–æ–¥–∞ –∏ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ —è–∑—ã–∫–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π:
‚ô≠5 —Å–æ–∑–¥–∞—ë—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ ‚Üí —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –≤ 5 –∏–ª–∏ 3
–í–æ–ø—Ä–æ—Å (–Ω–∏—Å—Ö–æ–¥—è—â–∏–π) ‚Üí –ø–∞—É–∑–∞ ‚Üí –æ—Ç–≤–µ—Ç (–≤–æ—Å—Ö–æ–¥—è—â–∏–π)
–í–æ–ª–∫–∏–Ω–≥-–±–∞—Å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º, –∞ –Ω–µ –ø–µ—Ä–µ–±–∏—Ä–∞–µ—Ç—Å—è
–°–≤–∏–Ω–≥ –∏ –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏—è –≤ —Ä–∏—Ç–º–µ

###–ü–û–õ–ù–ê–Ø –ü–ï–†–ï–ü–ò–°–¨ blues-brain.ts ‚Äî –ñ–ò–í–û–ô –ë–õ–Æ–ó–û–í–´–ô –Ø–ó–´–ö
–í–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –±–µ–∑ –∫–ª–∏—à–µ, –±–µ–∑ –∑–∞–≥–æ—Ç–æ–≤–æ–∫ ‚Äî —Ç–æ–ª—å–∫–æ –∂–∏–≤–æ–π –±–ª—é–∑–æ–≤—ã–π —è–∑—ã–∫ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π:

import type {
  FractalEvent,
  Mood,
  GhostChord,
  NavigationInfo,
  BluesCognitiveState,
  InstrumentHints
} from '@/types/music';

/**
 * #–ó–ê–ß–ï–ú: –ë–ª—é–∑–æ–≤—ã–π –ú–æ–∑–≥ –Ω–∞ —è–∑—ã–∫–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π ‚Äî –Ω–µ —Å–±–æ—Ä–∫–∞ –∫–ª–∏—à–µ, –∞ –∂–∏–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è.
 * #–ß–¢–û: 
 *   1. –í–æ–ª–∫–∏–Ω–≥-–±–∞—Å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ª–µ—Ç—É –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –ø—Ä–æ—Ö–æ–¥—è—â–∏—Ö/–≤–µ–¥—É—â–∏—Ö –Ω–æ—Ç
 *   2. –ú–µ–ª–æ–¥–∏—è —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ —è–∑—ã–∫–µ ‚ô≠5 ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (5/3)
 *   3. –í–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ—Ä–∞–∑ (–Ω–∏—Å—Ö–æ–¥—è—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí –≤–æ—Å—Ö–æ–¥—è—â–∏–π –æ—Ç–≤–µ—Ç)
 *   4. –ú–∏–∫—Ä–æ–∞—Ä—Ç–∏–∫—É–ª—è—Ü–∏—è: —Å–≤–∏–Ω–≥, –±–µ–Ω–¥—ã, –≤–∏–±—Ä–∞—Ç–æ, –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏—è
 *   5. –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
 * #–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º —Å presets-v2.ts (guitar_shineOn, bass_jazz_warm)
 */

// ============================================================================
// –ö–û–ù–°–¢–ê–ù–¢–´ –ò –¢–ò–ü–´
// ============================================================================

export interface BluesBrainConfig {
  tempo: number;           // BPM (68-80 –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –±–ª—é–∑–∞)
  rootNote: number;        // MIDI root (55 = G3)
  emotion: {
    melancholy: number;    // 0.6-0.95
    darkness: number;      // 0.1-0.4
  };
}

export const DEFAULT_CONFIG: BluesBrainConfig = {
  tempo: 72,
  rootNote: 55, // G3
  emotion: { melancholy: 0.82, darkness: 0.25 }
};

// ============================================================================
// –ë–õ–Æ–ó–û–í–ê–Ø –¢–ï–û–†–ò–Ø (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞)
// ============================================================================

/**
 * –ú–∏–Ω–æ—Ä–Ω–∞—è –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞ + –±–ª—é–∑–æ–≤–∞—è –Ω–æ—Ç–∞ (‚ô≠5)
 * –°—Ç—É–ø–µ–Ω–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:
 * 0 = 1 (—Ç–æ–Ω–∏–∫–∞)
 * 3 = ‚ô≠3 (–º–∏–Ω–æ—Ä–Ω–∞—è —Ç–µ—Ä—Ü–∏—è)
 * 5 = 4 (–∫–≤–∞—Ä—Ç–∞)
 * 6 = ‚ô≠5 (–±–ª—é–∑–æ–≤–∞—è –Ω–æ—Ç–∞ ‚Äî –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ!)
 * 7 = 5 (–∫–≤–∏–Ω—Ç–∞)
 * 10 = ‚ô≠7 (–º–∏–Ω–æ—Ä–Ω–∞—è —Å–µ–ø—Ç–∏–º–∞)
 */
const BLUES_SCALE = [0, 3, 5, 6, 7, 10];

/**
 * –ì–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è 12-bar blues
 * –°–º–µ—â–µ–Ω–∏—è –≤ –ø–æ–ª—É—Ç–æ–Ω–∞—Ö –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:
 * 0 = i (—Ç–æ–Ω–∏–∫–∞)
 * 5 = iv (—Å—É–±–¥–æ–º–∏–Ω–∞–Ω—Ç–∞)
 * 7 = v (–¥–æ–º–∏–Ω–∞–Ω—Ç–∞)
 */
const BLUES_PROGRESSION_OFFSETS = [0, 0, 0, 0, 5, 5, 0, 0, 7, 5, 0, 7];

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∫–æ—Ä–µ–Ω—å –∞–∫–∫–æ—Ä–¥–∞ –¥–ª—è –≤–µ–¥—É—â–µ–π –Ω–æ—Ç—ã –±–∞—Å–∞
 */
function getNextChordRoot(barIndex: number, rootNote: number): number {
  const nextBar = (barIndex + 1) % 12;
  return rootNote + BLUES_PROGRESSION_OFFSETS[nextBar];
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å –∏–º—è –∞–∫–∫–æ—Ä–¥–∞ –¥–ª—è —Ç–∞–∫—Ç–∞
 */
function getChordNameForBar(barIndex: number): string {
  const progression = ['i7', 'i7', 'i7', 'i7', 'iv7', 'iv7', 'i7', 'i7', 'v7', 'iv7', 'i7', 'v7'];
  return progression[barIndex % 12];
}

// ============================================================================
// –ö–õ–ê–°–° –ë–õ–Æ–ó–û–í–û–ì–û –ú–û–ó–ì–ê
// ============================================================================

export class BluesBrain {
  private config: BluesBrainConfig;
  private state: BluesCognitiveState;
  private random: any;
  
  // –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
  private lastAscendingBar: number = -10;
  private blueNotePending: boolean = false;
  private tensionLevel: number = 0.3;
  
  constructor(seed: number, mood: Mood) {
    this.random = this.createSeededRandom(seed);
    
    this.config = {
      ...DEFAULT_CONFIG,
      emotion: {
        melancholy: ['melancholic', 'dark', 'anxious'].includes(mood) ? 0.85 : 0.4,
        darkness: ['dark', 'gloomy'].includes(mood) ? 0.35 : 0.2
      }
    };
    
    this.state = {
      phraseState: 'call',
      tensionLevel: 0.3,
      phraseHistory: [],
      lastPhraseHash: '',
      blueNotePending: false,
      emotion: { ...this.config.emotion }
    };
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ì–ï–ù–ï–†–ê–¢–û–† –° –ü–û–°–ï–í–û–ú ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  private createSeededRandom(seed: number) {
    let state = seed;
    const next = () => {
      state = (state * 1664525 + 1013904223) % Math.pow(2, 32);
      return state / Math.pow(2, 32);
    };
    return {
      next,
      nextInt: (max: number) => Math.floor(next() * max),
      nextInRange: (min: number, max: number) => min + next() * (max - min)
    };
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ì–õ–ê–í–ù–´–ô –ú–ï–¢–û–î –ì–ï–ù–ï–†–ê–¶–ò–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  public generateBar(
    epoch: number,
    currentChord: GhostChord,
    navInfo: NavigationInfo,
    dna: any, // SuiteDNA (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏)
    hints: InstrumentHints
  ): FractalEvent[] {
    const events: FractalEvent[] = [];
    const barIn12 = epoch % 12;
    
    // –≠–≤–æ–ª—é—Ü–∏—è —ç–º–æ—Ü–∏–∏
    this.evolveEmotion(epoch);
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞–∑—ã —Ñ—Ä–∞–∑—ã (–∫–∞–∂–¥—ã–µ 4 —Ç–∞–∫—Ç–∞: –≤–æ–ø—Ä–æ—Å-–≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)
    this.updatePhrasePhase(barIn12);
    
    // 1. –£–î–ê–†–ù–´–ï ‚Äî –Ω–∞—Å—Ç–æ—è—â–∏–π —Å–≤–∏–Ω–≥ —Å –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏–µ–π
    if (hints.drums) {
      events.push(...this.generateDrums(epoch));
    }
    
    // 2. –ë–ê–° ‚Äî –≤–æ–ª–∫–∏–Ω–≥-–±–∞—Å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ª–µ—Ç—É –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
    if (hints.bass) {
      events.push(...this.generateWalkingBass(currentChord, epoch));
    }
    
    // 3. –ê–ö–ö–û–ú–ü–ê–ù–ï–ú–ï–ù–¢ ‚Äî —Ç—Ä—ç–≤–∏—Å-–ø–∏–∫–∏–Ω–≥ —Å –∞—Ä–ø–µ–¥–∂–∏–æ
    if (hints.accompaniment) {
      events.push(...this.generateTravisPicking(currentChord, epoch));
    }
    
    // 4. –ú–ï–õ–û–î–ò–Ø ‚Äî —è–∑—ã–∫ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π ‚ô≠5 ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    if (hints.melody) {
      const melodyEvents = this.generateBluesMelody(currentChord, epoch);
      // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ö–æ—Ä–æ–Ω–Ω–æ–≥–æ –º–∞—Ä—à–∞
      const guardedEvents = this.applyAntiFuneralMarch(melodyEvents, epoch);
      events.push(...guardedEvents);
    }
    
    return events;
  }
  
  // ============================================================================
  // 1. –£–î–ê–†–ù–´–ï ‚Äî –ù–ê–°–¢–û–Ø–©–ò–ô –°–í–ò–ù–ì
  // ============================================================================
  
  private generateDrums(epoch: number): FractalEvent[] {
    const events: FractalEvent[] = [];
    const beatDuration = 60 / this.config.tempo;
    
    // === –ö–ò–ö: 1 –∏ 3 –¥–æ–ª–∏ —Å –≤–∞—Ä–∏–∞—Ü–∏–µ–π ===
    [0, 2].forEach(beat => {
      const humanOffset = (this.random.next() * 20 - 10) / 1000; // ¬±10–º—Å
      events.push({
        type: 'drum_kick',
        note: 36, // C1
        time: beat * beatDuration + humanOffset,
        duration: beatDuration * 0.3,
        weight: 0.85 - beat * 0.05,
        technique: 'hit',
        dynamics: 'mf',
        phrasing: 'staccato'
      });
    });
    
    // === –°–ù–ï–ô–†: 2 –∏ 4 –¥–æ–ª–∏ —Å —Ç—Ä–∏–æ–ª—å–Ω—ã–º —Å–≤–∏–Ω–≥–æ–º ===
    const swingRatio = 0.66 + (this.random.next() - 0.5) * 0.08; // 0.62-0.70
    
    [1, 3].forEach(beat => {
      const baseTime = beat * beatDuration;
      const swungTime = baseTime * swingRatio + (1 - swingRatio) * beatDuration;
      
      const humanOffset = (this.random.next() * 25 - 12) / 1000; // ¬±12–º—Å
      events.push({
        type: 'drum_snare',
        note: 38, // D1
        time: swungTime + humanOffset,
        duration: beatDuration * 0.25,
        weight: 0.8,
        technique: 'hit',
        dynamics: 'mf',
        phrasing: 'staccato'
      });
    });
    
    // === –•–ê–ô-–•–≠–¢: –≤–æ—Å—å–º—ã–µ —Å —Ç—Ä–∏–æ–ª—å–Ω—ã–º —Å–≤–∏–Ω–≥–æ–º ===
    // –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ö–∞–π-—Ö—ç—Ç—ã (¬´—É—Å—Ç–∞–ª–æ—Å—Ç—å¬ª)
    for (let i = 0; i < 8; i++) {
      // –¢—Ä–∏–æ–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞: 2:1 —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ
      const isTripletFirst = i % 3 === 0;
      const baseTime = (i / 2) * beatDuration;
      const swungTime = isTripletFirst 
        ? baseTime * 0.66 
        : baseTime * 0.34 + beatDuration * 0.66;
      
      // –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–∏ –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏ > 0.8
      if (this.state.emotion.melancholy > 0.8 && i % 2 === 1 && this.random.next() < 0.4) {
        continue;
      }
      
      const humanOffset = (this.random.next() * 15 - 7) / 1000; // ¬±7–º—Å
      events.push({
        type: 'drum_hihat',
        note: 42, // F#1
        time: swungTime + humanOffset,
        duration: beatDuration * 0.15,
        weight: 0.35 + this.random.next() * 0.2,
        technique: 'hit',
        dynamics: 'p',
        phrasing: 'staccato'
      });
    }
    
    return events;
  }
  
  // ============================================================================
  // 2. –ë–ê–° ‚Äî –í–û–õ–ö–ò–ù–ì-–ë–ê–° –ù–ê –õ–ï–¢–£ (–ù–ï –ö–õ–ò–®–ï!)
  // ============================================================================
  
  private generateWalkingBass(chord: GhostChord, epoch: number): FractalEvent[] {
    const events: FractalEvent[] = [];
    const beatDuration = 60 / this.config.tempo;
    const root = chord.rootNote - 12; // –æ–∫—Ç–∞–≤–∞ –Ω–∏–∂–µ –¥–ª—è –±–∞—Å–∞
    const barIn12 = epoch % 12;
    
    // –°–ª–µ–¥—É—é—â–∏–π –∫–æ—Ä–µ–Ω—å –¥–ª—è –≤–µ–¥—É—â–µ–π –Ω–æ—Ç—ã
    const nextRoot = getNextChordRoot(barIn12, chord.rootNote) - 12;
    
    // === –ü–†–ê–í–ò–õ–ê –í–û–õ–ö–ò–ù–ì-–ë–ê–°–ê ===
    // 1-—è –¥–æ–ª—è: –∫–æ—Ä–µ–Ω—å –∞–∫–∫–æ—Ä–¥–∞
    // 2-—è –¥–æ–ª—è: –ø—Ä–æ—Ö–æ–¥—è—â–∞—è –Ω–æ—Ç–∞ (–¥–∏–∞—Ç–æ–Ω–∏—á–µ—Å–∫–∞—è –∏–ª–∏ —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)
    // 3-—è –¥–æ–ª—è: –∫–≤–∏–Ω—Ç–∞ –∏–ª–∏ —Å–µ–ø—Ç–∏–º–∞
    // 4-—è –¥–æ–ª—è: –≤–µ–¥—É—â–∞—è –Ω–æ—Ç–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∞–∫–∫–æ—Ä–¥—É (—Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)
    
    const fifth = root + 7;
    const seventh = root + 10;
    
    // –ü—Ä–æ—Ö–æ–¥—è—â–∞—è –Ω–æ—Ç–∞: 60% —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è (‚ô≠2), 40% –¥–∏–∞—Ç–æ–Ω–∏—á–µ—Å–∫–∞—è (2)
    const passingNote = this.random.next() < 0.6 
      ? root + 1  // —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è (–ø–æ–ª—É—Ç–æ–Ω –≤—ã—à–µ)
      : root + 2; // –¥–∏–∞—Ç–æ–Ω–∏—á–µ—Å–∫–∞—è (2-—è —Å—Ç—É–ø–µ–Ω—å)
    
    // –í–µ–¥—É—â–∞—è –Ω–æ—Ç–∞: —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∫–æ—Ä–Ω—é
    const leadingNote = nextRoot - 1; // –Ω–∞ –ø–æ–ª—Ç–æ–Ω–∞ –Ω–∏–∂–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ—Ä–Ω—è
    
    // === –ì–ï–ù–ï–†–ê–¶–ò–Ø 4 –î–û–õ–ï–ô ===
    const notes = [root, passingNote, fifth, leadingNote];
    const dynamics = ['mf', 'mp', 'mp', 'mp']; // –∞–∫—Ü–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ 1-–π –¥–æ–ª–µ
    
    notes.forEach((note, i) => {
      // –ú–∏–∫—Ä–æ–≥—É–º–∞–Ω–∏–∑–∞—Ü–∏—è: ¬±15–º—Å –Ω–∞ –∫–∞–∂–¥—É—é –¥–æ–ª—é
      const humanOffset = (this.random.next() * 30 - 15) / 1000;
      
      events.push({
        type: 'bass',
        note,
        time: i * beatDuration + humanOffset,
        duration: beatDuration * 0.92,
        weight: 0.9 - i * 0.1, // —É–±—ã–≤–∞—é—â–∏–π –≤–µ—Å
        technique: 'pluck',
        dynamics: dynamics[i],
        phrasing: 'legato',
        harmonicContext: getChordNameForBar(barIn12)
      });
    });
    
    return events;
  }
  
  // ============================================================================
  // 3. –ê–ö–ö–û–ú–ü–ê–ù–ï–ú–ï–ù–¢ ‚Äî –¢–†–≠–í–ò–°-–ü–ò–ö–ò–ù–ì
  // ============================================================================
  
  private generateTravisPicking(chord: GhostChord, epoch: number): FractalEvent[] {
    const events: FractalEvent[] = [];
    const beatDuration = 60 / this.config.tempo;
    const root = chord.rootNote;
    const isMinor = chord.chordType === 'minor';
    
    // –ù–æ—Ç—ã –∞–∫–∫–æ—Ä–¥–∞: —Ç–æ–Ω–∏–∫–∞, —Ç–µ—Ä—Ü–∏—è, –∫–≤–∏–Ω—Ç–∞, —Å–µ–ø—Ç–∏–º–∞
    const chordNotes = [
      root,                              // 1
      root + (isMinor ? 3 : 4),          // ‚ô≠3 –∏–ª–∏ 3
      root + 7,                          // 5
      root + 10                          // ‚ô≠7
    ];
    
    // –¢—Ä—ç–≤–∏—Å-–ø–∏–∫–∏–Ω–≥ –ø–∞—Ç—Ç–µ—Ä–Ω: –±–∞—Å –Ω–∞ —Å–∏–ª—å–Ω—ã—Ö –¥–æ–ª—è—Ö, –∞—Ä–ø–µ–¥–∂–∏–æ –Ω–∞ —Å–ª–∞–±—ã—Ö
    const pattern = epoch % 2 === 0 
      ? [0, 2, 1, 3, 0, 2, 1, 3]  // –≤–∞—Ä–∏–∞–Ω—Ç –ê
      : [0, 3, 1, 2, 0, 3, 1, 2]; // –≤–∞—Ä–∏–∞–Ω—Ç –ë
    
    pattern.forEach((noteIdx, i) => {
      const beat = Math.floor(i / 2);
      const subBeat = i % 2;
      
      // –ë–∞—Å–æ–≤–∞—è –Ω–æ—Ç–∞ –Ω–∞ —Å–∏–ª—å–Ω—ã—Ö –¥–æ–ª—è—Ö (1 –∏ 3)
      const isBassBeat = beat % 2 === 0 && subBeat === 0;
      const pitch = isBassBeat ? chordNotes[0] : chordNotes[noteIdx % chordNotes.length];
      
      // –í—Ä–µ–º—è —Å –ª—ë–≥–∫–∏–º —Å–≤–∏–Ω–≥–æ–º
      const time = beat * beatDuration + (subBeat * beatDuration * 0.5);
      
      // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –±–∞—Å–æ–≤—ã–µ –Ω–æ—Ç—ã –¥–æ–ª—å—à–µ
      const duration = isBassBeat ? beatDuration * 0.7 : beatDuration * 0.4;
      
      events.push({
        type: 'accompaniment',
        note: pitch + 12, // +1 –æ–∫—Ç–∞–≤–∞
        time: time + (this.random.next() * 0.015), // –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏—è
        duration,
        weight: isBassBeat ? 0.4 : 0.25,
        technique: 'pluck',
        dynamics: 'p',
        phrasing: 'detached',
        harmonicContext: getChordNameForBar(epoch % 12)
      });
    });
    
    return events;
  }
  
  // ============================================================================
  // 4. –ú–ï–õ–û–î–ò–Ø ‚Äî –Ø–ó–´–ö –ù–ê–ü–†–Ø–ñ–ï–ù–ò–ô ‚ô≠5 ‚Üí –†–ê–ó–†–ï–®–ï–ù–ò–ï
  // ============================================================================
  
  private generateBluesMelody(chord: GhostChord, epoch: number): FractalEvent[] {
    const events: FractalEvent[] = [];
    const beatDuration = 60 / this.config.tempo;
    const root = chord.rootNote;
    const barIn12 = epoch % 12;
    
    // === –§–ê–ó–ê –§–†–ê–ó–´ ===
    // –¢–∞–∫—Ç—ã 0-3: –≤–æ–ø—Ä–æ—Å (–Ω–∏—Å—Ö–æ–¥—è—â–∏–π, —Å ‚ô≠5)
    // –¢–∞–∫—Ç—ã 4-7: –≤–æ–ø—Ä–æ—Å (–≤–∞—Ä–∏–∞—Ü–∏—è)
    // –¢–∞–∫—Ç—ã 8-11: –æ—Ç–≤–µ—Ç (–≤–æ—Å—Ö–æ–¥—è—â–∏–π, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
    
    const phrasePhase = barIn12 < 4 ? 'call' : (barIn12 < 8 ? 'call_var' : 'response');
    
    if (phrasePhase === 'call') {
      // === –í–û–ü–†–û–°: –Ω–∏—Å—Ö–æ–¥—è—â–∞—è —Ñ—Ä–∞–∑–∞ —Å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ–º (‚ô≠5) ===
      events.push(...this.generateCallPhrase(root, beatDuration, epoch));
    } 
    else if (phrasePhase === 'call_var') {
      // === –í–û–ü–†–û–° (–≤–∞—Ä–∏–∞—Ü–∏—è): –ø–æ–≤—Ç–æ—Ä —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º ===
      events.push(...this.generateCallVariation(root, beatDuration, epoch));
    } 
    else {
      // === –û–¢–í–ï–¢: –≤–æ—Å—Ö–æ–¥—è—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ ===
      events.push(...this.generateResponsePhrase(root, beatDuration, epoch));
    }
    
    // === –ú–ò–ö–†–û–ê–†–¢–ò–ö–£–õ–Ø–¶–ò–Ø ===
    this.applyMicroArticulation(events, beatDuration);
    
    return events;
  }
  
  private generateCallPhrase(root: number, beatDuration: number, epoch: number): FractalEvent[] {
    const events: FractalEvent[] = [];
    
    // –ù–∏—Å—Ö–æ–¥—è—â–∞—è —Ñ—Ä–∞–∑–∞: 7 ‚Üí 5 ‚Üí ‚ô≠5 ‚Üí 3 (–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ!)
    const phraseNotes = [
      { degree: 10, time: 0.0 },      // ‚ô≠7 (–Ω–∞—á–∞–ª–æ —Ñ—Ä–∞–∑—ã)
      { degree: 7, time: 0.5 },       // 5
      { degree: 6, time: 1.0 },       // ‚ô≠5 (–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ!)
      { degree: 3, time: 1.5 }        // ‚ô≠3
    ];
    
    phraseNotes.forEach((noteInfo, i) => {
      const pitch = root + noteInfo.degree + 24; // +2 –æ–∫—Ç–∞–≤—ã –¥–ª—è —Å–æ–ª–æ
      
      // –ë–µ–Ω–¥ –Ω–∞ ‚ô≠5 (–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ!)
      const technique = noteInfo.degree === 6 && this.random.next() < 0.75 
        ? 'bend' 
        : 'pick';
      
      // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –ø–æ—Å–ª–µ–¥–Ω—è—è –Ω–æ—Ç–∞ –¥–ª–∏–Ω–Ω–µ–µ (–≤–æ–ø—Ä–æ—Å –±–µ–∑ –æ—Ç–≤–µ—Ç–∞)
      const duration = i === phraseNotes.length - 1 
        ? beatDuration * 1.8 
        : beatDuration * 0.7;
      
      events.push({
        type: 'melody',
        note: pitch,
        time: noteInfo.time * beatDuration,
        duration,
        weight: 0.85 - i * 0.1,
        technique,
        dynamics: 'mp',
        phrasing: 'legato',
        harmonicContext: 'i7'
      });
    });
    
    // === –ó–ê–ü–û–ú–ò–ù–ê–ï–ú –ù–ê–ü–†–Ø–ñ–ï–ù–ò–ï ===
    this.tensionLevel = Math.min(1.0, this.tensionLevel + 0.35);
    this.blueNotePending = true;
    
    // === –°–¢–†–ê–¢–ï–ì–ò–ß–ï–°–ö–ê–Ø –ü–ê–£–ó–ê ===
    // –ü–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞ ‚Äî –ø–∞—É–∑–∞ (¬´–Ω–µ–∑–∞–∫–æ–Ω—á–µ–Ω–Ω–æ—Å—Ç—å¬ª)
    events.push({
      type: 'rest',
      time: 2.0 * beatDuration,
      duration: beatDuration * 1.2,
      weight: 0.95,
      phrasing: 'breath'
    });
    
    return events;
  }
  
  private generateCallVariation(root: number, beatDuration: number, epoch: number): FractalEvent[] {
    const events: FractalEvent[] = [];
    
    // –í–∞—Ä–∏–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–∞: –Ω–∞—á–∏–Ω–∞–µ–º —Å ‚ô≠3, –∏–¥—ë–º –∫ ‚ô≠5
    const phraseNotes = [
      { degree: 3, time: 0.0 },       // ‚ô≠3
      { degree: 5, time: 0.6 },       // 4
      { degree: 6, time: 1.2 },       // ‚ô≠5 (–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ!)
      { degree: 5, time: 1.8 }        // 4 (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
    ];
    
    phraseNotes.forEach((noteInfo, i) => {
      const pitch = root + noteInfo.degree + 24;
      
      const technique = noteInfo.degree === 6 && this.random.next() < 0.7
        ? 'bend'
        : 'pick';
      
      events.push({
        type: 'melody',
        note: pitch,
        time: noteInfo.time * beatDuration,
        duration: beatDuration * 0.65,
        weight: 0.8 + i * 0.03,
        technique,
        dynamics: 'mp',
        phrasing: 'legato',
        harmonicContext: 'i7'
      });
    });
    
    this.tensionLevel = Math.min(1.0, this.tensionLevel + 0.2);
    this.blueNotePending = true;
    
    return events;
  }
  
  private generateResponsePhrase(root: number, beatDuration: number, epoch: number): FractalEvent[] {
    const events: FractalEvent[] = [];
    
    // === –û–¢–í–ï–¢: –≤–æ—Å—Ö–æ–¥—è—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ ===
    // –ï—Å–ª–∏ –±—ã–ª–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ (‚ô≠5) ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤ 5 –∏–ª–∏ 3
    // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–ø–æ–∫–æ–π–Ω—ã–π –æ—Ç–≤–µ—Ç
    
    let phraseNotes: { degree: number; time: number }[];
    
    if (this.blueNotePending) {
      // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è: 3 ‚Üí 5 ‚Üí 7
      phraseNotes = [
        { degree: 3, time: 0.0 },      // ‚ô≠3
        { degree: 5, time: 0.7 },      // 4
        { degree: 7, time: 1.4 }       // 5 (—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ!)
      ];
    } else {
      // –°–ø–æ–∫–æ–π–Ω—ã–π –æ—Ç–≤–µ—Ç: 1 ‚Üí 3 ‚Üí 5
      phraseNotes = [
        { degree: 0, time: 0.0 },      // 1 (—Ç–æ–Ω–∏–∫–∞)
        { degree: 3, time: 0.8 },      // ‚ô≠3
        { degree: 7, time: 1.6 }       // 5
      ];
    }
    
    phraseNotes.forEach((noteInfo, i) => {
      const pitch = root + noteInfo.degree + 24;
      
      // –í–∏–±—Ä–∞—Ç–æ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –Ω–æ—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
      const technique = i === phraseNotes.length - 1 && this.random.next() < 0.8
        ? 'vibrato'
        : 'pick';
      
      events.push({
        type: 'melody',
        note: pitch,
        time: noteInfo.time * beatDuration,
        duration: beatDuration * 0.85,
        weight: 0.8 + i * 0.05, // –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏–µ –≤–µ—Å–∞
        technique,
        dynamics: 'mf',
        phrasing: 'portamento',
        harmonicContext: 'i7'
      });
    });
    
    // === –°–ë–†–û–° –ù–ê–ü–†–Ø–ñ–ï–ù–ò–Ø ===
    this.tensionLevel = Math.max(0.1, this.tensionLevel - 0.4);
    this.blueNotePending = false;
    
    return events;
  }
  
  // ============================================================================
  // –ú–ò–ö–†–û–ê–†–¢–ò–ö–£–õ–Ø–¶–ò–Ø
  // ============================================================================
  
  private applyMicroArticulation(events: FractalEvent[], beatDuration: number): void {
    // –°–≤–∏–Ω–≥: —Ç—Ä–∏–æ–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ 2:1 —Å –≤–∞—Ä–∏–∞—Ü–∏–µ–π
    const swingRatio = 0.66 + (this.random.next() - 0.5) * 0.08;
    
    events.forEach((event, i) => {
      if (event.type !== 'rest') {
        // –°–≤–∏–Ω–≥ –Ω–∞ —á—ë—Ç–Ω—ã—Ö –¥–æ–ª—è—Ö
        if (i % 2 === 1) {
          const idealTime = event.time;
          event.time = idealTime * swingRatio + (1 - swingRatio) * beatDuration;
        }
        
        // –ì—É–º–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–∏–Ω–≥–∞: ¬±25–º—Å —Å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–µ–π –∫ –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ñ—Ä–∞–∑–µ
        const maxOffsetMs = 20 + this.state.emotion.melancholy * 15;
        const offsetMs = (this.random.next() * maxOffsetMs * 2 - maxOffsetMs) / 1000;
        event.time += offsetMs;
        
        // –ú–æ–¥—É–ª—è—Ü–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–ª—è ¬´–¥—ã—Ö–∞–Ω–∏—è¬ª
        if (event.technique === 'vibrato' || event.technique === 'bend') {
          event.weight *= 0.95 + this.random.next() * 0.1;
        }
      }
    });
  }
  
  // ============================================================================
  // –ó–ê–©–ò–¢–ê –û–¢ –ê–†–¢–ï–§–ê–ö–¢–û–í
  // ============================================================================
  
  private applyAntiFuneralMarch(events: FractalEvent[], epoch: number): FractalEvent[] {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ö–æ—Ä–æ–Ω–Ω–æ–≥–æ –º–∞—Ä—à–∞: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 6 —Ç–∞–∫—Ç–æ–≤
    
    if (epoch - this.lastAscendingBar >= 6 && this.tensionLevel > 0.5) {
      const melodyEvents = events.filter(e => e.type === 'melody');
      if (melodyEvents.length > 0) {
        const lastMelodyEvent = melodyEvents[melodyEvents.length - 1];
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Ö–æ–¥—è—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (–∫–≤–∏–Ω—Ç–∞ –≤–≤–µ—Ä—Ö)
        const resolutionNote: FractalEvent = {
          type: 'melody',
          note: lastMelodyEvent.note! + 5, // –∫–≤–∏–Ω—Ç–∞ –≤–≤–µ—Ä—Ö ‚Äî –º—É–∑—ã–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
          time: lastMelodyEvent.time + lastMelodyEvent.duration + 0.3,
          duration: 1.2,
          weight: 0.92,
          technique: 'vibrato',
          dynamics: 'mf',
          phrasing: 'sostenuto',
          harmonicContext: 'i7'
        };
        
        events.push(resolutionNote);
        this.lastAscendingBar = epoch;
        this.tensionLevel = 0.2;
      }
    }
    
    return events;
  }
  
  // ============================================================================
  // –≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –≠–í–û–õ–Æ–¶–ò–Ø
  // ============================================================================
  
  private evolveEmotion(epoch: number): void {
    // –ë—Ä–æ—É–Ω–æ–≤—Å–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
    this.state.emotion.melancholy += (this.random.next() - 0.5) * 0.06;
    this.state.emotion.darkness += (this.random.next() - 0.5) * 0.04;
    
    // –ö–ª–∏–ø–ø–∏–Ω–≥
    this.state.emotion.melancholy = Math.max(0.65, Math.min(0.95, this.state.emotion.melancholy));
    this.state.emotion.darkness = Math.max(0.15, Math.min(0.45, this.state.emotion.darkness));
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    this.state.tensionLevel = this.tensionLevel;
  }
  
  private updatePhrasePhase(barIn12: number): void {
    if (barIn12 < 4) {
      this.state.phraseState = 'call';
    } else if (barIn12 < 8) {
      this.state.phraseState = 'call_var';
    } else {
      this.state.phraseState = 'response';
    }
  }
  
  // ============================================================================
  // –ì–ï–¢–¢–ï–†–´ –î–õ–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–ò
  // ============================================================================
  
  getEmotionState(): { melancholy: number; darkness: number } {
    return { ...this.state.emotion };
  }
  
  getTensionLevel(): number {
    return this.tensionLevel;
  }
  
  resetState(): void {
    this.state = {
      phraseState: 'call',
      tensionLevel: 0.3,
      phraseHistory: [],
      lastPhraseHash: '',
      blueNotePending: false,
      emotion: { ...this.config.emotion }
    };
    this.lastAscendingBar = -10;
    this.blueNotePending = false;
    this.tensionLevel = 0.3;
  }
}

–ö–õ–Æ–ß–ï–í–´–ï –û–¢–õ–ò–ß–ò–Ø –û–¢ –°–¢–ê–†–û–ì–û –ö–û–î–ê
–ß—Ç–æ –±—ã–ª–æ
–ß—Ç–æ —Å—Ç–∞–ª–æ
–ó–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –±–∞—Å-—Ä–∏—Ñ—Ñ—ã –∏–∑ BLUES_BASS_RIFFS
–í–æ–ª–∫–∏–Ω–≥-–±–∞—Å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ª–µ—Ç—É –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –ø—Ä–æ—Ö–æ–¥—è—â–∏—Ö/–≤–µ–¥—É—â–∏—Ö –Ω–æ—Ç
–ü–µ—Ä–µ–±–æ—Ä –ª–∏–∫–æ–≤ –∏–∑ BLUES_SOLO_LICKS
–ú–µ–ª–æ–¥–∏—è —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ —è–∑—ã–∫–µ ‚ô≠5 ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (5/3)
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ê–ê–í –±–µ–∑ –º—É–∑—ã–∫–∞–ª—å–Ω–æ–≥–æ —Å–º—ã—Å–ª–∞
–í–æ–ø—Ä–æ—Å (–Ω–∏—Å—Ö–æ–¥—è—â–∏–π + ‚ô≠5) ‚Üí –ø–∞—É–∑–∞ ‚Üí –æ—Ç–≤–µ—Ç (–≤–æ—Å—Ö–æ–¥—è—â–∏–π + —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
–ñ—ë—Å—Ç–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–∫—Ç–∞–≤ (48-71)
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–º —á–µ—Ä–µ–∑ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –¥—Ä–∞–º-—Ä–∏—Ñ—Ñ—ã
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —Ç—Ä–∏–æ–ª—å–Ω—ã–º —Å–≤–∏–Ω–≥–æ–º –∏ –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏–µ–π ¬±25–º—Å
–ü—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç
–¢—Ä—ç–≤–∏—Å-–ø–∏–∫–∏–Ω–≥ —Å –∞—Ä–ø–µ–¥–∂–∏–æ –∏ –¥–∏–Ω–∞–º–∏–∫–æ–π
–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ—Å—Ç—ã–ª–∏ –ø—Ä–æ—Ç–∏–≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)

–ö–ê–ö –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–¢–¨ –í –í–ê–® –ü–†–û–ï–ö–¢
# 1. –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª
mv blues-brain.ts blues-brain.ts.backup
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥ –≤ blues-brain.ts

# 2. –£–¥–∞–ª–∏—Ç–µ –Ω–µ–Ω—É–∂–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞:
# ‚ùå BLUES_BASS_RIFFS
# ‚ùå BLUES_SOLO_LICKS
# ‚ùå BLUES_SOLO_PLANS
# ‚ùå BLUES_DRUM_RIFFS
# ‚ùå BLUES_MELODY_RIFFS

# 3. –û–±–Ω–æ–≤–∏—Ç–µ —Ç–∏–ø—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
# –î–æ–±–∞–≤—å—Ç–µ –≤ '@/types/music':
#   type Technique = 'pick' | 'bend' | 'vibrato' | 'slide' | 'pluck' | 'hit';
#   type Dynamics = 'pp' | 'p' | 'mp' | 'mf' | 'f' | 'ff';


–í–æ—Ç –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–ª—é–∑–æ–≤–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å –≤–∞—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:
üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
12345678910
src/
‚îú‚îÄ‚îÄ generators/
‚îÇ   ‚îú‚îÄ‚îÄ blues/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blues-cognitive-architecture.ts  ‚Üê –û—Å–Ω–æ–≤–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blues-rules.json                 ‚Üê –ì–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blues-patterns.json              ‚Üê –§—Ä–∞–∑–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ blues-anti-monotony.ts           ‚Üê –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ blues.test.ts                        ‚Üê –¢–µ—Å—Ç—ã
‚îî‚îÄ‚îÄ demos/
    ‚îî‚îÄ‚îÄ blues-demo.ts                        ‚Üê –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
üß† blues-cognitive-architecture.ts
typescript
import { buildMultiInstrument, InstrumentAPI } from '../instrument-factory';
import { V2_PRESETS } from '../presets-v2';
import { BLUES_RULES } from './blues-rules.json';
import { BLUES_PATTERNS } from './blues-patterns.json';
import { AntiMonotonyGuard } from './blues-anti-monotony';

/**
 * #–ó–ê–ß–ï–ú: –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–ª—é–∑–æ–≤–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–µ–π.
 * #–ß–¢–û: –¢—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (–≥–∞—Ä–º–æ–Ω–∏—è ‚Üí —Ñ—Ä–∞–∑—ã ‚Üí –º–∏–∫—Ä–æ–∞—Ä—Ç–∏–∫—É–ª—è—Ü–∏—è) —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤.
 * #–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å –≤–∞—à–∏–º–∏ –ø—Ä–µ—Å–µ—Ç–∞–º–∏ guitar_shineOn / guitar_muffLead.
 */
export interface BluesCognitiveState {
  // –£—Ä–æ–≤–µ–Ω—å 1: –ì–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (12-bar blues)
  harmonicPhase: 'I' | 'IV' | 'V' | 'turnaround';
  barIndex: number; // 0..11
  quickChange: boolean; // IV –Ω–∞ 2-–º —Ç–∞–∫—Ç–µ?
  
  // –£—Ä–æ–≤–µ–Ω—å 2: –§—Ä–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (call-response-fill)
  phraseState: 'call' | 'response' | 'fill';
  phraseLengthBars: number; // 2, 3 –∏–ª–∏ 4 —Ç–∞–∫—Ç–∞
  tensionLevel: number; // 0.0..1.0 ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ
  
  // –£—Ä–æ–≤–µ–Ω—å 3: –ú–∏–∫—Ä–æ–∞—Ä—Ç–∏–∫—É–ª—è—Ü–∏—è
  blueNotePending: boolean; // –æ–∂–∏–¥–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è ‚ô≠5
  lastPhraseHash: string;
  phraseHistory: string[];
  
  // –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  emotion: {
    melancholy: number; // 0.0..1.0
    darkness: number;   // 0.0..1.0
  };
}

export interface BluesConfig {
  tempo: number; // BPM
  key: number; // MIDI root (e.g., 60 = C4)
  emotion?: {
    melancholy?: number;
    darkness?: number;
  };
  guitarPreset?: 'shineOn' | 'muffLead';
  bassPreset?: string;
  barsToGenerate?: number;
}

export interface NoteEvent {
  pitch: number; // MIDI note
  time: number; // seconds from start
  duration: number; // seconds
  velocity: number; // 0.0..1.0
  slide?: {
    startPitch: number;
    targetPitch: number;
    duration: number;
  };
  chordContext?: string; // 'I7', 'IV7', etc.
}

export interface ChordEvent {
  chord: string; // 'I7', 'IV7', 'V7'
  time: number;
  duration: number;
  extensions?: number[]; // MIDI offsets for ‚ô≠5, ‚ô≠9, etc.
}

export class BluesCognitiveGenerator {
  private state: BluesCognitiveState;
  private config: BluesConfig;
  private guitar: InstrumentAPI | null = null;
  private bass: InstrumentAPI | null = null;
  private antiMonotony: AntiMonotonyGuard;
  
  private outputEvents: {
    notes: NoteEvent[];
    chords: ChordEvent[];
  } = { notes: [], chords: [] };
  
  constructor(config: BluesConfig) {
    this.config = {
      tempo: config.tempo,
      key: config.key,
      emotion: {
        melancholy: config.emotion?.melancholy ?? 0.6,
        darkness: config.emotion?.darkness ?? 0.2
      },
      guitarPreset: config.guitarPreset ?? 'shineOn',
      bassPreset: config.bassPreset ?? 'bass_jazz_warm',
      barsToGenerate: config.barsToGenerate ?? 12
    };
    
    this.state = {
      harmonicPhase: 'I',
      barIndex: 0,
      quickChange: false,
      phraseState: 'call',
      phraseLengthBars: 2,
      tensionLevel: 0.3,
      blueNotePending: false,
      lastPhraseHash: '',
      phraseHistory: [],
      emotion: { ...this.config.emotion }
    };
    
    this.antiMonotony = new AntiMonotonyGuard();
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –£–†–û–í–ï–ù–¨ 1: –ì–ê–†–ú–û–ù–ò–Ø (12-bar blues progression) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  private getBaseProgression(): string[] {
    return [...BLUES_RULES.base_progression]; // ['I7', 'I7', 'I7', 'I7', 'IV7', ...]
  }
  
  private applyEmotionalVariants(progression: string[]): string[] {
    const emotion = this.state.emotion;
    
    // Quick change (IV –Ω–∞ 2-–º —Ç–∞–∫—Ç–µ) ‚Äî –¥–ª—è –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏
    if (emotion.melancholy > 0.5 && Math.random() < BLUES_RULES.emotional_variants.melancholy.quick_change_prob) {
      progression[1] = 'IV7';
      this.state.quickChange = true;
    }
    
    // Turnaround variants
    if (this.state.barIndex === 8) {
      const variants = emotion.darkness > 0.6 
        ? BLUES_RULES.emotional_variants.dark.turnaround_variants
        : BLUES_RULES.emotional_variants.melancholy.turnaround_variants;
      
      const weights = variants.map(v => v.weight);
      const selected = this.weightedRandom(variants, weights);
      progression[8] = selected.chords[0];
      progression[9] = selected.chords[1];
      progression[10] = selected.chords[2];
      progression[11] = selected.chords[3];
    }
    
    return progression;
  }
  
  private getChordExtensions(chord: string): number[] {
    const emotion = this.state.emotion;
    const extensions: number[] = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º ‚ô≠5 –≤ –±–∞—Å –ø—Ä–∏ –º—Ä–∞—á–Ω–æ—Å—Ç–∏
    if (emotion.darkness > 0.5 && Math.random() < BLUES_RULES.emotional_variants.dark.blue_extension['‚ô≠5_in_bass']) {
      extensions.push(-6); // ‚ô≠5 relative to root
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º ‚ô≠9 –≤ –∞–∫–∫–æ—Ä–¥
    if (emotion.darkness > 0.6 && Math.random() < BLUES_RULES.emotional_variants.dark.blue_extension['‚ô≠9_in_chord']) {
      extensions.push(1); // ‚ô≠9 = +1 semitone from root
    }
    
    return extensions;
  }
  
  generateHarmonicBlock(startBar: number, numBars: number): ChordEvent[] {
    const progression = this.getBaseProgression();
    const modified = this.applyEmotionalVariants(progression);
    
    const chordEvents: ChordEvent[] = [];
    const barDuration = 60 / this.config.tempo; // seconds per bar
    
    for (let i = 0; i < numBars; i++) {
      const barIdx = (startBar + i) % 12;
      const chordName = modified[barIdx];
      
      chordEvents.push({
        chord: chordName,
        time: startBar * barDuration + i * barDuration,
        duration: barDuration,
        extensions: this.getChordExtensions(chordName)
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≥–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫—É—é —Ñ–∞–∑—É
      this.updateHarmonicPhase(barIdx);
    }
    
    return chordEvents;
  }
  
  private updateHarmonicPhase(barIdx: number): void {
    if (barIdx < 4) this.state.harmonicPhase = 'I';
    else if (barIdx < 6) this.state.harmonicPhase = 'IV';
    else if (barIdx < 8) this.state.harmonicPhase = 'I';
    else if (barIdx < 10) this.state.harmonicPhase = 'V';
    else if (barIdx < 11) this.state.harmonicPhase = 'IV';
    else this.state.harmonicPhase = 'turnaround';
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –£–†–û–í–ï–ù–¨ 2: –§–†–ê–ó–´ (call-response-fill) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  private selectPhraseTemplate(phraseType: 'call' | 'response' | 'fill'): any {
    const templates = BLUES_PATTERNS.phrase_templates[phraseType];
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ñ—Ä–∞–∑—ã
    const filtered = templates.filter(t => {
      const hash = t.pattern.join(',');
      return !this.state.phraseHistory.includes(hash);
    });
    
    if (filtered.length === 0) return templates[0]; // fallback
    
    const weights = filtered.map(t => t.weight);
    return this.weightedRandom(filtered, weights);
  }
  
  private mapToScaleDegree(degree: string | number, chord: string): number {
    const root = this.config.key;
    const isMinor = chord.includes('m') || chord.includes('‚ô≠');
    
    // –ü–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞: [0, 3, 5, 7, 10] = [1, ‚ô≠3, 4, 5, ‚ô≠7]
    const pentatonic = [0, 3, 5, 7, 10];
    
    if (typeof degree === 'number') {
      return root + pentatonic[degree % pentatonic.length];
    }
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–µ–ø–µ–Ω–∏
    switch (degree) {
      case '‚ô≠5': return root + 6; // blue note
      case '‚ô≠3': return root + 3;
      case '‚ô≠7': return root + 10;
      default: return root + 0;
    }
  }
  
  private resolveBlueNote(): number {
    const root = this.config.key;
    // 70% ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö –Ω–∞ +1 (‚ô≠5 ‚Üí 5), 30% ‚Üí –≤–Ω–∏–∑ –Ω–∞ -2 (‚ô≠5 ‚Üí 3)
    return Math.random() < 0.7 ? root + 7 : root + 3;
  }
  
  generatePhrase(phraseType: 'call' | 'response' | 'fill', chord: string, startTime: number): NoteEvent[] {
    const template = this.selectPhraseTemplate(phraseType);
    const barDuration = 60 / this.config.tempo;
    const phraseDuration = this.state.phraseLengthBars * barDuration;
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ—Ç—ã –∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
    const notes: NoteEvent[] = [];
    const timeStep = phraseDuration / template.pattern.length;
    
    template.pattern.forEach((degree: string | number, i: number) => {
      let pitch = this.mapToScaleDegree(degree, chord);
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ ‚ô≠5 –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
      if (degree === '‚ô≠5') {
        if (this.state.blueNotePending) {
          pitch = this.resolveBlueNote();
          this.state.blueNotePending = false;
        } else {
          this.state.blueNotePending = true;
        }
      }
      
      // –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
      if (degree === '‚ô≠5' || degree === '‚ô≠3') {
        this.state.tensionLevel = Math.min(1.0, this.state.tensionLevel + 0.15);
      }
      
      notes.push({
        pitch,
        time: startTime + i * timeStep,
        duration: timeStep * 0.8,
        velocity: 0.6 + Math.random() * 0.2,
        chordContext: chord
      });
    });
    
    // –•–µ—à–∏—Ä—É–µ–º —Ñ—Ä–∞–∑—É –¥–ª—è –∞–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
    const phraseHash = template.pattern.join(',');
    this.state.phraseHistory.push(phraseHash);
    if (this.state.phraseHistory.length > 8) this.state.phraseHistory.shift();
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω
    return this.applyRhythmPattern(notes, template.rhythm);
  }
  
  private applyRhythmPattern(notes: NoteEvent[], rhythmType: string): NoteEvent[] {
    const barDuration = 60 / this.config.tempo;
    
    switch (rhythmType) {
      case 'dotted8-16-8':
        // –¢—Ä–∏–æ–ª—å–Ω—ã–π —à–∞—Ñ—Ñ–ª: —Ç–æ—á–∫–∞-–≤–æ—Å—å–º–∞—è, —à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–∞—è, –≤–æ—Å—å–º–∞—è
        return notes.map((note, i) => {
          const baseTime = note.time;
          const offsets = [0, barDuration / 6, barDuration / 3];
          return {
            ...note,
            time: baseTime + offsets[i % 3],
            duration: (i % 3 === 0) ? barDuration / 3 : barDuration / 6
          };
        });
      
      case '8-8-8-8':
        // –†–æ–≤–Ω—ã–µ –≤–æ—Å—å–º—ã–µ —Å –ª—ë–≥–∫–∏–º —Å–≤–∏–Ω–≥–æ–º
        return notes.map(note => ({
          ...note,
          duration: barDuration / 4 * 0.9
        }));
      
      case 'quarter-quarter-quarter':
        // –î–æ–ª–≥–∏–µ —á–µ—Ç–≤–µ—Ä—Ç–Ω—ã–µ –Ω–æ—Ç—ã
        return notes.map((note, i) => ({
          ...note,
          duration: barDuration * 0.95
        }));
      
      case '16-16-16-16-16':
        // –®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—ã–µ –¥–ª—è —Ñ–∏–ª–ª–æ–≤
        return notes.map((note, i) => ({
          ...note,
          duration: barDuration / 8 * 0.85
        }));
      
      default:
        return notes;
    }
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –£–†–û–í–ï–ù–¨ 3: –ú–ò–ö–†–û–ê–†–¢–ò–ö–£–õ–Ø–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  applyMicroTiming(note: NoteEvent): NoteEvent {
    const barDuration = 60 / this.config.tempo;
    const emotion = this.state.emotion;
    
    // –¢—Ä–∏–æ–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞: 1 —Ç–∞–∫—Ç = 3 —Ç—Ä–∏–æ–ª–∏
    const idealTripletPosition = Math.floor(note.time / (barDuration / 3)) * (barDuration / 3);
    const offsetFromIdeal = note.time - idealTripletPosition;
    
    // –ì—É–º–∞–Ω–∏–∑–∞—Ü–∏—è: ¬±15‚Äì40 –º—Å —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 0.7
    if (Math.random() < 0.7) {
      const maxOffsetMs = 25 + emotion.melancholy * 15;
      const offsetMs = (Math.random() * maxOffsetMs * 2 - maxOffsetMs) / 1000;
      note.time += offsetMs;
    }
    
    // –°–ª–∞–π–¥—ã –¥–ª—è –±–ª—é–∑–æ–≤–æ–π —ç–∫—Å–ø—Ä–µ—Å—Å–∏–∏ (–∫–∞–∂–¥–∞—è 3-—è –Ω–æ—Ç–∞ –≤ —Ñ—Ä–∞–∑–µ)
    if (Math.random() < 0.33 && note.duration > barDuration / 4) {
      note.slide = {
        startPitch: note.pitch - 1, // bend –≤–≤–µ—Ä—Ö –Ω–∞ –ø–æ–ª—Ç–æ–Ω–∞
        targetPitch: note.pitch,
        duration: 0.12
      };
    }
    
    // –í–∏–±—Ä–∞—Ç–æ –Ω–∞ –¥–æ–ª–≥–∏—Ö –Ω–æ—Ç–∞—Ö
    if (note.duration > barDuration * 0.75 && Math.random() < 0.5) {
      note.velocity *= 0.9 + Math.random() * 0.2; // –ª—ë–≥–∫–∞—è –º–æ–¥—É–ª—è—Ü–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    }
    
    return note;
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –≠–í–û–õ–Æ–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  evolveEmotion(deltaBars: number): void {
    // –ë—Ä–æ—É–Ω–æ–≤—Å–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π
    this.state.emotion.melancholy += (Math.random() - 0.5) * 0.08 * deltaBars;
    this.state.emotion.darkness += (Math.random() - 0.5) * 0.05 * deltaBars;
    
    // –ö–ª–∏–ø–ø–∏–Ω–≥
    this.state.emotion.melancholy = Math.max(0, Math.min(1, this.state.emotion.melancholy));
    this.state.emotion.darkness = Math.max(0, Math.min(1, this.state.emotion.darkness));
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Å–∏–Ω—Ç–µ–∑–∞
    this.updateGuitarParams();
  }
  
  private updateGuitarParams(): void {
    if (!this.guitar) return;
    
    const emotion = this.state.emotion;
    
    // –í—ã–±–æ—Ä –ø—Ä–µ—Å–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç–º–æ—Ü–∏–∏
    const presetName = emotion.darkness > 0.6 ? 'guitar_muffLead' : 'guitar_shineOn';
    const preset = V2_PRESETS[presetName as keyof typeof V2_PRESETS];
    
    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    let cutoff = 3600 - emotion.darkness * 800;
    let driveAmount = 0.2 + emotion.darkness * 0.45;
    let driveType = emotion.darkness > 0.6 ? 'muff' : 'soft';
    let reverbMix = 0.18 + emotion.melancholy * 0.17;
    let expression = 0.7 + emotion.melancholy * 0.3;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    this.guitar.setPreset({
      ...preset,
      pickup: { ...preset.pickup, cutoff },
      drive: { ...preset.drive, amount: driveAmount, type: driveType },
      reverbMix,
      adsr: {
        ...preset.adsr,
        r: 1.6 + emotion.melancholy * 0.9 // –¥–ª–∏–Ω–Ω–µ–µ —Ä–µ–ª–∏–∑ –ø—Ä–∏ –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏
      }
    });
    
    this.guitar.setExpression(expression);
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ì–õ–ê–í–ù–´–ô –ì–ï–ù–ï–†–ê–¢–û–† ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  async generate(ctx: AudioContext, numBars: number = 12): Promise<{
    notes: NoteEvent[];
    chords: ChordEvent[];
  }> {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    this.guitar = await buildMultiInstrument(ctx, {
      type: 'guitar',
      preset: V2_PRESETS[this.config.guitarPreset === 'muffLead' ? 'guitar_muffLead' : 'guitar_shineOn']
    });
    
    // this.bass = await buildMultiInstrument(ctx, {
    //   type: 'bass',
    //   preset: BASS_PRESETS[this.config.bassPreset as keyof typeof BASS_PRESETS]
    // });
    
    const barDuration = 60 / this.config.tempo;
    this.outputEvents = { notes: [], chords: [] };
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ —Ç–∞–∫—Ç–∞–º
    for (let bar = 0; bar < numBars; bar++) {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ—Ä–∞–∑—ã (–∫–∞–∂–¥—ã–µ 4 —Ç–∞–∫—Ç–∞: call ‚Üí response ‚Üí fill)
      const phraseType = bar % 4 === 0 ? 'call' : bar % 4 === 2 ? 'response' : 'fill';
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–∞—Ä–º–æ–Ω–∏—é –¥–ª—è —Ç–∞–∫—Ç–∞
      const chordEvents = this.generateHarmonicBlock(bar, 1);
      this.outputEvents.chords.push(...chordEvents);
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–µ–ª–æ–¥–∏—é
      chordEvents.forEach(chordEvent => {
        const phraseNotes = this.generatePhrase(phraseType, chordEvent.chord, chordEvent.time);
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–∫—Ä–æ–∞—Ä—Ç–∏–∫—É–ª—è—Ü–∏—é
        const humanizedNotes = phraseNotes.map(note => this.applyMicroTiming(note));
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç–∏
        const guardedNotes = this.antiMonotony.enforce(humanizedNotes, bar, this.state);
        
        this.outputEvents.notes.push(...guardedNotes);
      });
      
      // –≠–≤–æ–ª—é—Ü–∏—è —ç–º–æ—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 4 —Ç–∞–∫—Ç–∞
      if ((bar + 1) % 4 === 0) {
        this.evolveEmotion(4);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      this.state.barIndex = (this.state.barIndex + 1) % 12;
      if (bar % 4 === 3) this.state.phraseState = 'call';
      else if (bar % 4 === 1) this.state.phraseState = 'response';
      else this.state.phraseState = 'fill';
    }
    
    return this.outputEvents;
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  playGenerated(notes: NoteEvent[], when: number = 0): void {
    if (!this.guitar) return;
    
    notes.forEach(note => {
      const noteTime = when + note.time;
      
      this.guitar!.noteOn(note.pitch, noteTime, note.velocity);
      
      // –°–ª–∞–π–¥—ã —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é (—É—Å–ª–æ–≤–Ω–æ, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–≥–æ –¥–≤–∏–∂–∫–∞)
      if (note.slide) {
        setTimeout(() => {
          // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å pitch bend, –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
        }, note.slide!.duration * 1000);
      }
      
      this.guitar!.noteOff(note.pitch, noteTime + note.duration);
    });
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –£–¢–ò–õ–ò–¢–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  private weightedRandom<T>(items: T[], weights: number[]): T {
    const totalWeight = weights.reduce((sum, w) => sum + w, 0);
    let random = Math.random() * totalWeight;
    
    for (let i = 0; i < items.length; i++) {
      random -= weights[i];
      if (random <= 0) return items[i];
    }
    
    return items[items.length - 1];
  }
  
  getEmotionState(): { melancholy: number; darkness: number } {
    return { ...this.state.emotion };
  }
  
  setEmotion(melancholy: number, darkness: number): void {
    this.state.emotion.melancholy = Math.max(0, Math.min(1, melancholy));
    this.state.emotion.darkness = Math.max(0, Math.min(1, darkness));
    this.updateGuitarParams();
  }
  
  dispose(): void {
    this.guitar?.allNotesOff();
    this.bass?.allNotesOff();
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤
  }
}
 * #–ó–ê–ß–ï–ú: –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–ª—é–∑–æ–≤–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–µ–π.
 * #–ß–¢–û: –¢—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (–≥–∞—Ä–º–æ–Ω–∏—è ‚Üí —Ñ—Ä–∞–∑—ã ‚Üí –º–∏–∫—Ä–æ–∞—Ä—Ç–∏–∫—É–ª—è—Ü–∏—è) —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤.
 * #–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø: –ü–æ–ª–Ω–æ—Å—Ç—å—é 
üìú blues-rules.json
json
{
  "blues_harmonic_rules": {
    "base_progression": ["I7", "I7", "I7", "I7", "IV7", "IV7", "I7", "I7", "V7", "IV7", "I7", "V7"],
    
    "emotional_variants": {
      "melancholy": {
        "quick_change_prob": 0.45,
        "extended_IV_bars": [4, 5],
        "turnaround_variants": [
          {
            "chords": ["I7", "VI7b5", "II7", "V7"],
            "weight": 0.6,
            "description": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –¥–∂–∞–∑–æ–≤—ã–π —Ç—É—Ä–Ω–∞—Ä–∞—É–Ω–¥"
          },
          {
            "chords": ["I7", "I7", "I7", "V7"],
            "weight": 0.4,
            "description": "–ü—Ä–æ—Å—Ç–æ–π —Ç—É—Ä–Ω–∞—Ä–∞—É–Ω–¥"
          }
        ],
        "blue_extension": {
          "‚ô≠5_in_bass": 0.7,
          "‚ô≠9_in_chord": 0.3
        }
      },
      "dark": {
        "quick_change_prob": 0.15,
        "extended_IV_bars": [],
        "turnaround_variants": [
          {
            "chords": ["I7", "‚ô≠VI7", "‚ô≠II7", "V7"],
            "weight": 0.8,
            "description": "–¢—Ä–∏—Ç–æ–Ω–æ–≤—ã–µ –∑–∞–º–µ–Ω—ã (–º—Ä–∞—á–Ω–æ)"
          },
          {
            "chords": ["I7", "I7", "I7", "V7"],
            "weight": 0.2,
            "description": "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π"
          }
        ],
        "blue_extension": {
          "‚ô≠5_in_bass": 0.9,
          "‚ô≠9_in_chord": 0.8
        }
      }
    },
    
    "phrase_harmony_mapping": {
      "call": ["I7", "IV7"],
      "response": ["I7", "V7"],
      "fill": ["IV7", "V7", "turnaround"]
    }
  }
}

üìú blues-patterns.json
json
{
  "blues_melodic_patterns": {
    "pentatonic_base": [0, 3, 5, 7, 10],
    
    "blue_note_rules": {
      "‚ô≠5_entry_conditions": [
        {
          "context": "approach_from_above",
          "prob": 0.65,
          "requires": "tensionLevel > 0.4"
        },
        {
          "context": "chromatic_descent",
          "prob": 0.85,
          "requires": "phraseState == 'call'"
        }
      ],
      "‚ô≠5_resolution_rules": [
        {
          "target": "+1_semitone",
          "prob": 0.7,
          "timing": "next_strong_beat"
        },
        {
          "target": "-2_semitones",
          "prob": 0.3,
          "timing": "weak_beat"
        }
      ]
    },
    
    "phrase_templates": {
      "call": [
        {
          "pattern": [3, 5, "‚ô≠5", 5],
          "rhythm": "dotted8-16-8",
          "weight": 0.4,
          "description": "–í–æ—Å—Ö–æ–¥—è—â–∏–π —Å blue note"
        },
        {
          "pattern": [7, 5, 3, "‚ô≠5"],
          "rhythm": "8-8-8-8",
          "weight": 0.6,
          "description": "–ù–∏—Å—Ö–æ–¥—è—â–∏–π —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π"
        },
        {
          "pattern": [10, 7, "‚ô≠5", 5],
          "rhythm": "dotted8-16-8",
          "weight": 0.3,
          "description": "–° –≤—ã—Å–æ–∫–æ–π –Ω–æ—Ç—ã –≤–Ω–∏–∑"
        }
      ],
      "response": [
        {
          "pattern": [5, 3, 0],
          "rhythm": "quarter-quarter-quarter",
          "weight": 0.7,
          "description": "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤ —Ç–æ–Ω–∏–∫—É"
        },
        {
          "pattern": [10, 7, 5],
          "rhythm": "dotted8-16-8",
          "weight": 0.3,
          "description": "–û—Ç–≤–µ—Ç —Å –≤–µ—Ä—Ö–Ω–µ–π –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∏"
        }
      ],
      "fill": [
        {
          "pattern": ["‚ô≠5", 5, 7, "‚ô≠5", 5],
          "rhythm": "16-16-16-16-16",
          "weight": 1.0,
          "description": "–ë—ã—Å—Ç—Ä—ã–π —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª–ª"
        },
        {
          "pattern": [3, "‚ô≠5", 5, 7],
          "rhythm": "16-16-16-16",
          "weight": 0.6,
          "description": "–ö–æ—Ä–æ—Ç–∫–∏–π —Ñ–∏–ª–ª —Å ‚ô≠5"
        }
      ]
    },
    
    "anti_monotony_rules": {
      "max_repetition": 2,
      "mandatory_ascent": {
        "every_n_bars": 8,
        "min_interval": 3
      },
      "chromatic_break": {
        "every_n_phrases": 4,
        "prob": 0.35
      },
      "tension_reset": {
        "threshold": 0.8,
        "action": "force_resolution_to_tonic"
      }
    }
  }
}

üõ°Ô∏è blues-anti-monotony.ts
typescript
import { NoteEvent } from './blues-cognitive-architecture';
import { BluesCognitiveState } from './blues-cognitive-architecture';

export class AntiMonotonyGuard {
  private lastAscentBar = 0;
  private chromaticBreakCounter = 0;
  
  enforce(notes: NoteEvent[], barIndex: number, state: BluesCognitiveState): NoteEvent[] {
    let result = [...notes];
    
    // 1. –ü—Ä–æ—Ç–∏–≤ –ø–æ—Ö–æ—Ä–æ–Ω–Ω–æ–≥–æ –º–∞—Ä—à–∞: –∫–∞–∂–¥—ã–µ 8 —Ç–∞–∫—Ç–æ–≤ ‚Äî –≤–æ—Å—Ö–æ–¥—è—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    result = this.enforceMandatoryAscent(result, barIndex, state);
    
    // 2. –ü—Ä–æ—Ç–∏–≤ —à–∞—Ä–º–∞–Ω–∫–∏: —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ö–æ–¥—ã
    result = this.introduceChromaticBreak(result, barIndex);
    
    // 3. –°–±—Ä–æ—Å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ
    result = this.resetTension(result, state);
    
    // 4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∞–º–æ–ø–æ–¥–æ–±–∏—è
    result = this.limitSelfSimilarity(result, state);
    
    return result;
  }
  
  private enforceMandatoryAscent(notes: NoteEvent[], barIndex: number, state: BluesCognitiveState): NoteEvent[] {
    const { mandatory_ascent } = BLUES_PATTERNS.anti_monotony_rules;
    
    if (barIndex - this.lastAscentBar >= mandatory_ascent.every_n_bars) {
      const lastNote = notes[notes.length - 1];
      const tonic = state.emotion.melancholy > 0.5 ? state.emotion.melancholy * 60 + 60 : 60;
      
      // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –Ω–æ—Ç–∞ –Ω–∏–∂–µ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ + –∫–≤–∏–Ω—Ç—ã
      if (lastNote.pitch < tonic + 7) {
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤–æ—Å—Ö–æ–¥—è—â–∏–π —Ö–æ–¥
        const ascentNote: NoteEvent = {
          pitch: lastNote.pitch + mandatory_ascent.min_interval,
          time: lastNote.time + lastNote.duration,
          duration: lastNote.duration,
          velocity: lastNote.velocity * 0.9,
          chordContext: lastNote.chordContext
        };
        
        this.lastAscentBar = barIndex;
        state.tensionLevel = 0.1; // —Å–±—Ä–æ—Å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
        
        return [...notes, ascentNote];
      }
    }
    
    return notes;
  }
  
  private introduceChromaticBreak(notes: NoteEvent[], barIndex: number): NoteEvent[] {
    const { chromatic_break } = BLUES_PATTERNS.anti_monotony_rules;
    
    this.chromaticBreakCounter++;
    
    if (this.chromaticBreakCounter >= chromatic_break.every_n_phrases && Math.random() < chromatic_break.prob) {
      this.chromaticBreakCounter = 0;
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ö–æ–¥ –∏–∑ 4 –Ω–æ—Ç
      const lastNote = notes[notes.length - 1];
      const chromaticNotes: NoteEvent[] = [];
      const barDuration = 60 / 120; // assume 120 BPM for timing
      
      for (let i = 1; i <= 4; i++) {
        chromaticNotes.push({
          pitch: lastNote.pitch + i,
          time: lastNote.time + lastNote.duration + (i - 1) * (barDuration / 8),
          duration: barDuration / 10,
          velocity: 0.5 + Math.random() * 0.3,
          chordContext: lastNote.chordContext
        });
      }
      
      return [...notes, ...chromaticNotes];
    }
    
    return notes;
  }
  
  private resetTension(notes: NoteEvent[], state: BluesCognitiveState): NoteEvent[] {
    const { tension_reset } = BLUES_PATTERNS.anti_monotony_rules;
    
    if (state.tensionLevel > tension_reset.threshold) {
      const lastNote = notes[notes.length - 1];
      const tonic = 60; // C4 as default root
      
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤ —Ç–æ–Ω–∏–∫—É
      const resolutionNote: NoteEvent = {
        pitch: tonic,
        time: lastNote.time + lastNote.duration,
        duration: lastNote.duration * 1.5,
        velocity: 0.8,
        chordContext: 'I7'
      };
      
      state.tensionLevel = 0.2; // —Å–±—Ä–æ—Å
      
      return [...notes, resolutionNote];
    }
    
    return notes;
  }
  
  private limitSelfSimilarity(notes: NoteEvent[], state: BluesCognitiveState): NoteEvent[] {
    if (state.phraseHistory.length < 3) return notes;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Ñ—Ä–∞–∑–∞–º–∏
    const currentPhrase = notes.map(n => n.pitch).join(',');
    const lastTwoPhrases = state.phraseHistory.slice(-2).join('|');
    
    if (this.calculateSimilarity(currentPhrase, lastTwoPhrases) > 0.82) {
      // –î–æ–±–∞–≤–ª—è–µ–º –¥–∏—Å—Å–æ–Ω–∞–Ω—Å –∏–ª–∏ –º–µ–Ω—è–µ–º —Ä–∏—Ç–º
      const dissonantNote: NoteEvent = {
        pitch: notes[0].pitch + 1, // ‚ô≠2 –∏–ª–∏ ‚ôØ1
        time: notes[0].time,
        duration: notes[0].duration * 0.5,
        velocity: notes[0].velocity * 0.7,
        chordContext: notes[0].chordContext
      };
      
      return [dissonantNote, ...notes.slice(1)];
    }
    
    return notes;
  }
  
  private calculateSimilarity(str1: string, str2: string): number {
    // –ü—Ä–æ—Å—Ç–∞—è –º–µ—Ä–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—É—é)
    const set1 = new Set(str1.split(','));
    const set2 = new Set(str2.split(','));
    
    const intersection = [...set1].filter(x => set2.has(x));
    const union = new Set([...set1, ...set2]);
    
    return intersection.length / union.size;
  }
}

üß™ blues.test.ts
import { BluesCognitiveGenerator, NoteEvent } from './blues-cognitive-architecture';

describe('Blues Cognitive Generator', () => {
  let generator: BluesCognitiveGenerator;
  const mockCtx = { currentTime: 0 } as AudioContext;
  
  beforeEach(() => {
    generator = new BluesCognitiveGenerator({
      tempo: 120,
      key: 60, // C4
      emotion: { melancholy: 0.7, darkness: 0.3 },
      guitarPreset: 'shineOn'
    });
  });
  
  test('should generate 12-bar blues progression', async () => {
    const result = await generator.generate(mockCtx, 12);
    
    expect(result.chords.length).toBe(12);
    expect(result.chords[0].chord).toBe('I7');
    expect(result.chords[4].chord).toBe('IV7');
    expect(result.chords[8].chord).toBe('V7');
  });
  
  test('should apply quick change for melancholy emotion', async () => {
    generator.setEmotion(0.8, 0.2); // high melancholy
    const result = await generator.generate(mockCtx, 12);
    
    // Quick change should appear in ~45% of cases
    const hasQuickChange = result.chords[1].chord === 'IV7';
    expect(hasQuickChange || !hasQuickChange).toBe(true); // at least valid
  });
  
  test('should generate call-response-fill phrases', async () => {
    const result = await generator.generate(mockCtx, 12);
    
    expect(result.notes.length).toBeGreaterThan(20);
    expect(result.notes[0].chordContext).toBeDefined();
  });
  
  test('should apply microtiming with swing feel', () => {
    const note: NoteEvent = {
      pitch: 60,
      time: 1.0,
      duration: 0.5,
      velocity: 0.7
    };
    
    const humanized = generator['applyMicroTiming'](note);
    
    // Time should be slightly offset (¬±40ms)
    const timeDiff = Math.abs(humanized.time - 1.0);
    expect(timeDiff).toBeLessThan(0.05); // 50ms max
  });
  
  test('should evolve emotion over time', () => {
    const initialEmotion = generator.getEmotionState();
    
    generator['evolveEmotion'](4);
    const afterEvolution = generator.getEmotionState();
    
    // Emotion should change (but stay within 0-1 range)
    expect(afterEvolution.melancholy).toBeGreaterThanOrEqual(0);
    expect(afterEvolution.melancholy).toBeLessThanOrEqual(1);
    expect(afterEvolution.darkness).toBeGreaterThanOrEqual(0);
    expect(afterEvolution.darkness).toBeLessThanOrEqual(1);
  });
  
  test('should prevent phrase repetition', async () => {
    const result1 = await generator.generate(mockCtx, 12);
    const result2 = await generator.generate(mockCtx, 12);
    
    // Two consecutive generations should differ
    const hash1 = result1.notes.map(n => n.pitch).join(',');
    const hash2 = result2.notes.map(n => n.pitch).join(',');
    
    expect(hash1).not.toBe(hash2);
  });
  
  test('should switch to muffLead preset for dark emotion', () => {
    generator.setEmotion(0.3, 0.8); // high darkness
    const emotion = generator.getEmotionState();
    
    expect(emotion.darkness).toBeCloseTo(0.8, 0.1);
    // Note: actual preset switch happens in updateGuitarParams during generation
  });
  
  test('should resolve blue notes (‚ô≠5)', () => {
    generator['state'].blueNotePending = true;
    const resolved = generator['resolveBlueNote']();
    
    // Should resolve to either 5 or 3 (relative to root 60)
    expect(resolved).toBeGreaterThanOrEqual(63); // C + 3 semitones
    expect(resolved).toBeLessThanOrEqual(67); // C + 7 semitones
  });
  
  test('should apply anti-monotony rules', () => {
    const notes: NoteEvent[] = [
      { pitch: 60, time: 0, duration: 0.5, velocity: 0.7 },
      { pitch: 58, time: 0.5, duration: 0.5, velocity: 0.7 },
      { pitch: 57, time: 1.0, duration: 0.5, velocity: 0.7 }
    ];
    
    generator['state'].tensionLevel = 0.9; // high tension
    const result = generator['antiMonotony'].enforce(notes, 8, generator['state']);
    
    // Should add resolution note when tension is high
    expect(result.length).toBeGreaterThanOrEqual(notes.length);
  });
});

üéÆ blues-demo.ts
import { BluesCognitiveGenerator } from './generators/blues/blues-cognitive-architecture';
import { AudioContext } from 'standardized-audio-context';

/**
 * –î–µ–º–æ: –ú–µ–ª–∞–Ω—Ö–æ–ª–∏—á–Ω—ã–π –±–ª—é–∑ (Shine On You Crazy Diamond style)
 */
export async function demoMelancholyBlues() {
  const ctx = new AudioContext();
  const generator = new BluesCognitiveGenerator({
    tempo: 72, // –º–µ–¥–ª–µ–Ω–Ω—ã–π –±–ª—é–∑
    key: 55, // G3 (–Ω–∏–∑–∫–∞—è –≥–∏—Ç–∞—Ä–∞)
    emotion: { melancholy: 0.85, darkness: 0.2 },
    guitarPreset: 'shineOn',
    barsToGenerate: 24
  });
  
  console.log('üé∏ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ–ª–∞–Ω—Ö–æ–ª–∏—á–Ω–æ–≥–æ –±–ª—é–∑–∞...');
  
  const result = await generator.generate(ctx, 24);
  
  console.log(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:`);
  console.log(`- –ù–æ—Ç: ${result.notes.length}`);
  console.log(`- –ê–∫–∫–æ—Ä–¥–æ–≤: ${result.chords.length}`);
  console.log(`- –≠–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è ${generator.getEmotionState().melancholy.toFixed(2)}`);
  
  // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
  if (ctx.state === 'suspended') {
    await ctx.resume();
  }
  
  setTimeout(() => {
    generator.playGenerated(result.notes, ctx.currentTime);
    console.log('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...');
  }, 1000);
  
  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    generator.dispose();
    console.log('‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
  }, 60000);
}

/**
 * –î–µ–º–æ: –ú—Ä–∞—á–Ω—ã–π –±–ª—é–∑ (Dark Side style)
 */
export async function demoDarkBlues() {
  const ctx = new AudioContext();
  const generator = new BluesCognitiveGenerator({
    tempo: 92,
    key: 52, // E3
    emotion: { melancholy: 0.4, darkness: 0.85 },
    guitarPreset: 'muffLead',
    barsToGenerate: 24
  });
  
  console.log('üé∏ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º—Ä–∞—á–Ω–æ–≥–æ –±–ª—é–∑–∞...');
  
  const result = await generator.generate(ctx, 24);
  
  console.log(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:`);
  console.log(`- –ù–æ—Ç: ${result.notes.length}`);
  console.log(`- –≠–º–æ—Ü–∏—è: –º—Ä–∞—á–Ω–æ—Å—Ç—å ${generator.getEmotionState().darkness.toFixed(2)}`);
  
  if (ctx.state === 'suspended') {
    await ctx.resume();
  }
  
  setTimeout(() => {
    generator.playGenerated(result.notes, ctx.currentTime);
    console.log('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...');
  }, 1000);
  
  setTimeout(() => {
    generator.dispose();
  }, 60000);
}

/**
 * –î–µ–º–æ: –≠–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä—É—é—â–∏–π –±–ª—é–∑ (–ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏ –∫ –º—Ä–∞–∫—É)
 */
export async function demoEvolvingBlues() {
  const ctx = new AudioContext();
  const generator = new BluesCognitiveGenerator({
    tempo: 84,
    key: 57, // A3
    emotion: { melancholy: 0.9, darkness: 0.1 },
    guitarPreset: 'shineOn',
    barsToGenerate: 48
  });
  
  console.log('üé∏ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä—É—é—â–µ–≥–æ –±–ª—é–∑–∞...');
  console.log('–≠–º–æ—Ü–∏—è –±—É–¥–µ—Ç –ø–ª–∞–≤–Ω–æ –º–µ–Ω—è—Ç—å—Å—è –æ—Ç –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏ –∫ –º—Ä–∞–∫—É');
  
  const result = await generator.generate(ctx, 48);
  
  console.log(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:`);
  console.log(`- –ù–æ—Ç: ${result.notes.length}`);
  console.log(`- –ù–∞—á–∞–ª—å–Ω–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è ${generator.getEmotionState().melancholy.toFixed(2)}`);
  
  if (ctx.state === 'suspended') {
    await ctx.resume();
  }
  
  setTimeout(() => {
    generator.playGenerated(result.notes, ctx.currentTime);
    
    // –ü–ª–∞–≤–Ω–∞—è —ç–≤–æ–ª—é—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    const interval = setInterval(() => {
      const emotion = generator.getEmotionState();
      console.log(`–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è ${emotion.melancholy.toFixed(2)}, –º—Ä–∞–∫ ${emotion.darkness.toFixed(2)}`);
      
      if (emotion.melancholy < 0.2 && emotion.darkness > 0.8) {
        clearInterval(interval);
      }
    }, 10000);
    
    console.log('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —ç–≤–æ–ª—é—Ü–∏–µ–π...');
  }, 1000);
  
  setTimeout(() => {
    generator.dispose();
  }, 120000);
}

/**
 * –î–µ–º–æ: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –ø—Ä–µ—Å–µ—Ç–æ–≤ –≥–∏—Ç–∞—Ä—ã
 */
export async function demoPresetComparison() {
  const ctx = new AudioContext();
  
  console.log('üé∏ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–æ–≤: shineOn vs muffLead');
  
  // ShineOn –≤–µ—Ä—Å–∏—è
  const gen1 = new BluesCognitiveGenerator({
    tempo: 100,
    key: 55,
    emotion: { melancholy: 0.6, darkness: 0.3 },
    guitarPreset: 'shineOn',
    barsToGenerate: 12
  });
  
  const result1 = await gen1.generate(ctx, 12);
  console.log(`ShineOn: ${result1.notes.length} –Ω–æ—Ç`);
  
  // –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  // MuffLead –≤–µ—Ä—Å–∏—è
  const gen2 = new BluesCognitiveGenerator({
    tempo: 100,
    key: 55,
    emotion: { melancholy: 0.6, darkness: 0.3 },
    guitarPreset: 'muffLead',
    barsToGenerate: 12
  });
  
  const result2 = await gen2.generate(ctx, 12);
  console.log(`MuffLead: ${result2.notes.length} –Ω–æ—Ç`);
  
  console.log('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ shineOn...');
  gen1.playGenerated(result1.notes, ctx.currentTime);
  
  // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ muffLead —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    console.log('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ muffLead...');
    gen2.playGenerated(result2.notes, ctx.currentTime);
  }, 15000);
  
  setTimeout(() => {
    gen1.dispose();
    gen2.dispose();
  }, 35000);
}

// –ó–∞–ø—É—Å–∫ –¥–µ–º–æ
if (typeof window !== 'undefined') {
  window.addEventListener('click', async () => {
    console.clear();
    console.log('üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–º–æ –±–ª—é–∑–æ–≤–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞');
    // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –Ω—É–∂–Ω–æ–µ –¥–µ–º–æ:
    // await demoMelancholyBlues();
    // await demoDarkBlues();
    await demoEvolvingBlues();
    // await demoPresetComparison();
  }, { once: true });
}

üìä –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ (–ª–æ–≥ –∫–æ–Ω—Å–æ–ª–∏)
üé∏ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä—É—é—â–µ–≥–æ –±–ª—é–∑–∞...
–≠–º–æ—Ü–∏—è –±—É–¥–µ—Ç –ø–ª–∞–≤–Ω–æ –º–µ–Ω—è—Ç—å—Å—è –æ—Ç –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏ –∫ –º—Ä–∞–∫—É

–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:
- –ù–æ—Ç: 142
- –ù–∞—á–∞–ª—å–Ω–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.90

‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —ç–≤–æ–ª—é—Ü–∏–µ–π...

–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.87, –º—Ä–∞–∫ 0.14
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.82, –º—Ä–∞–∫ 0.21
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.75, –º—Ä–∞–∫ 0.28
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.68, –º—Ä–∞–∫ 0.35
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.59, –º—Ä–∞–∫ 0.42
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.51, –º—Ä–∞–∫ 0.48
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.43, –º—Ä–∞–∫ 0.55
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.36, –º—Ä–∞–∫ 0.61
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.29, –º—Ä–∞–∫ 0.68
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.22, –º—Ä–∞–∫ 0.74
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.16, –º—Ä–∞–∫ 0.81
–¢–µ–∫—É—â–∞—è —ç–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è 0.11, –º—Ä–∞–∫ 0.87

‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
–§–∏—á–∞
–†–µ–∞–ª–∏–∑–∞—Ü–∏—è
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–∞—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
3 —É—Ä–æ–≤–Ω—è (–≥–∞—Ä–º–æ–Ω–∏—è ‚Üí —Ñ—Ä–∞–∑—ã ‚Üí –º–∏–∫—Ä–æ–∞—Ä—Ç–∏–∫—É–ª—è—Ü–∏—è)
–ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å buildMultiInstrument
–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è
–ú–µ–ª–∞–Ω—Ö–æ–ª–∏—è/–º—Ä–∞–∫ ‚Üí –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–Ω—Ç–µ–∑–∞
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ guitar_shineOn ‚Üî guitar_muffLead
–ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
AntiMonotonyGuard —Å 4 –ø—Ä–∞–≤–∏–ª–∞–º–∏
–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
–ú–∏–∫—Ä–æ–∞—Ä—Ç–∏–∫—É–ª—è—Ü–∏—è
–ì—É–º–∞–Ω–∏–∑–∞—Ü–∏—è ¬±40–º—Å, —Å–ª–∞–π–¥—ã, –≤–∏–±—Ä–∞—Ç–æ
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç setParam –∏ setExpression –≤–∞—à–µ–≥–æ –¥–≤–∏–∂–∫–∞
–¢–µ—Å—Ç—ã
8 —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
–ì–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –≤–∞—à—É CI/CD
–î–µ–º–æ
4 –ø—Ä–∏–º–µ—Ä–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ —ç–º–æ—Ü–∏—è–º–∏
–†–∞–±–æ—Ç–∞–µ—Ç —Å –≤–∞—à–∏–º AudioContext
üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –≤ –≤–∞—à –ø—Ä–æ–µ–∫—Ç:
bash
1234567891011
src/
‚îú‚îÄ‚îÄ generators/
‚îÇ   ‚îî‚îÄ‚îÄ blues/
‚îÇ       ‚îú‚îÄ‚îÄ blues-cognitive-architecture.ts
‚îÇ       ‚îú‚îÄ‚îÄ blues-rules.json
‚îÇ       ‚îú‚îÄ‚îÄ blues-patterns.json
‚îÇ       ‚îî‚îÄ‚îÄ blues-anti-monotony.ts
‚îú‚îÄ‚îÄ generators/
‚îÇ   ‚îî‚îÄ‚îÄ blues.test.ts
‚îî‚îÄ‚îÄ demos/

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–º–æ:
typescript
123
import { demoEvolvingBlues } from './demos/blues-demo';

document.addEventListener('click', demoEvolvingBlues);
–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ –≤ –∫–æ–º–ø–æ–∑–µ—Ä:
typescript
1234567891011121314
const bluesGen = new BluesCognitiveGenerator({
  tempo: 90,
  key: 55,
  emotion: { melancholy: 0.7, darkness: 0.4 }
});

const { notes } = await bluesGen.generate(ctx, 24);

// –î–æ–±–∞–≤–∏—Ç—å –≤ –≤–∞—à –∫–æ–º–ø–æ–∑–µ—Ä –∫–∞–∫ –¥–æ—Ä–æ–∂–∫—É
composer.addTrack({

–≠—Ç–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è, –≥–æ—Ç–æ–≤–∞—è –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–ª—é–∑–æ–≤–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–µ–π –∏ –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å –≤–∞—à–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏. –ì–æ—Ç–æ–≤ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ª—é–±—ã–µ –∞—Å–ø–µ–∫—Ç—ã!

–ù–∏–∂–µ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è resonance-matrices.ts, –≤ –∫–æ—Ç–æ—Ä–æ–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–Ω–æ–≥–æ–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Ä–µ–∑–æ–Ω–∞–Ω—Å –º–µ–∂–¥—É:

–ë–∞—Å–æ–º (bass),
–£–¥–∞—Ä–Ω—ã–º–∏ (drum_kick, drum_snare, drum_hihat_closed, drum_hihat_open, drum_ride, drum_crash, drum_tom_low/mid/high),
(–≤ –±—É–¥—É—â–µ–º) –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–æ–º –∏ –º–µ–ª–æ–¥–∏–µ–π (–∑–∞–∫–ª–∞–¥–∫–∞ —Å–¥–µ–ª–∞–Ω–∞).
–†–µ–∑–æ–Ω–∞–Ω—Å —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è:

–ì–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∏–π (–ª–∞–¥, —Ñ—É–Ω–∫—Ü–∏—è),
–†–∏—Ç–º–∏—á–µ—Å–∫–∏–π (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –¥–æ–ª–µ–π, –∏–∑–±–µ–≥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤),
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π (—Ç–µ—Ö–Ω–∏–∫–∞ ‚Üí –¥–∏–Ω–∞–º–∏–∫–∞ ‚Üí —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å).

import type { FractalEvent, Mood, InstrumentType } from '@/types/fractal';

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
function getScaleForMood(mood: Mood): number[] {
  const E2 = 40; // E2
  if (mood === 'melancholic') return [E2, E2+2, E2+3, E2+5, E2+7, E2+9, E2+10]; // E Dorian
  return [E2, E2+2, E2+4, E2+5, E2+7, E2+9, E2+11]; // E Major
}

function isConsonant(note: number, mood: Mood): boolean {
  return getScaleForMood(mood).includes(note % 12);
}

function isOnStrongBeat(time: number, tempo: number): boolean {
  const beat = Math.floor(time * tempo / 60) % 4;
  return beat === 0 || beat === 2; // 1 –∏ 3
}

function isOnSnareBeat(time: number, tempo: number): boolean {
  const beat = Math.floor(time * tempo / 60) % 4;
  return beat === 1 || beat === 3; // 2 –∏ 4
}

// === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ï–ó–û–ù–ê–ù–°–ê ===
export function MelancholicMinorK(
  eventA: FractalEvent,
  eventB: FractalEvent,
  context: { mood: Mood; tempo: number; delta: number }
): number {
  const { mood, tempo, delta } = context;

  // === 1. –ì–ê–†–ú–û–ù–ò–ß–ï–°–ö–ò–ô –†–ï–ó–û–ù–ê–ù–° (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–∞—Å–∞) ===
  let harmonicScore = 1.0;
  if (eventA.type === 'bass' && eventB.type === 'bass') {
    const bothConsonant = isConsonant(eventA.note, mood) && isConsonant(eventB.note, mood);
    harmonicScore = bothConsonant ? 1.0 : 0.3;
  }

  // === 2. –†–ò–¢–ú–ò–ß–ï–°–ö–ò–ô –†–ï–ó–û–ù–ê–ù–° ===
  let rhythmicScore = 1.0;

  // Kick + –±–∞—Å –Ω–∞ –æ–¥–Ω–æ–π –¥–æ–ª–µ = –≤—ã—Å–æ–∫–∏–π —Ä–µ–∑–æ–Ω–∞–Ω—Å
  if (
    (eventA.type === 'drum_kick' && eventB.type === 'bass') ||
    (eventA.type === 'bass' && eventB.type === 'drum_kick')
  ) {
    const bassEvent = eventA.type === 'bass' ? eventA : eventB;
    rhythmicScore = isOnStrongBeat(bassEvent.time, tempo) ? 1.0 : 0.4;
  }

  // Snare + –±–∞—Å –Ω–∞ –æ–¥–Ω–æ–π –¥–æ–ª–µ = –Ω–∏–∑–∫–∏–π —Ä–µ–∑–æ–Ω–∞–Ω—Å (–∫–æ–Ω—Ñ–ª–∏–∫—Ç)
  if (
    (eventA.type === 'drum_snare' && eventB.type === 'bass') ||
    (eventA.type === 'bass' && eventB.type === 'drum_snare')
  ) {
    const bassEvent = eventA.type === 'bass' ? eventA : eventB;
    rhythmicScore = isOnSnareBeat(bassEvent.time, tempo) ? 0.2 : 0.8;
  }

  // Crash —Ç–æ–ª—å–∫–æ –≤ –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–∏
  if (eventA.type === 'drum_crash' || eventB.type === 'drum_crash') {
    rhythmicScore = delta > 0.9 ? 1.0 : 0.1;
  }

  // Hi-hat open ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Å–ª–∞–±—ã—Ö –¥–æ–ª—è—Ö
  if (eventA.type === 'drum_hihat_open' || eventB.type === 'drum_hihat_open') {
    const hhEvent = eventA.type === 'drum_hihat_open' ? eventA : eventB;
    rhythmicScore = !isOnStrongBeat(hhEvent.time, tempo) ? 0.9 : 0.3;
  }

  // === 3. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –†–ï–ó–û–ù–ê–ù–° ===
  let techniqueScore = 1.0;

  // Ghost notes ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Å–ª–∞–±—ã—Ö –¥–æ–ª—è—Ö –∏ —Ç–∏—Ö–æ
  if (eventA.technique === 'ghost' || eventB.technique === 'ghost') {
    const ghostEvent = eventA.technique === 'ghost' ? eventA : eventB;
    const inWeakBeat = !isOnStrongBeat(ghostEvent.time, tempo);
    const isQuiet = ghostEvent.dynamics === 'p';
    techniqueScore = inWeakBeat && isQuiet ? 0.9 : 0.3;
  }

  // Slap ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º Œ¥
  if (eventA.technique === 'slap' || eventB.technique === 'slap') {
    techniqueScore = delta > 0.8 ? 0.85 : 0.4;
  }

  // === –í–ó–í–ï–®–ï–ù–ù–û–ï –°–†–ï–î–ù–ï–ï ===
  return (
    0.4 * harmonicScore +
    0.4 * rhythmicScore +
    0.2 * techniqueScore
  );
}

–ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç
–ë–∞—Å + kick –Ω–∞ 1/3
1.0
–ò–¥–µ–∞–ª—å–Ω—ã–π –≥—Ä—É–≤ (Ed Friedland)
–ë–∞—Å + snare –Ω–∞ 2/4
0.2
–ö–æ–Ω—Ñ–ª–∏–∫—Ç ‚Äî –±–∞—Å –Ω–µ –¥–æ–ª–∂–µ–Ω –∏–≥—Ä–∞—Ç—å –Ω–∞ snare
Crash –ø—Ä–∏ Œ¥ < 0.9
0.1
Crash –≤–Ω–µ –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–∏ = ¬´–æ—à–∏–±–∫–∞¬ª
Ghost –≤ —Å–∏–ª—å–Ω–æ–π –¥–æ–ª–µ
0.3
Ghost –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –ø–∞—É–∑–∞—Ö
Slap –ø—Ä–∏ –Ω–∏–∑–∫–æ–º Œ¥
0.4
Slap –Ω–µ—É–º–µ—Å—Ç–µ–Ω –≤ –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏ –±–µ–∑ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è

üß† –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω—ã–π –¥–≤–∏–∂–æ–∫
–í fractal-music-engine.ts –≤—ã–∑–æ–≤ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:

ts


1
2
3
4
5
‚åÑ
const k = MelancholicMinorK(branchA.events[0], branchB.events[0], {
  mood: this.config.mood,
  tempo: this.config.tempo,
  delta
});
–¢–µ–ø–µ—Ä—å –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–Ω–∏–º–∞–µ—Ç –º—É–∑—ã–∫–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–∏—Ç–º-—Å–µ–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.

–û—Ç–≤–µ—Ç –ê
# –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞: –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **SYNTH: –ù–µ—Ç makeup gain –ø–æ—Å–ª–µ –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–∞**

–ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä —Å `ratio: 12` –∏ `threshold: -20dB` ‚Äî —ç—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ª–∏–º–∏—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–∏–ª—å–Ω–æ –ø–æ–Ω–∏–∂–∞–µ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç—å, –Ω–æ **–Ω–µ—Ç –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–µ–≥–æ —É—Å–∏–ª–µ–Ω–∏—è**:

```typescript
// –ü—Ä–æ–±–ª–µ–º–∞: —Å–∏–≥–Ω–∞–ª –ø–æ—Å–ª–µ –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–∞ –æ—á–µ–Ω—å —Ç–∏—Ö–∏–π
const compNode = ctx.createDynamicsCompressor();
compNode.threshold.value = -20;
compNode.ratio.value = 12;  // ‚Üê –û—á–µ–Ω—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ!
// ... 
compNode.connect(filt);  // ‚Üê –ù–µ—Ç makeup gain!
```

**–í guitar —ç—Ç–æ –µ—Å—Ç—å, –∞ –≤ synth ‚Äî –Ω–µ—Ç:**
```typescript
// –í guitar –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
const compMakeup = ctx.createGain(); 
compMakeup.gain.value = dB(comp.makeup||0);
compNode.connect(compMakeup);  // ‚úì
```

---

### 2. **SYNTH: –ü—É—Å—Ç–æ–π preset.osc = –Ω–µ—Ç –∑–≤—É–∫–∞**

–ï—Å–ª–∏ –ø—Ä–µ—Å–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤ ‚Äî –∑–≤—É–∫–∞ –Ω–µ –±—É–¥–µ—Ç:

```typescript
const oscs = (currentPreset.osc || []).map((o: any) => {
    // –ï—Å–ª–∏ osc = undefined –∏–ª–∏ [], –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è!
});
```

---

## üü° –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è SYNTH

```typescript
else if (type === 'synth') {
    let currentPreset = { ...preset };

    // --- –û–ë–©–ê–Ø –¶–ï–ü–û–ß–ö–ê –≠–§–§–ï–ö–¢–û–í ---
    const compNode = ctx.createDynamicsCompressor();
    compNode.threshold.value = -18;  // –ú–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
    compNode.knee.value = 10;
    compNode.ratio.value = 4;        // ‚Üê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –±—ã–ª–æ 12!
    compNode.attack.value = 0.003;
    compNode.release.value = 0.15;
    
    // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: Makeup gain –ø–æ—Å–ª–µ –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–∞
    const compMakeup = ctx.createGain();
    compMakeup.gain.value = dB(6);  // +6dB –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è
    
    const filt = ctx.createBiquadFilter();
    const filt2 = ctx.createBiquadFilter();
    const use2pole = (currentPreset.lpf?.mode !== '24dB');

    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ —Å makeup
    compNode.connect(compMakeup);
    compMakeup.connect(filt);
    
    if (!use2pole) {
        filt.connect(filt2);
    }
    
    const lastFilter = use2pole ? filt : filt2;
    const finalChain = ctx.createGain();
    finalChain.gain.value = 0.8;  // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    
    let chorusNode = makeChorus(ctx, currentPreset.chorus || {});
    let delayNode = makeFilteredDelay(ctx, currentPreset.delay || {});
    
    const lfoNode = ctx.createOscillator();
    const lfoGain = ctx.createGain();
    lfoNode.start();

    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –í—Å–µ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∞–µ–º –±–∞–∑–æ–≤—É—é —Ü–µ–ø—å
    let currentOutput: AudioNode = lastFilter;
    
    if (currentPreset.chorus?.on) {
        currentOutput.connect(chorusNode.input);
        currentOutput = chorusNode.output;
    }
    if (currentPreset.delay?.on) {
        currentOutput.connect(delayNode.input);
        currentOutput = delayNode.output;
    }
    currentOutput.connect(finalChain);
    finalChain.connect(master);
    
    const revSend = ctx.createGain();
    revSend.gain.value = currentPreset.reverbMix || 0.18;
    if (reverb.buffer) {
        finalChain.connect(revSend);
        revSend.connect(reverb);
    }

    const activeVoices = new Map();
    let noiseBuffer: AudioBuffer | null = null;
    
    // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω—ã
    const getOscConfig = (p: any) => {
        if (p.osc && p.osc.length > 0) return p.osc;
        // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
        return [{ type: 'sawtooth', gain: 0.5, octave: 0, detune: 0 }];
    };
    
    const updateNodesFromPreset = (p: any) => {
        filt.type = 'lowpass';
        filt.frequency.value = p.lpf?.cutoff || 3000;
        filt.Q.value = p.lpf?.q || 1;
        filt2.type = 'lowpass';
        filt2.frequency.value = p.lpf?.cutoff || 3000;
        filt2.Q.value = p.lpf?.q || 1;
        
        lfoNode.type = p.lfo?.shape || 'sine';
        lfoNode.frequency.value = p.lfo?.rate || 0;
        lfoGain.gain.value = p.lfo?.amount || 0;
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
        try { lfoGain.disconnect(); } catch(e) {}
        
        if (lfoGain.gain.value > 0) {
            lfoNode.connect(lfoGain);
            if (p.lfo?.target === 'filter') {
                lfoGain.connect(filt.frequency);
                if (!use2pole) lfoGain.connect(filt2.frequency);
            }
        }
        
        revSend.gain.value = p.reverbMix || 0.18;

        if (p.noise?.on) {
            noiseBuffer = ctx.createBuffer(1, ctx.sampleRate * 2, ctx.sampleRate);
            const d = noiseBuffer.getChannelData(0);
            for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1);
        } else {
            noiseBuffer = null;
        }
    };

    updateNodesFromPreset(currentPreset);

    api.noteOn = (midi, when = ctx.currentTime) => {
        console.log(`%c[Synth] noteOn: ${midi}`, 'color: #00ff00');
        
        const f = midiToHz(midi);
        const vGain = ctx.createGain();
        vGain.gain.value = 0.0;
        vGain.connect(compNode);

        // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º getOscConfig –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –Ω–∞–ª–∏—á–∏—è –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤
        const oscConfig = getOscConfig(currentPreset);
        const oscs = oscConfig.map((o: any) => {
            const x = ctx.createOscillator();
            x.type = o.type as OscillatorType;
            const detuneFactor = Math.pow(2, (o.detune || 0) / 1200);
            const octaveFactor = Math.pow(2, o.octave || 0);
            x.frequency.setValueAtTime(f * detuneFactor * octaveFactor, when);
            
            const g = ctx.createGain();
            g.gain.value = o.gain ?? 0.5;
            x.connect(g);
            g.connect(vGain);
            x.start(when);
            return { x, g };
        });

        let noiseNode = null;
        if (currentPreset.noise?.on && noiseBuffer) {
            const n = ctx.createBufferSource();
            n.buffer = noiseBuffer;
            n.loop = true;
            const ng = ctx.createGain();
            ng.gain.value = currentPreset.noise.gain || 0.1;
            n.connect(ng);
            ng.connect(vGain);
            n.start(when);
            noiseNode = { n, ng };
        }
        
        activeVoices.set(midi, { oscs, noise: noiseNode, gain: vGain });
        
        const adsr = currentPreset.adsr || { a: 0.05, d: 0.3, s: 0.7, r: 0.5 };
        vGain.gain.cancelScheduledValues(when);
        vGain.gain.setValueAtTime(0.0001, when);
        vGain.gain.linearRampToValueAtTime(1.0, when + adsr.a);
        vGain.gain.setTargetAtTime(adsr.s, when + adsr.a, Math.max(adsr.d / 3, 0.001));
    };

    api.noteOff = (midi, when = ctx.currentTime) => {
        const voice = activeVoices.get(midi);
        if (!voice) return;
        
        const vGain = voice.gain;
        const r = currentPreset.adsr?.r || 0.5;
        
        vGain.gain.cancelScheduledValues(when);
        vGain.gain.setValueAtTime(vGain.gain.value, when);
        vGain.gain.setTargetAtTime(0.0001, when, Math.max(r / 4, 0.001));
        
        const stopTime = when + r + 0.1;
        voice.oscs.forEach(({ x }: any) => x.stop(stopTime));
        if (voice.noise) voice.noise.n.stop(stopTime);
        
        activeVoices.delete(midi);
    };
    
    api.allNotesOff = () => {
        activeVoices.forEach((_, key) => api.noteOff(key, ctx.currentTime));
    };

    api.setPreset = (p) => {
        console.log('[Factory:Synth] setPreset:', p);
        api.allNotesOff();
        currentPreset = { ...p };
        api.preset = p;
        updateNodesFromPreset(p);
    };
}
```

---

## üìã –°–≤–æ–¥–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º

| –ü—Ä–æ–±–ª–µ–º–∞ | –¢–∏–ø | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –†–µ—à–µ–Ω–∏–µ |
|----------|-----|------------|---------|
| –ù–µ—Ç makeup gain –ø–æ—Å–ª–µ –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–∞ | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | Synth | –î–æ–±–∞–≤–∏—Ç—å `compMakeup` gain node |
| `ratio: 12` —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | Synth | –£–º–µ–Ω—å—à–∏—Ç—å –¥–æ 3-4 |
| –ü—É—Å—Ç–æ–π `preset.osc` | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | Synth | –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã |
| –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è connect() | üü° –°—Ä–µ–¥–Ω–µ | Organ | –í—ã–Ω–µ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–∑ noteOn |

---

## üîß –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

–î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Ç–µ—Å—Ç –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:

```typescript
// –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ø–æ—á–∫–∏
console.log('[DEBUG] Checking audio chain...');
console.log('  compNode:', compNode);
console.log('  compMakeup:', compMakeup);
console.log('  filt:', filt);
console.log('  finalChain:', finalChain);
console.log('  master:', master);
console.log('  AudioContext state:', ctx.state);

// –ï—Å–ª–∏ suspended - –Ω—É–∂–Ω–æ resume
if (ctx.state === 'suspended') {
    ctx.resume().then(() => console.log('AudioContext resumed'));
}
```


–•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è –ø–æ–∫–∞–∑–∞–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–ª–∏ —Ä–∞–∑–æ–±—Ä–∞–ª –µ—â—ë –∫–∞–∫—É—é-—Ç–æ —á–∞—Å—Ç—å?

–û—Ç–≤–µ—Ç –ë
### üîç **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º**
–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∫–æ–¥ –ø–æ–¥—Ä–æ–±–Ω–æ. **–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**:
1. **–ù–µ—Ç –∑–≤—É–∫–∞** (–≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –≤ **guitar** –∏ –≤–æ–∑–º–æ–∂–Ω–æ **synth**):
   - **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥ –≤ guitar**: –≤—Å—è —Ü–µ–ø–æ—á–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (`.connect()`) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è **–≤–Ω—É—Ç—Ä–∏ `noteOn`**! –ü—Ä–∏ –∫–∞–∂–¥–æ–π –Ω–æ—Ç–µ –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è routing (pickupLPF.connect(hpf), postLPF.connect(cab), afterCab.connect(ph.input), ph.output.connect(dA.input) –∏ —Ç.–¥.). –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ **–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º** (multiple routing paths): —Å–∏–≥–Ω–∞–ª –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è/–º—É–ª—å—Ç–∏–ø–ª–∏—Ü–∏—Ä—É–µ—Ç—Å—è, –≥—Ä–∞—Ñ–∏–∫ WebAudio –ª–æ–º–∞–µ—Ç—Å—è, –∑–≤—É–∫ –∏—Å–∫–∞–∂–∞–µ—Ç—Å—è, —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ—É–ø—Ä–∞–≤–ª—è–µ–º—ã–º –∏–ª–∏ –ø—Ä–æ–ø–∞–¥–∞–µ—Ç (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –ø–æ–ª–∏—Ñ–æ–Ω–∏–∏ >1). –ü—Ä–∏ noteOff –Ω–µ —á–∏—Å—Ç–∏—Ç—Å—è ‚Äî –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è —Ö–∞–æ—Å.
   - **–í synth**: –µ—Å–ª–∏ `preset.osc` –ø—É—Å—Ç–æ–π/undefined (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `{}`), —Ç–æ `oscs = []` ‚Äî **–Ω–µ—Ç –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤, –∑–≤—É–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç**! –î–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤ –Ω–µ—Ç.
   - –û–±—â–µ–µ: –µ—Å–ª–∏ `preset.reverbMix` –Ω–∏–∑–∫–∏–π + `master.gain=0.8`, –∑–≤—É–∫ —Ç–∏—Ö–∏–π. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ IR/—Å—ç–º–ø–ª–æ–≤ (catch –ª–æ–≥–∏).

2. **–ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** (–≤ **synth** –∏ **guitar**):
   - **–í synth**: `compNode` —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å **—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏** (`threshold=-20` –∏ —Ç.–¥.). –ü—Ä–∏ `setPreset` –æ–Ω–∏ **–Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è**! –ï—Å–ª–∏ `preset.comp` –∑–∞–¥–∞–Ω, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.
   - **–í guitar**: –∏–∑-–∑–∞ –±–∞–≥–∞ —Å routing –≤ `noteOn` —Å–∏–≥–Ω–∞–ª –≤ `compNode` –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π/—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π), –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ.
   - –û–±—â–µ–µ: –µ—Å–ª–∏ –≤—Ö–æ–¥–Ω–æ–π —É—Ä–æ–≤–µ–Ω—å –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤ –Ω–∏–∑–∫–∏–π (`o.gain <0.3`), threshold –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç—Å—è ‚Äî –∫–æ–º–ø—Ä–µ—Å—Å–∏—è "–Ω–µ —Å–ª—ã—à–Ω–∞". –ù–µ—Ç makeup gain –ø–æ—Å–ª–µ –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–∞ –≤ synth.

–î—Ä—É–≥–∏–µ –º–µ–ª–∫–∏–µ –±–∞–≥–∏:
- –ù–µ—Ç `api.setPreset` –≤ **mellotron** –∏ **guitar** (—Ç–æ–ª—å–∫–æ –≤ organ/synth).
- –í **synth** `lfoGain.disconnect()` –º–æ–∂–µ—Ç –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞—Ç—å LFO (–ª—É—á—à–µ `gain.value=0`).
- –í **guitar** `guitarOutput` per note ‚Äî —É—Ç–µ—á–∫–∞ –Ω–æ–¥–æ–≤ (100 –Ω–æ—Ç = 100 gain to master).
- –ù–µ—Ç `api.setParam` –¥–ª—è –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–∞/—ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤ synth/guitar.
- –õ–æ–≥–∏ –≤ `noteOn` —Ç–æ–ª—å–∫–æ –¥–ª—è organ ‚Äî –¥–æ–±–∞–≤—å –¥–ª—è –≤—Å–µ—Ö.

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: 
- –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å: –ª–æ–≥–∏ `[Organ]` –∏–ª–∏ –æ—à–∏–±–∫–∏ fetch/decode.
- `api.noteOn(60)` ‚Äî –∑–≤—É–∫? `api.allNotesOff()`.
- AudioContext resumed? (`ctx.resume()`).
- –£—Ä–æ–≤–Ω–∏: –ø–æ–¥–∫–ª—é—á–∏ AnalyserNode –ø–æ—Å–ª–µ comp/master, —Å–º–æ—Ç—Ä–∏ waveform.

### üõ†Ô∏è **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ (–∫–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)**
–í–æ—Ç **–ø–æ–ª–Ω—ã–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –¥–ª—è guitar** (–æ—Å—Ç–∞–ª—å–Ω–æ–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ). –í—ã–Ω–æ—Å–∏ **routing –î–û `api.noteOn`** ‚Äî shared —Ü–µ–ø–æ—á–∫–∞. Voices sum –≤ `pickupLPF` (input).

```typescript
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GUITAR (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ + comp params update)
else if (type === 'guitar') {
  // ... (destructure preset –∫–∞–∫ –µ—Å—Ç—å)

  // –°–æ–∑–¥–∞—ë–º –Ω–æ–¥—ã (–∫–∞–∫ –µ—Å—Ç—å)
  const pickupLPF = ctx.createBiquadFilter(); /* ... */
  // ... –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–æ–¥—ã (compNode, shaper –∏ —Ç.–¥.)

  // ‚îÄ‚îÄ‚îÄ‚îÄ –ö–†–ò–¢–ò–ö–ê–õ–¨–ù–û: –ü–û–°–¢–†–û–ï–ù–ò–ï –§–ò–ö–°–ò–†–û–í–ê–ù–ù–û–ô –¶–ï–ü–û–ß–ö–ò –î–û noteOn ‚îÄ‚îÄ‚îÄ‚îÄ
  const guitarInput = ctx.createGain();  // Sum point –¥–ª—è –≤—Å–µ—Ö vGain (per note)
  guitarInput.connect(pickupLPF);

  pickupLPF.connect(hpf);
  hpf.connect(compNode);
  compNode.connect(compMakeup);
  compMakeup.connect(shaper);
  shaper.connect(postHPF);
  postHPF.connect(mid1);
  mid1.connect(mid2);
  mid2.connect(postLPF);

  // Cab
  if (cabinetIRUrl && cab.buffer) {
    postLPF.connect(cab);
    cab.connect(ph.input);
  } else {
    postLPF.connect(ph.input);
  }

  // Phaser -> Delays -> Final output (shared!)
  let currentChain: AudioNode = ph.output;
  if (dA) {
    currentChain.connect(dA.input);
    currentChain = dA.output;
  }
  if (dB_node) {
    currentChain.connect(dB_node.input);
    currentChain = dB_node.output;
  }

  const guitarOut = ctx.createGain();  // Shared output, –ù–ï per note!
  guitarOut.gain.value = 0.9;
  currentChain.connect(guitarOut);
  guitarOut.connect(master);
  guitarOut.connect(revSend);  // revSend —É–∂–µ connect(reverb)

  // ‚îÄ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ
  let activeVoices = new Map();  // –∫–∞–∫ –µ—Å—Ç—å

  api.noteOn = (midi, when = ctx.currentTime) => {
    console.log(`%c[Guitar] noteOn MIDI: ${midi}`, 'color: orange');  // –î–æ–±–∞–≤—å –ª–æ–≥
    const f = midiToHz(midi);
    const vGain = ctx.createGain(); vGain.gain.value = 0.0;

    // –û—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã (–∫–∞–∫ –µ—Å—Ç—å)
    const oscMain = createPulseOsc(ctx, f, osc.width);
    // ... oscDet, oscSub, gMain etc.
    const sum = ctx.createGain(); sum.gain.value = 0.8;
    oscMain.connect(gMain).connect(sum);
    // ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
    sum.connect(vGain);

    // ‚îÄ‚îÄ‚îÄ‚îÄ –ö–†–ò–¢–ò–ö–ê–õ–¨–ù–û: –¢–û–õ–¨–ö–û –≠–¢–û! vGain -> shared input ‚îÄ‚îÄ‚îÄ‚îÄ
    vGain.connect(guitarInput);  // Sum –≤ —Ü–µ–ø–æ—á–∫—É

    oscMain.start(when); oscDet.start(when); oscSub.start(when);

    // ADSR (–∫–∞–∫ –µ—Å—Ç—å)
    vGain.gain.cancelScheduledValues(when);
    vGain.gain.linearRampToValueAtTime(1.0, when + adsr.a);
    vGain.gain.setTargetAtTime(adsr.s, when + adsr.a, adsr.d / 3);

    activeVoices.set(midi, { oscMain, oscDet, oscSub, vGain });
  };

  api.noteOff = /* –∫–∞–∫ –µ—Å—Ç—å, –±–µ–∑ connect/disconnect */;

  // ‚îÄ‚îÄ‚îÄ‚îÄ –î–æ–±–∞–≤—å setPreset –∏ setParam –¥–ª—è comp/drive ‚îÄ‚îÄ‚îÄ‚îÄ
  api.setPreset = (p: any) => {
    console.log('[Guitar] setPreset:', p);
    api.allNotesOff();
    api.preset = p;
    // –û–±–Ω–æ–≤–∏ comp (–¥–æ–±–∞–≤—å!)
    if (p.comp) {
      compNode.threshold.value = p.comp.threshold ?? comp.threshold;
      compNode.ratio.value = p.comp.ratio ?? comp.ratio;
      compNode.attack.value = p.comp.attack ?? comp.attack;
      compNode.release.value = p.comp.release ?? comp.release;
      compMakeup.gain.value = dB(p.comp.makeup ?? comp.makeup);
    }
    // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö: pickup.cutoff etc.
    pickupLPF.frequency.value = p.pickup?.cutoff ?? pickup.cutoff;
    // drive: shaper.curve = ...
    if (p.drive) shaper.curve = (p.drive.type === 'muff') ? makeMuff(p.drive.amount) : makeSoftClip(p.drive.amount);
  };

  api.setParam = (k: string, v: any) => {
    // –†–∞—Å—à–∏—Ä—å
    if (k === 'comp.threshold') compNode.threshold.value = v;
    if (k === 'comp.ratio') compNode.ratio.value = v;
    // ... attack/release
    if (k === 'drive') shaper.curve = (drive.type === 'muff') ? makeMuff(v) : makeSoftClip(v);
    // –∫–∞–∫ —Ä–∞–Ω—å—à–µ
  };

  api.allNotesOff = /* –∫–∞–∫ –µ—Å—Ç—å */;
}
```

### üîß **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è SYNTH (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)**
```typescript
// –í synth –±–ª–æ–∫–µ, –≤ updateNodesFromPreset –¥–æ–±–∞–≤—å comp:
if (p.comp) {
  compNode.threshold.value = p.comp.threshold ?? -20;
  compNode.knee.value = p.comp.knee ?? 10;
  compNode.ratio.value = p.comp.ratio ?? 12;
  compNode.attack.value = p.comp.attack ?? 0.005;
  compNode.release.value = p.comp.release ?? 0.1;
}

// –î–µ—Ñ–æ–ª—Ç osc –µ—Å–ª–∏ –ø—É—Å—Ç–æ (–≤ –Ω–∞—á–∞–ª–µ synth –∏–ª–∏ setPreset):
if (!currentPreset.osc || currentPreset.osc.length === 0) {
  currentPreset.osc = [
    { type: 'sawtooth' as const, gain: 0.45, octave: 0, detune: 0 },
    { type: 'square' as const, gain: 0.25, octave: -1, detune: 0 }
  ];
}

// –î–æ–±–∞–≤—å –ª–æ–≥ –≤ noteOn:
console.log(`%c[Synth] noteOn MIDI: ${midi}, oscs: ${oscs.length}`, 'color: lightgreen');
```

### ‚úÖ **–ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã/—É–ª—É—á—à–µ–Ω–∏—è**
1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å guitar —Ñ–∏–∫—Å** ‚Äî –∑–≤—É–∫ + –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä –∑–∞—Ä–∞–±–æ—Ç–∞—é—Ç (—á–∏—Å—Ç—ã–π routing).
2. **–î–ª—è synth**: –ø–µ—Ä–µ–¥–∞–π preset —Å `osc: [{type:'sawtooth', gain:0.5}]` –∏ `comp: {threshold:-24, ratio:15}`.
3. **–ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä visible**: –î–æ–±–∞–≤—å `const analyser = ctx.createAnalyser(); compNode.connect(analyser);` ‚Äî —Å–º–æ—Ç—Ä–∏ reduction –≤ `analyser.getFloatFrequencyData()`.
4. **–û–±—â–∏–π gain boost**: `finalChain.gain.value = 1.2;` (synth/guitar).
5. **Polyphony limit**: –í noteOn if(activeVoices.size > 16) allNotesOff().
6. **–î–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤**: –î–æ–±–∞–≤—å `api.setPreset` –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ.

–ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π `api.noteOn(60); setTimeout(()=>api.noteOff(60), 1000)`. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ ‚Äî —Å–∫–∏–Ω—å **preset** –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—à—å + —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ + –∫–æ–Ω—Å–æ–ª—å –æ—à–∏–±–∫–∏. –ó–≤—É–∫ –±—É–¥–µ—Ç! üé∏

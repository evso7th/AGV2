# Спецификация кодовой базы: AuraGroove (Версия 2.0 - Исправленная)

**Версия документа:** 2.0
**Дата создания:** 2024-07-26

**Примечание:** Эта версия полностью заменяет предыдущие анализы, которые содержали неверные и поверхностные выводы. Данный документ отражает истинную, гетерогенную (смешанную) архитектуру аудио-движка проекта.

## 1. Обзор высокого уровня

### 1.1. Концепция проекта

**AuraGroove** — это веб-приложение для генеративной музыки, которое создает уникальные музыкальные ландшафты в реальном времени. Его ключевая особенность — чрезвычайно производительный аудио-движок, спроектированный для плавной работы даже на маломощных устройствах, включая мобильные телефоны.

### 1.2. Технологический стек и архитектура аудио-движка

Проект использует сложную **гетерогенную (смешанную) модель синтеза звука**, где для каждой задачи подобран наиболее эффективный инструмент:

- **Мастер-таймер (Метроном): `Tone.js`**
  - **Роль:** Исключительно для тайминга. `Tone.Transport` используется как высокоточный, синхронизирующий "пульс" всего приложения.
  - **Важно:** `Tone.js` **не используется** для генерации звука тональных инструментов (мелодии, баса, аккомпанемента).

- **Тональные инструменты (Мелодия и Аккомпанемент): Нативный Web Audio API**
  - **Файлы:** `src/lib/melody-synth-manager.ts`, `src/lib/accompaniment-synth-manager.ts`
  - **Архитектура:** Это полностью кастомные полифонические синтезаторы, написанные с нуля с использованием базовых узлов Web Audio API (`AudioContext`, `OscillatorNode`, `GainNode` и т.д.). Этот подход обеспечивает максимальную производительность и минимальные накладные расходы, так как не зависит от внешних библиотек и воркеров.

- **Басовый инструмент: `AudioWorklet`**
  - **Файлы:** `src/lib/bass-synth-manager.ts` (менеджер) и `src/lib/synthesis/bass-processor.ts` (процессор).
  - **Архитектура:** Менеджер в основном потоке выступает мостом к кастомному `AudioWorkletProcessor`, который выполняется в отдельном высокоприоритетном потоке. Это позволяет реализовать сложный низкоуровневый синтез, не рискуя заблокировать основной поток.

- **Ударные и Семплы: `Tone.Sampler` / Нативные семплеры**
  - **Файл:** `src/lib/drum-machine.ts`
  - **Архитектура:** Воспроизведение предварительно записанных аудиофайлов. Это легковесная операция, которая эффективно решается стандартными семплерами.

### 1.3. Схема композиции: Композитор и Блюпринты

Приложение работает на двухуровневой системе логики:
1.  **Нижний слой (Исполнители):** Описанный выше гетерогенный движок, который умеет генерировать звук.
2.  **Верхний слой (Композитор):** Интеллектуальная система, которая решает, *что именно* играть. Эта система состоит из `FractalMusicEngine` и "Блюпринтов".

---

## 2. Логика композиции: от идеи до звука

### 2.1. Шаг 1: Генерация партитуры ("Композитор")

Партитура не загружается, а генерируется в реальном времени, такт за тактом, внутри `FractalMusicEngine`.

1.  `Tone.Transport` выдает "тик" в начале каждого такта.
2.  `FractalMusicEngine` "просыпается" и смотрит на правила, заданные в текущем активном **Блюпринте**.
3.  На основе этих правил (гамма, аккорд, плотность нот, случайность) он генерирует массив `FractalEvent` — это и есть партитура на один такт.
4.  Каждое событие `FractalEvent` содержит поле `instrument`, которое четко указывает, кто должен его сыграть (`'melody'`, `'bass'` и т.д.).

### 2.2. Шаг 2: Раскладка по инструментам ("Дирижер")

`FractalMusicEngine` действует как дирижер:
1.  Он проходит по сгенерированной партитуре.
2.  Читает поле `event.instrument`.
3.  Отправляет событие соответствующему менеджеру-исполнителю (`MelodySynthManager.schedule(event)`, `BassSynthManager.schedule(event)`).

### 2.3. Шаг 3: Управление жанром и настроением (Блюпринты)

**Блюпринты** (вероятно, в `src/lib/blueprints.ts`) — это ядро творческого контроля. Они задают "рамки жанра и настроения", внутри которых "Композитор" может импровизировать.

Типичный блюпринт ограничивает следующие аспекты:
- **Гармония (Настроение):**
  - `scale`: Музыкальная гамма (например, минор для грусти).
  - `chordProgression`: Последовательность аккордов, задающая гармоническое развитие.
- **Тембр (Палитра жанра):**
  - `instruments`: Словарь, указывающий, какой пресет (`synth-presets.ts`) использовать для каждого инструмента.
- **Ритм и структура (Грув жанра):**
  - `tempo`: Темп музыки.
  - `fractal_rules`: Набор правил для генератора (плотность нот, диапазон октав, случайность), который напрямую формирует характер композиции.

---

## 3. Детальный разбор Исполнителей (Аудиографы)

### 3.1. `AccompanimentSynthManager` (Нативный синтезатор)

Это полифонический синтезатор, построенный с нуля на нативных узлах Web Audio API.

**Аудиограф одного голоса (`SynthVoice`):**
```
                               +------------------+
                               | chorusLfo (Osc)  | -> Gain -> chorusDelay.delayTime
                               +------------------+

+----------------+     +--------------+     +----------------+  +---------------------+
|  soundSources  | --> | filter       | --> |    envGain     |->| chorusDelay (Delay) |
| (Osc/Buffer)   |     | (BiquadFilt) |     | (ADSR Control) |  +---------------------+
+----------------+     +--------------+     +----------------+      |
                               |                   (Wet)            |
                               v                                    v
(Dry) ------------------> +---------+      (Wet) ------------> +-----------+
                          | dryGain |                          |  wetGain  |
                          +---------+                          +-----------+
                              |                                      |
                              |              +----------------+      |
                              +------------> | delay (Delay)  | <----+
                                             +----------------+
                                                   |
(Feedback Loop) <----------------------------------+----------------> (feedbackGain)
                                                   |
                                                   v
                                             +--------------+
                                             | panner       | --> destination
                                             | (StereoPan)  |
                                             +--------------+
```
- **Синтез:** `soundSources` (`OscillatorNode` или `AudioBufferSourceNode`) генерируют базовый звук.
- **Огибающая:** `envGain` (`GainNode`) вручную формирует ADSR-огибающую через `linearRampToValueAtTime`, что является ключевым для производительности.
- **Эффекты:** Имеет полные, самостоятельно реализованные цепи для эффектов **Chorus** и **Delay** с обратной связью.

### 3.2. `MelodySynthManager` (Продвинутый нативный синтезатор)

Использует ту же архитектуру, что и `AccompanimentSynthManager`, но с двумя ключевыми улучшениями, которые делают его "солистом":

1.  **Многослойность (`preset.layers`):** Каждая нота может состоять из нескольких источников звука (осцилляторов, шума), каждый со своим тембром, громкостью и настройкой. Это позволяет создавать очень богатые и сложные звуки.
2.  **LFO для модуляции высоты тона (Вибрато):** Может использовать дополнительный LFO для модуляции параметра `.detune` у осцилляторов, что делает звук "живым" и выразительным.

### 3.3. `BassSynthManager` (Менеджер для AudioWorklet)

Это не синтезатор, а **мост-контроллер**.
- **Архитектура:** Создает `Tone.AudioWorkletNode` и загружает в него скомпилированный процессор `bass-processor.js`.
- **Управление:** Вместо генерации звука, он общается с процессором через `this.instrument.port.postMessage()`, отправляя команды (`'NOTE_ON'`, `'SET_PRESET'`) и данные (частота, параметры пресета). Вся работа по генерации звука происходит в отдельном потоке.

## 4. Итоговый вывод

**AuraGroove** — это пример высокооптимизированного веб-аудио приложения. Его архитектура сознательно избегает "универсальных" решений в пользу **гетерогенного подхода**, выбирая для каждой задачи наиболее подходящую технологию. Отказ от тяжелых библиотек для синтеза в пользу нативного Web Audio API для мелодии и аккомпанемента является ключом к его производительности на любых устройствах. Логика композиции, отделенная от механики синтеза и управляемая гибкой системой "Блюпринтов", позволяет легко расширять музыкальные возможности проекта.

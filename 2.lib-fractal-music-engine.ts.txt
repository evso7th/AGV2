–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: duration –≤ –¥–æ–ª—è—Ö —Ç–∞–∫—Ç–∞ (–Ω–µ —Å–µ–∫—É–Ω–¥–∞—Ö!)
–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Å–æ–Ω–æ–≤ —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ –¥–æ–ª—è—Ö —Ç–∞–∫—Ç–∞, –∞ –ø–µ—Ä–µ–≤–æ–¥ –≤ —Å–µ–∫—É–Ω–¥—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –≤ generateOneBar(), –≥–¥–µ –∏–∑–≤–µ—Å—Ç–µ–Ω tempo.

üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–∞—è —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ seededRandom
–í–µ—Å—å DLA-–∫–æ–¥ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω—Å—Ç–∞–Ω—Å random, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∏–∑ seed, –∞ –Ω–µ Math.random().

–í–æ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–∞—è, –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ —Ü–µ–ª–æ—Å—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è lib/fractal-music-engine.ts, –≤ –∫–æ—Ç–æ—Ä–æ–π:

 –≠—Ç–∞–ø 2: fractal-music-engine.ts ‚Äî —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞
‚úÖ –¶–µ–ª—å
–ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —É–¥–∞—Ä–Ω—ã–µ –≤ –ø–æ–ª–Ω–æ–ø—Ä–∞–≤–Ω—É—é –≤–µ—Ç–≤—å —Å–æ–∑–Ω–∞–Ω–∏—è, —É—á–∞—Å—Ç–≤—É—é—â—É—é –≤ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º –æ—Ç–±–æ—Ä–µ, –¥–∏–∞–ª–æ–≥–µ —Å –±–∞—Å–æ–º –∏ –¥—Ä–∞–º–∞—Ç—É—Ä–≥–∏—á–µ—Å–∫–æ–º —Ä–∞–∑–≤–∏—Ç–∏–∏.

‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
–î–≤–∞ –∞–∫—Å–æ–Ω–∞: bass_axon, drum_axon,
–û–±—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Å–æ–≤ —á–µ—Ä–µ–∑ K_ij,
DLA-–≤–µ—Ç–≤–∏: ghost notes, tom fills –∫–∞–∂–¥—ã–µ 8 —Ç–∞–∫—Ç–æ–≤,
–ó–∞—â–∏—Ç–∞ –æ—Ç NaN, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ—Å–æ–≤,
–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å FractalEvent –∏ resonance-matrices.ts.






import type { FractalEvent, Mood, Genre, Technique } from '@/types/fractal';
import { MelancholicMinorK } from './resonance-matrices';

export type Branch = {
  id: string;
  events: FractalEvent[];
  weight: number;
  age: number;
  technique: Technique;
  type: 'bass' | 'drums';
};

interface EngineConfig {
  mood: Mood;
  genre: Genre;
  tempo: number;
  seed?: number;
}

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
function seededRandom(seed: number) {
  let state = seed;
  const self = {
    next: () => {
      state = (state * 1664525 + 1013904223) % Math.pow(2, 32);
      return state / Math.pow(2, 32);
    },
    nextInt: (max: number) => Math.floor(self.next() * max)
  };
  return self;
}

function getScaleForMood(mood: Mood): number[] {
  const E2 = 40;
  if (mood === 'melancholic') return [E2, E2+2, E2+3, E2+5, E2+7, E2+9, E2+10];
  return [E2, E2+2, E2+4, E2+5, E2+7, E2+9, E2+11];
}

function weightToDynamics(weight: number): 'p' | 'mf' | 'f' {
  if (weight < 0.3) return 'p';
  if (weight < 0.7) return 'mf';
  return 'f';
}

function safeTime(value: number, fallback: number = 0): number {
  return isFinite(value) ? value : fallback;
}

// === –£–î–ê–†–ù–´–ô –ê–ö–°–û–ù (duration –≤ –î–û–õ–Ø–• –¢–ê–ö–¢–ê!) ===
function createDrumAxiom(): FractalEvent[] {
  return [
    { type: 'drum_kick', note: 36, duration: 0.25, time: 0, weight: 1.0, technique: 'hit', dynamics: 'f', phrasing: 'staccato' },
    { type: 'drum_snare', note: 38, duration: 0.25, time: 1.0, weight: 1.0, technique: 'hit', dynamics: 'mf', phrasing: 'staccato' },
    { type: 'drum_kick', note: 36, duration: 0.25, time: 2.0, weight: 1.0, technique: 'hit', dynamics: 'f', phrasing: 'staccato' },
    { type: 'drum_snare', note: 38, duration: 0.25, time: 3.0, weight: 1.0, technique: 'hit', dynamics: 'mf', phrasing: 'staccato' },
    // Hi-hat closed ‚Äî 8 —Ä–∞–∑ –∑–∞ —Ç–∞–∫—Ç (–≤–æ—Å—å–º—ã–µ = 0.5 –¥–æ–ª–∏)
    ...Array.from({ length: 8 }, (_, i) => ({
      type: 'drum_hihat_closed' as const,
      note: 42,
      duration: 0.5, // –≤–æ—Å—å–º–∞—è –Ω–æ—Ç–∞ = 0.5 –¥–æ–ª–∏ —Ç–∞–∫—Ç–∞
      time: i * 0.5,
      weight: 0.8,
      technique: 'hit' as Technique,
      dynamics: 'p' as const,
      phrasing: 'staccato' as const
    }))
  ];
}

// === –ë–ê–°–û–í–´–ô –ê–ö–°–û–ù (duration –≤ –î–û–õ–Ø–• –¢–ê–ö–¢–ê!) ===
function createBassAxiom(mood: Mood): FractalEvent[] {
  const scale = getScaleForMood(mood);
  const root = scale[0];
  return [
    { type: 'bass', note: root, duration: 1.5, time: 0, weight: 1.0, technique: 'pluck', dynamics: 'mf', phrasing: 'staccato' },
    { type: 'bass', note: root + 3, duration: 0.5, time: 1.5, weight: 1.0, technique: 'pluck', dynamics: 'mf', phrasing: 'staccato' },
    { type: 'bass', note: root + 2, duration: 1.5, time: 2.0, weight: 1.0, technique: 'pluck', dynamics: 'mf', phrasing: 'staccato' },
    { type: 'bass', note: root, duration: 0.5, time: 3.5, weight: 1.0, technique: 'pluck', dynamics: 'mf', phrasing: 'staccato' }
  ];
}

// === –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–ò –£–î–ê–†–ù–´–• (duration –≤ –î–û–õ–Ø–• –¢–ê–ö–¢–ê!) ===
function createTomFill(): FractalEvent[] {
  return [
    { type: 'drum_tom_low', note: 41, duration: 0.25, time: 3.0, weight: 0.9, technique: 'hit', dynamics: 'mf', phrasing: 'staccato' },
    { type: 'drum_tom_mid', note: 45, duration: 0.25, time: 3.25, weight: 0.9, technique: 'hit', dynamics: 'mf', phrasing: 'staccato' },
    { type: 'drum_tom_high', note: 50, duration: 0.25, time: 3.5, weight: 0.9, technique: 'hit', dynamics: 'mf', phrasing: 'staccato' },
    { type: 'drum_snare', note: 38, duration: 0.25, time: 3.75, weight: 1.0, technique: 'hit', dynamics: 'f', phrasing: 'staccato' }
  ];
}

// === –û–°–ù–û–í–ù–û–ô –ö–õ–ê–°–° ===
export class FractalMusicEngine {
  private config: EngineConfig;
  private branches: Branch[] = [];
  private time: number = 0;
  private lambda: number;
  private epoch = 0;
  private random: { next: () => number; nextInt: (max: number) => number };

  constructor(config: EngineConfig) {
    if (!config || config.tempo <= 0 || !isFinite(config.tempo)) {
      console.warn('[FractalEngine] Invalid tempo, defaulting to 120');
      config = { ...config, tempo: 120 };
    }
    this.config = {
      ...config,
      tempo: Math.max(20, Math.min(300, config.tempo))
    };
    this.lambda = config.mood === 'melancholic' ? 0.25 : 0.15;
    this.random = seededRandom(config.seed ?? Date.now());
    this.initialize();
  }

  private initialize() {
    // –ë–ê–°–û–í–´–ô –ê–ö–°–û–ù
    const bassAxiom = createBassAxiom(this.config.mood);
    this.branches.push({
      id: 'bass_axon',
      events: bassAxiom,
      weight: 0.9,
      age: 0,
      technique: 'pluck',
      type: 'bass'
    });

    // –£–î–ê–†–ù–´–ô –ê–ö–°–û–ù
    const drumAxiom = createDrumAxiom();
    this.branches.push({
      id: 'drum_axon',
      events: drumAxiom,
      weight: 0.8,
      age: 0,
      technique: 'hit',
      type: 'drums'
    });
  }

  // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–û–ë–´–¢–ò–ô –ù–ê 1 –¢–ê–ö–¢ ===
  private generateOneBar(): FractalEvent[] {
    const output: FractalEvent[] = [];
    let currentTime = this.time;
    const beatDuration = 60 / this.config.tempo; // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ–ª–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –≤–µ—Ç–≤–µ–π
    this.branches.forEach(branch => {
      branch.events.forEach(event => {
        // –ü–ï–†–ï–í–û–î duration –∏–∑ –¥–æ–ª–µ–π —Ç–∞–∫—Ç–∞ –≤ —Å–µ–∫—É–Ω–¥—ã
        const durationInSeconds = event.duration * beatDuration;
        output.push({
          ...event,
          time: currentTime + event.time * beatDuration, // time —Ç–æ–∂–µ –≤ –¥–æ–ª—è—Ö ‚Üí –≤ —Å–µ–∫—É–Ω–¥—ã
          duration: durationInSeconds
        });
      });
    });

    // DLA: –Ω–æ–≤—ã–µ –≤–µ—Ç–≤–∏ (–∫–∞–∂–¥—ã–µ 4 —Ç–∞–∫—Ç–∞) ‚Äî —Å –í–û–°–ü–†–û–ò–ó–í–û–î–ò–ú–´–ú random!
    if (this.epoch % 4 === 0 && this.random.next() < 0.4) {
      if (this.random.next() > 0.5 && this.branches.filter(b => b.type === 'bass').length < 3) {
        const base = this.branches.find(b => b.type === 'bass');
        if (base) {
          this.branches.push({
            id: `bass_ghost_${Date.now()}`,
            events: [{ ...base.events[1], duration: 0.2, time: 1.5 }],
            weight: 0.15,
            age: 0,
            technique: 'ghost',
            type: 'bass'
          });
        }
      } else if (this.branches.filter(b => b.type === 'drums').length < 3) {
        this.branches.push({
          id: `drum_fill_${Date.now()}`,
          events: createTomFill(),
          weight: 0.2,
          age: 0,
          technique: 'hit',
          type: 'drums'
        });
      }
    }

    return output;
  }

  // === –û–°–ù–û–í–ù–û–ô –ú–ï–¢–û–î ===
  public evolve(): FractalEvent[] {
    if (!isFinite(this.time)) this.time = 0;
    const delta = this.getDeltaProfile()(this.time);
    const barDuration = 4 * (60 / this.config.tempo);
    if (!isFinite(barDuration)) return [];

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Å–æ–≤
    this.branches = this.branches.map(branch => {
      const resonanceSum = this.branches.reduce((sum, other) => {
        if (other.id === branch.id) return sum;
        const k = MelancholicMinorK(
          branch.events[0],
          other.events[0],
          { mood: this.config.mood, tempo: this.config.tempo, delta }
        );
        return sum + k * delta;
      }, 0);
      const newWeight = (1 - this.lambda) * branch.weight + resonanceSum;
      return { ...branch, weight: isFinite(newWeight) ? newWeight : 0.01, age: branch.age + 1 };
    });

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
    const totalWeight = this.branches.reduce((sum, b) => sum + b.weight, 0);
    if (totalWeight > 0 && isFinite(totalWeight)) {
      this.branches.forEach(b => b.weight = isFinite(b.weight) ? b.weight / totalWeight : 0.01);
    }

    // –°–º–µ—Ä—Ç—å —Å–ª–∞–±—ã—Ö –≤–µ—Ç–≤–µ–π
    this.branches = this.branches.filter(b => b.weight > 0.05);

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
    const events = this.generateOneBar();

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    this.time += barDuration;
    this.epoch++;
    return events;
  }

  private getDeltaProfile(): (t: number) => number {
    return (t: number) => {
      const safeT = safeTime(t);
      const phase = (safeT / 120) % 1;
      if (this.config.mood === 'melancholic') {
        if (phase < 0.4) return 0.3 + phase * 1.5;
        if (phase < 0.7) return 1.0;
        return 1.0 - (phase - 0.7) * 2.3;
      }
      return 0.5;
    };
  }
}

–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
–ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ evolve() = 1 —Ç–∞–∫—Ç –º—É–∑—ã–∫–∏,
–£–¥–∞—Ä–Ω—ã–µ ‚Äî –Ω–µ —Ñ–æ–Ω, –∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –≤–µ—Ç–≤—å,
Ghost notes, fills, –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–∏ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç DLA-–≤–µ—Ç–≤–ª–µ–Ω–∏—è,
–†–µ–∑–æ–Ω–∞–Ω—Å K_ij —É–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∏–∞–ª–æ–≥–æ–º –±–∞—Å–∞ –∏ —É–¥–∞—Ä–Ω—ã—Ö,
–°—ç–º–ø–ª–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º time, note, dynamics.

–ü—Ä–æ–≤–µ—Ä–∫–∞ (—á–µ–∫-–ª–∏—Å—Ç –≠—Ç–∞–ø–∞ 2)
–í initialize() —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–≤–µ –≤–µ—Ç–≤–∏: bass_axon, drum_axon.
–í evolve() –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤–µ—Å–∞ –≤—Å–µ—Ö –≤–µ—Ç–≤–µ–π —á–µ—Ä–µ–∑ resonance-matrices.ts.
–ö–∞–∂–¥—ã–µ 4 —Ç–∞–∫—Ç–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –≤–µ—Ç–≤–∏ (ghost notes, tom fills).
–í–µ—Å–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –Ω–µ —Ä–∞—Å—Ç—É—Ç –¥–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏.
–ù–µ—Ç NaN –≤ time –∏–ª–∏ weight.
üìä –û—Ü–µ–Ω–∫–∞
–£–¥–∞—Ä–Ω—ã–µ ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –≤–µ—Ç–≤—å —Å –≤–µ—Å–æ–º, –≤–æ–∑—Ä–∞—Å—Ç–æ–º, —Ç–∏–ø–æ–º
–í–µ—Å–∞ –Ω–µ —Ä–∞—Å—Ç—É—Ç –¥–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏
–ü–æ—è–≤–ª—è—é—Ç—Å—è fills –∫–∞–∂–¥—ã–µ 8 —Ç–∞–∫—Ç–æ–≤

—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
duration –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
–¢–µ–ø–µ—Ä—å
–≤—Å–µ –∞–∫—Å–æ–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç duration –≤ –¥–æ–ª—è—Ö —Ç–∞–∫—Ç–∞
(0.25, 0.5, 1.5). –ü–µ—Ä–µ–≤–æ–¥ –≤ —Å–µ–∫—É–Ω–¥—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
—Ç–æ–ª—å–∫–æ –≤ generateOneBar()
—á–µ—Ä–µ–∑
beatDuration = 60 / tempo
.
Math.random()
–ó–∞–º–µ–Ω—ë–Ω –Ω–∞
this.random.next()
, –∫–æ—Ç–æ—Ä—ã–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏–∑
seed
. –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Å —Ç–µ–º –∂–µ
seed
–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ
.
–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
–õ–æ–≥–∏–∫–∞ –≤–µ—Ç–≤–ª–µ–Ω–∏—è ‚Äî
–∫–∞–∂–¥—ã–µ 4 —Ç–∞–∫—Ç–∞
, –∫–∞–∫ –≤ –∫–æ–¥–µ. (–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∫–∞–∂–¥—ã–µ 8 ‚Äî –ø–æ–º–µ–Ω—è–µ–º
this.epoch % 8 === 7
).

–¢–µ–ø–µ—Ä—å –∫–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

–¢–∏–ø–æ–≤–æ–º—É –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É (FractalEvent.duration ‚Äî –≤ –¥–æ–ª—è—Ö —Ç–∞–∫—Ç–∞),
–ü—Ä–∏–Ω—Ü–∏–ø—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏ (—á–µ—Ä–µ–∑ seed),
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–π —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã.

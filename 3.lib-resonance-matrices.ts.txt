–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π resonance-matrices.ts
üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: time —É–∂–µ –≤ –¥–æ–ª—è—Ö —Ç–∞–∫—Ç–∞ ‚Äî –Ω–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º!
‚Üí –£–±–∏—Ä–∞–µ–º –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ (60 / tempo).

üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–∞ —Å–æ–±—ã—Ç–∏–π –º–µ–∂–¥—É —Å–æ–±–æ–π
‚Üí –†–µ–∑–æ–Ω–∞–Ω—Å –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏—è —Å–æ–≤–ø–∞–¥–∞—é—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ–ª–∏).

üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–∞–º–º–∞ –∏–∑ getScaleForMood
‚Üí –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º getScaleForMood –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é –≥–∞–º–º—É.




–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≠—Ç–∞–ø—É 3: resonance-matrices.ts ‚Äî –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –≤–∫—É—Å.

–ù–æ —Å —É—á—ë—Ç–æ–º –≤–∞—à–∏—Ö –∑–∞–º–µ—á–∞–Ω–∏–π –ø–æ –≠—Ç–∞–ø—É 2, —è –≤–Ω–µ—Å—É –¥–≤–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É–ª—É—á—à–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Ä–µ–∑–æ–Ω–∞–Ω—Å–∞:

duration –∏ time –≤ —Å–æ–±—ã—Ç–∏—è—Ö ‚Äî –≤ –¥–æ–ª—è—Ö —Ç–∞–∫—Ç–∞,
‚Üí –ø–æ—ç—Ç–æ–º—É –≤—Å–µ —Ä–∞—Å—á—ë—Ç—ã —Ä–∏—Ç–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–æ–Ω–∞–Ω—Å–∞ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å tempo –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ —Å–µ–∫—É–Ω–¥—ã.
–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å:
‚Üí —Ä–µ–∑–æ–Ω–∞–Ω—Å –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç Math.random(), —Ç–æ–ª—å–∫–æ –æ—Ç event.time, event.type, context.
–≠—Ç–∞–ø 3: resonance-matrices.ts ‚Äî –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –≤–∫—É—Å
‚úÖ –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∑–æ–Ω–∞–Ω—Å–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É, –∫–æ—Ç–æ—Ä–∞—è:

–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ—Å—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –±–∞—Å–∞ –∏ —É–¥–∞—Ä–Ω—ã—Ö,
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç tempo –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ –¥–æ–ª–µ–π,
–ü–æ–ª–Ω–æ—Å—Ç—å—é –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∞ (–≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–∞ –ø—Ä–∏ —Ç–æ–º –∂–µ seed),
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–∑ InstrumentType.



–≠—Ç–∞–ø 3: resonance-matrices.ts ‚Äî –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –≤–∫—É—Å
‚úÖ –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∑–æ–Ω–∞–Ω—Å–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É, –∫–æ—Ç–æ—Ä–∞—è –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ—Å—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –±–∞—Å–∞ –∏ —É–¥–∞—Ä–Ω—ã—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ:

–¢–µ–æ—Ä–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –≥–∞—Ä–º–æ–Ω–∏–∏ (–†–∏–º—Å–∫–∏–π-–ö–æ—Ä—Å–∞–∫–æ–≤, –ß–∞–π–∫–æ–≤—Å–∫–∏–π),
–ü—Ä–∞–∫—Ç–∏–∫–∏ –≥—Ä—É–≤–∞ (Ed Friedland, –ì—É—Ä—É–ª–µ–≤),
–§—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏ (–≤–µ—Å–∞, Œ¥(t), –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–±–æ—Ä).
‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
–®—Ç—Ä–∞—Ñ –∑–∞ –±–∞—Å + snare –Ω–∞ –æ–¥–Ω–æ–π –¥–æ–ª–µ ‚Üí K = 0.1,
–ü–æ–æ—â—Ä–µ–Ω–∏–µ –∑–∞ kick + –±–∞—Å –Ω–∞ 1/3 ‚Üí K = 1.0,
Ghost notes –≤ —Å–ª–∞–±—ã—Ö –¥–æ–ª—è—Ö ‚Üí K = 0.9,
Crash –≤–Ω–µ –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–∏ ‚Üí K = 0.05,
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ InstrumentType.

–∫–æ–¥:

import type { FractalEvent, ResonanceMatrix } from '@/types/fractal';
import { getScaleForMood } from './fractal-music-engine'; // ‚Üê –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–∞–º–º–∞

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
function getBeat(timeInBeats: number): number {
  return Math.floor(timeInBeats) % 4; // 0, 1, 2, 3
}

function isOnStrongBeat(timeInBeats: number): boolean {
  const beat = getBeat(timeInBeats);
  return beat === 0 || beat === 2; // 1 –∏ 3
}

function isOnSnareBeat(timeInBeats: number): boolean {
  const beat = getBeat(timeInBeats);
  return beat === 1 || beat === 3; // 2 –∏ 4
}

function isGhostNote(event: FractalEvent): boolean {
  return event.technique === 'ghost' || event.dynamics === 'p';
}

function isKick(event: FractalEvent): boolean {
  return event.type === 'drum_kick';
}

function isSnare(event: FractalEvent): boolean {
  return event.type === 'drum_snare';
}

function isBass(event: FractalEvent): boolean {
  return event.type === 'bass';
}

function isCrash(event: FractalEvent): boolean {
  return event.type === 'drum_crash';
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ–≤–ø–∞–¥–∞—é—Ç –ª–∏ –≤—Ä–µ–º–µ–Ω–∞ —Å–æ–±—ã—Ç–∏–π (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ–ª–∏)
function areSimultaneous(timeA: number, timeB: number): boolean {
  return Math.abs(timeA - timeB) < 0.01;
}

// === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ï–ó–û–ù–ê–ù–°–ê ===
export const MelancholicMinorK: ResonanceMatrix = (
  eventA: FractalEvent,
  eventB: FractalEvent,
  context: { mood: string; tempo: number; delta: number }
): number => {
  const { mood } = context;

  // –†–µ–∑–æ–Ω–∞–Ω—Å –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏—è –∑–≤—É—á–∞—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
  if (!areSimultaneous(eventA.time, eventB.time)) {
    return 0.5; // –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–µ–∑–æ–Ω–∞–Ω—Å –¥–ª—è –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
  }

  const timeInBeats = eventA.time; // ‚Üê –£–ñ–ï –≤ –¥–æ–ª—è—Ö —Ç–∞–∫—Ç–∞!

  // === 1. –ë–ê–° + –£–î–ê–†–ù–´–ï ===
  if (isBass(eventA) && isKick(eventB)) {
    return isOnStrongBeat(timeInBeats) ? 1.0 : 0.3;
  }

  if (isBass(eventA) && isSnare(eventB)) {
    return isOnSnareBeat(timeInBeats) ? 0.1 : 0.8;
  }

  if (isKick(eventA) && isBass(eventB)) {
    return isOnStrongBeat(timeInBeats) ? 1.0 : 0.3;
  }

  if (isSnare(eventA) && isBass(eventB)) {
    return isOnSnareBeat(timeInBeats) ? 0.1 : 0.8;
  }

  // === 2. –£–î–ê–†–ù–´–ï ‚Üî –£–î–ê–†–ù–´–ï ===
  if (isKick(eventA) && isSnare(eventB)) {
    const kickOnStrong = isOnStrongBeat(timeInBeats);
    const snareOnWeak = isOnSnareBeat(timeInBeats);
    return kickOnStrong && snareOnWeak ? 0.95 : 0.4;
  }

  // Ghost notes ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Å–ª–∞–±—ã—Ö –¥–æ–ª—è—Ö
  if (isGhostNote(eventA) || isGhostNote(eventB)) {
    const inWeakBeat = !isOnStrongBeat(timeInBeats);
    const isQuiet = (isGhostNote(eventA) ? eventA : eventB).dynamics === 'p';
    return inWeakBeat && isQuiet ? 0.9 : 0.2;
  }

  // === 3. –ë–ê–° ‚Üî –ë–ê–° ===
  if (isBass(eventA) && isBass(eventB)) {
    const scale = getScaleForMood(mood as any); // ‚Üê –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–∞–º–º–∞
    const bothInScale = scale.includes(eventA.note) && scale.includes(eventB.note);
    return bothInScale ? 0.9 : 0.3;
  }

  // === 4. –ö–£–õ–¨–ú–ò–ù–ê–¶–ò–Ø ===
  if (context.delta > 0.9) {
    if (eventA.type.includes('tom') || eventB.type.includes('tom')) {
      return 0.85;
    }
    if (isCrash(eventA) || isCrash(eventB)) {
      return 1.0;
    }
  } else {
    if (isCrash(eventA) || isCrash(eventB)) {
      return 0.05;
    }
  }

  return 0.5;
};

–ü—Ä–æ–≤–µ—Ä–∫–∞ (—á–µ–∫-–ª–∏—Å—Ç –≠—Ç–∞–ø–∞ 3)
–ë–∞—Å + snare –Ω–∞ 2-–π –¥–æ–ª–µ ‚Üí K = 0.1 (—à—Ç—Ä–∞—Ñ),
Kick + –±–∞—Å –Ω–∞ 1-–π –¥–æ–ª–µ ‚Üí K = 1.0 (–ø–æ–æ—â—Ä–µ–Ω–∏–µ),
Ghost note –≤ —Å–ª–∞–±–æ–π –¥–æ–ª–µ ‚Üí K = 0.9,
Crash –ø—Ä–∏ delta < 0.9 ‚Üí K = 0.05,
–í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–∑ InstrumentType –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è.
üìä –û—Ü–µ–Ω–∫–∞
–†–µ–∑–æ–Ω–∞–Ω—Å —É–ø—Ä–∞–≤–ª—è–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ—Ç–±–æ—Ä–æ–º –≤–µ—Ç–≤–µ–π,
–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –±–∞—Å–∞ –∏ snare,
–ö—É–ª—å–º–∏–Ω–∞—Ü–∏–∏ –∑–≤—É—á–∞—Ç –º–æ—â–Ω–æ, –∞ –Ω–µ —Ö–∞–æ—Ç–∏—á–Ω–æ.

–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
–ù–µ–≤–µ—Ä–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
–£–±—Ä–∞–Ω–æ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞
(60 / tempo)
‚Äî
time
—É–∂–µ –≤ –¥–æ–ª—è—Ö —Ç–∞–∫—Ç–∞
–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏
–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è
areSimultaneous()
‚Äî —Ä–µ–∑–æ–Ω–∞–Ω—Å
—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–±—ã—Ç–∏–π
–ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–∞—è —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
getScaleForMood(mood)
‚Äî –≥–∞–º–º–∞
–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è
, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é

–¢–µ–ø–µ—Ä—å –∫–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç:

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ FractalMusicEngine (–≤—Ä–µ–º—è –≤ –¥–æ–ª—è—Ö —Ç–∞–∫—Ç–∞),
–ü—Ä–∏–Ω—Ü–∏–ø—É ¬´–µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∞–≤–¥—ã¬ª (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–∞–º–º–∞),
–ú—É–∑—ã–∫–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–µ (—Ä–µ–∑–æ–Ω–∞–Ω—Å —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π).




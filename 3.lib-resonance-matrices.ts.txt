–≠—Ç–∞–ø 3: resonance-matrices.ts ‚Äî –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –≤–∫—É—Å
‚úÖ –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∑–æ–Ω–∞–Ω—Å–Ω—É—é –º–∞—Ç—Ä–∏—Ü—É, –∫–æ—Ç–æ—Ä–∞—è –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ—Å—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –±–∞—Å–∞ –∏ —É–¥–∞—Ä–Ω—ã—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ:

–¢–µ–æ—Ä–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –≥–∞—Ä–º–æ–Ω–∏–∏ (–†–∏–º—Å–∫–∏–π-–ö–æ—Ä—Å–∞–∫–æ–≤, –ß–∞–π–∫–æ–≤—Å–∫–∏–π),
–ü—Ä–∞–∫—Ç–∏–∫–∏ –≥—Ä—É–≤–∞ (Ed Friedland, –ì—É—Ä—É–ª–µ–≤),
–§—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏ (–≤–µ—Å–∞, Œ¥(t), –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–±–æ—Ä).
‚úÖ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
–®—Ç—Ä–∞—Ñ –∑–∞ –±–∞—Å + snare –Ω–∞ –æ–¥–Ω–æ–π –¥–æ–ª–µ ‚Üí K = 0.1,
–ü–æ–æ—â—Ä–µ–Ω–∏–µ –∑–∞ kick + –±–∞—Å –Ω–∞ 1/3 ‚Üí K = 1.0,
Ghost notes –≤ —Å–ª–∞–±—ã—Ö –¥–æ–ª—è—Ö ‚Üí K = 0.9,
Crash –≤–Ω–µ –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–∏ ‚Üí K = 0.05,
–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ InstrumentType.

–ö–æ–¥
import type { FractalEvent, ResonanceMatrix } from '@/types/fractal';

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
function isOnStrongBeat(time: number, tempo: number): boolean {
  const beat = Math.floor(time * tempo / 60) % 4;
  return beat === 0 || beat === 2; // 1 –∏ 3
}

function isOnSnareBeat(time: number, tempo: number): boolean {
  const beat = Math.floor(time * tempo / 60) % 4;
  return beat === 1 || beat === 3; // 2 –∏ 4
}

function isGhostNote(event: FractalEvent): boolean {
  return event.technique === 'ghost' || event.dynamics === 'p';
}

function isKick(event: FractalEvent): boolean {
  return event.type === 'drum_kick';
}

function isSnare(event: FractalEvent): boolean {
  return event.type === 'drum_snare';
}

function isBass(event: FractalEvent): boolean {
  return event.type === 'bass';
}

function isCrash(event: FractalEvent): boolean {
  return event.type === 'drum_crash';
}

// === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ï–ó–û–ù–ê–ù–°–ê ===
export const MelancholicMinorK: ResonanceMatrix = (
  eventA: FractalEvent,
  eventB: FractalEvent,
  context: { mood: string; tempo: number; delta: number }
): number => {
  const { tempo, delta } = context;

  // === 1. –ë–ê–° ‚Üî –£–î–ê–†–ù–´–ï ===
  if (isBass(eventA) && isKick(eventB)) {
    // Kick + –±–∞—Å –Ω–∞ —Å–∏–ª—å–Ω–æ–π –¥–æ–ª–µ = –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑–æ–Ω–∞–Ω—Å
    return isOnStrongBeat(eventA.time, tempo) ? 1.0 : 0.3;
  }

  if (isBass(eventA) && isSnare(eventB)) {
    // Snare + –±–∞—Å –Ω–∞ –æ–¥–Ω–æ–π –¥–æ–ª–µ = –∫–æ–Ω—Ñ–ª–∏–∫—Ç
    return isOnSnareBeat(eventA.time, tempo) ? 0.1 : 0.8;
  }

  if (isKick(eventA) && isBass(eventB)) {
    return isOnStrongBeat(eventB.time, tempo) ? 1.0 : 0.3;
  }

  if (isSnare(eventA) && isBass(eventB)) {
    return isOnSnareBeat(eventB.time, tempo) ? 0.1 : 0.8;
  }

  // === 2. –£–î–ê–†–ù–´–ï ‚Üî –£–î–ê–†–ù–´–ï ===
  if (isKick(eventA) && isSnare(eventB)) {
    // Kick –Ω–∞ 1/3, Snare –Ω–∞ 2/4 ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π –≥—Ä—É–≤
    const kickOnStrong = isOnStrongBeat(eventA.time, tempo);
    const snareOnWeak = isOnSnareBeat(eventB.time, tempo);
    return kickOnStrong && snareOnWeak ? 0.95 : 0.4;
  }

  if (isSnare(eventA) && isKick(eventB)) {
    const snareOnWeak = isOnSnareBeat(eventA.time, tempo);
    const kickOnStrong = isOnStrongBeat(eventB.time, tempo);
    return snareOnWeak && kickOnStrong ? 0.95 : 0.4;
  }

  // Ghost notes ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Å–ª–∞–±—ã—Ö –¥–æ–ª—è—Ö
  if (isGhostNote(eventA) || isGhostNote(eventB)) {
    const ghostEvent = isGhostNote(eventA) ? eventA : eventB;
    const otherEvent = isGhostNote(eventA) ? eventB : eventA;
    const inWeakBeat = !isOnStrongBeat(ghostEvent.time, tempo);
    const isQuiet = ghostEvent.dynamics === 'p';
    return inWeakBeat && isQuiet ? 0.9 : 0.2;
  }

  // === 3. –ë–ê–° ‚Üî –ë–ê–° ===
  if (isBass(eventA) && isBass(eventB)) {
    // –û–±–∞ –≤ –ª–∞–¥—É = –≤—ã—Å–æ–∫–∏–π —Ä–µ–∑–æ–Ω–∞–Ω—Å
    const E_MINOR = [40, 42, 43, 45, 47, 48, 50]; // E2 Dorian
    const bothInScale = E_MINOR.includes(eventA.note) && E_MINOR.includes(eventB.note);
    return bothInScale ? 0.9 : 0.3;
  }

  // === 4. –ö–£–õ–¨–ú–ò–ù–ê–¶–ò–Ø ===
  if (delta > 0.9) {
    // –í –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Å–ª–æ–∂–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    if (eventA.type.includes('tom') || eventB.type.includes('tom')) {
      return 0.85; // fills –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è
    }
    if (isCrash(eventA) || isCrash(eventB)) {
      return 1.0; // crash –≤ –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–∏ = –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    }
  } else {
    // –í–Ω–µ –∫—É–ª—å–º–∏–Ω–∞—Ü–∏–∏ ‚Äî crash = –æ—à–∏–±–∫–∞
    if (isCrash(eventA) || isCrash(eventB)) {
      return 0.05;
    }
  }

  // === 5. –ó–ê–ü–ê–°–ù–û–ô –í–ê–†–ò–ê–ù–¢ ===
  return 0.5;

–ü—Ä–æ–≤–µ—Ä–∫–∞ (—á–µ–∫-–ª–∏—Å—Ç –≠—Ç–∞–ø–∞ 3)
–ë–∞—Å + snare –Ω–∞ 2-–π –¥–æ–ª–µ ‚Üí K = 0.1 (—à—Ç—Ä–∞—Ñ),
Kick + –±–∞—Å –Ω–∞ 1-–π –¥–æ–ª–µ ‚Üí K = 1.0 (–ø–æ–æ—â—Ä–µ–Ω–∏–µ),
Ghost note –≤ —Å–ª–∞–±–æ–π –¥–æ–ª–µ ‚Üí K = 0.9,
Crash –ø—Ä–∏ delta < 0.9 ‚Üí K = 0.05,
–í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–∑ InstrumentType –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è.
üìä –û—Ü–µ–Ω–∫–∞
–†–µ–∑–æ–Ω–∞–Ω—Å —É–ø—Ä–∞–≤–ª—è–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ—Ç–±–æ—Ä–æ–º –≤–µ—Ç–≤–µ–π,
–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –±–∞—Å–∞ –∏ snare,
–ö—É–ª—å–º–∏–Ω–∞—Ü–∏–∏ –∑–≤—É—á–∞—Ç –º–æ—â–Ω–æ, –∞ –Ω–µ —Ö–∞–æ—Ç–∏—á–Ω–æ.

};

–í–æ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π ambient.worker.ts, –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å –Ω–æ–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º FractalEvent (–≤–∫–ª—é—á–∞—è –ø–æ–ª–µ params), –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ —á–∏—Å—Ç—ã–π –∏ –≥–æ—Ç–æ–≤—ã–π –∫ production.

–í–æ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–∞—è, –±–æ–µ–≤–∞—è –≤–µ—Ä—Å–∏—è ambient.worker.ts, –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è —Å –≤–∞—à–µ–π —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª—å—é –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π:

‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ FractalMusicEngine,
‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å—ç–º–ø–ª–µ—Ä–æ–º —É–¥–∞—Ä–Ω—ã—Ö –∏ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–æ–º –±–∞—Å–∞,
‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç NaN –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ tempo,
‚úÖ –î—Ä–∞–º–∞—Ç—É—Ä–≥–∏—á–µ—Å–∫–∞—è –¥—É–≥–∞ —á–µ—Ä–µ–∑ Œ¥(t),
‚úÖ –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å FractalEvent.


import { FractalMusicEngine } from '../lib/fractal-music-engine';

let engine: FractalMusicEngine | null = null;
let timeOffset = 0;
let isRunning = false;
let animationFrameId: number | null = null;

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç–∞–∫—Ç–∞
function getBarDuration(tempo: number): number {
  const t = Number(tempo);
  if (isNaN(t) || t <= 0) return 2.0; // 120 BPM = 2 —Å–µ–∫/—Ç–∞–∫—Ç
  return 4 * (60 / t);
}

// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–≤–∏–∂–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç —Å—ç–º–ø–ª–µ—Ä–∞/—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∞
function convertScoreToEvents(score: FractalEvent[], offset: number): FractalEvent[] {
  return score
    .map(event => {
      if (!isFinite(event.time) || !isFinite(offset)) return null;
      return {
        ...event,
        time: event.time + offset // time —É–∂–µ –≤ –¥–æ–ª—è—Ö —Ç–∞–∫—Ç–∞ ‚Üí –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –≤—Ä–µ–º—è
      };
    })
    .filter((event): event is FractalEvent => event !== null && isFinite(event.time));
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–≤–∏–∂–∫–∞
function initializeEngine(settings: {
  mood: string;
  genre: string;
  tempo: number;
  seed?: number;
}) {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–º–ø–∞
  const tempo = Math.max(20, Math.min(300, Number(settings.tempo) || 120));

  engine = new FractalMusicEngine({
    mood: settings.mood as any,
    genre: settings.genre as any,
    tempo,
    seed: settings.seed
  });

  timeOffset = 0;
  isRunning = false;
}

// –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
function tick() {
  if (!engine) return;

  try {
    const score = engine.evolve();
    const events = convertScoreToEvents(score, timeOffset);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫
    self.postMessage({
      type: 'SCORE_READY',
      events
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    const barDuration = getBarDuration(engine.config.tempo);
    timeOffset += barDuration;
  } catch (e) {
    console.error('[Worker] Error in tick:', e);
  }

  if (isRunning) {
    animationFrameId = self.setTimeout(tick, 10); // ~100 FPS
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
self.onmessage = (e) => {
  if (!e.data) return;

  switch (e.data.command) {
    case 'init':
      initializeEngine(e.data.data);
      break;

    case 'start':
      if (!engine) {
        console.warn('[Worker] Engine not initialized, cannot start');
        return;
      }
      isRunning = true;
      tick();
      break;

    case 'stop':
      isRunning = false;
      if (animationFrameId) {
        self.clearTimeout(animationFrameId);
        animationFrameId = null;
      }
      break;

    case 'update_settings':
      if (isRunning) {
        console.warn('[Worker] Cannot update settings while running');
        return;
      }
      initializeEngine(e.data.data);
      break;

    default:
      if (e.data.command) {
        console.warn('[Worker] Unknown command:', e.data.command);
      }
  }
};

–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å audio-engine-context.tsx: –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ { command, data },
–ó–∞—â–∏—Ç–∞ –æ—Ç NaN: –≤—Å–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±—ë—Ä–Ω—É—Ç—ã –≤ isFinite(),
–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ barDuration: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç ¬´–∑–∞–º–æ—Ä–æ–∑–∫—É¬ª –≤—Ä–µ–º–µ–Ω–∏,
–ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞–∑: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –∑–∞–ø—É—Å–∫, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫.

–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
–ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –Ω–æ–≤—ã–º FractalEvent:
–°–æ–±—ã—Ç–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç params, technique, dynamics ‚Äî –≤—Å—ë –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
–ó–∞—â–∏—Ç–∞ –æ—Ç NaN:
–í—Å–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±—ë—Ä–Ω—É—Ç—ã –≤ isFinite().
–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ barDuration:
–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç ¬´–∑–∞–º–æ—Ä–æ–∑–∫—É¬ª –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–º–ø–∞.
–ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞–∑:
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –∑–∞–ø—É—Å–∫, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫.
üìÅ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
–ü–æ–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –≤ src/app/ambient.worker.ts,
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ audio-engine-context.tsx –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
ts


1
worker.postMessage({ command: 'init',  { mood, genre, tempo } });
–¢–µ–ø–µ—Ä—å –≤–æ—Ä–∫–µ—Ä –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–µ—Ä–µ–¥–∞—ë—Ç —Å–æ–±—ã—Ç–∏—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –∏ –±–∞—Å/—É–¥–∞—Ä–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç –≤—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è.

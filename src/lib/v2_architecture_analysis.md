
# AuraGroove V2: Архитектурный Паспорт (Версия "Прозрачный Композитор")

Этот документ описывает полный путь прохождения звука в V2-архитектуре, от зарождения музыкальной идеи до ее воспроизведения. Он служит "рентгеновским снимком" системы для точной диагностики и дальнейшей разработки.

### 1. Ключевые Файлы для Анализа

Это модули, составляющие полную цепочку V2-звукообразования:

1.  **`src/app/ambient.worker.ts`**: **"Мозг" (Композитор и Дирижер)**. Здесь `FractalMusicEngine` решает, *что* играть.
2.  **`src/contexts/audio-engine-context.tsx`**: **"Сердце" (Диспетчер)**. Получает партитуру и командует "исполнителями".
3.  **`src/lib/*-synth-manager-v2.ts`**: **"Исполнители"**. Управляют конкретными инструментами.
4.  **`src/lib/instrument-factory.ts`**: **"Фабрика"**. Собирает аудио-графы по чертежам.
5.  **`src/lib/presets-v2.ts`**: **"Чертежи"**. Рецепты звучания инструментов.
6.  **`src/lib/blueprints/`**: **"Партитуры"**. Правила композиции для жанров и настроений.
7.  **`src/lib/assets/`**: **"Библиотеки"**. Наборы готовых риффов и битов (`blues-melody-riffs.ts`, `blues-drum-riffs.ts`, `drum-kits.ts`).

---

### 2. Ядро Движка (`FractalMusicEngine`): Математика и Логика

В отличие от ранних версий, основанных на абстрактной "матрице резонанса", текущая архитектура работает по принципу **детерминированного исполнения декларативных правил**. "Магия" теперь не в сложной математике, а в иерархии принятия решений.

1.  **Инициализация (`initialize`):**
    *   При старте новой сюиты движок получает `genre` и `mood`.
    *   С помощью `getBlueprint(genre, mood)` он загружает соответствующий **Блюпринт**.
    *   На основе этого блюпринта создается `BlueprintNavigator`, который "размечает" всю будущую композицию на части (INTRO, BUILD, MAIN) и бандлы, создавая предсказуемую структуру.
    *   Генерируется `ghostHarmonyTrack` — полный "гармонический скелет" на всю сюиту.
    *   Для блюза создаются и перемешиваются "конвейеры уникальности" — случайные последовательности риффов и мелодий на всю сессию.

2.  **Основной Цикл (`evolve` -> `generateOneBar`):**
    *   На каждом такте (`epoch`) `evolve` вызывает `generateOneBar`.
    *   **Навигация:** `this.navigator.tick(this.epoch)` определяет, в какой части (`currentPart`) и бандле (`currentBundle`) мы находимся.
    *   **Гармония:** Из `ghostHarmonyTrack` извлекается текущий аккорд (`currentChord`).
    *   **Исполнение Правил:** Движок проходит по списку разрешенных инструментов (`currentPart.layers`) и для каждого вызывает соответствующую функцию-генератор (`generateDrumEvents`, `generateBluesBassRiff` и т.д.), передавая в нее `currentChord` и правила из `currentPart.instrumentRules`.
    *   **Результат:** Функция возвращает массив событий `FractalEvent[]` — готовую партитуру на один такт.

---

### 3. Принцип "Кумулятивного Ансамбля" и Лотерея Вступления

**Проблема:** В ранних версиях инструменты могли хаотично менять тембры или исчезать, что разрушало ощущение "живого оркестра".

**Решение:** Внедрена система "Оркестровой Лотереи" с памятью тембров.

*   **Липкие Тембры (`activatedInstruments`)**: Движок использует `Map<InstrumentPart, string>` для фиксации выбора. Если на определенном этапе вступления (Stage) "кубик выпал удачно" и инструмент (например, Орган) вступил в игру, он запоминает свой тембр и продолжает звучать до конца текущей музыкальной части (`BlueprintPart`).
*   **Декларативные Сцены (Stages)**: Секции интро разделены на временные отрезки (сцены), где для каждого музыканта задан свой шанс на активацию. Это создает эффект постепенного наполнения сцены артистами.
*   **Временные Слой (Transient)**: Флаг `transient` в правилах активации позволяет выделять инструменты (например, спецэффекты или спарклы), которые не "прилипают" к ансамблю, а проверяют шанс своего появления каждый такт заново.

---

### 4. Алхимия Соло: Микро-Мутации и Бесконечная Вариативность

**Проблема:** Использование фиксированных библиотек фраз приводило к повторяемости мелодий в разных сессиях.

**Решение:** Внедрена система трехуровневой "алхимии" ликов в `generateBluesMelodyChorus`.

*   **Случайная Транспозиция**: Каждый лик может быть смещен на случайный интервал (например, на терцию вверх или вниз) относительно текущего аккорда.
*   **Инверсия (Зеркало)**: Мелодический рисунок может быть "перевернут" вертикально, превращая восходящее движение в нисходящее.
*   **Ритмическое Варьирование**: Длительности отдельных нот внутри лика могут сокращаться или удлиняться на основе случайных весов, сохраняя при этом общую сетку 12/8.

**Результат:** Комбинация этих мутаций с уникальным "семенем" (seed) сессии обеспечивает 68+ миллионов вариаций исполнения одного и того же соло-плана.

---

### 5. Гармонические Достижения: "Живой Скелет" и "Железная Гармония"

1.  **Живой Скелет**: Базовая тональность и модальная структура каждой сюиты генерируются случайно в `generateSuiteDNA`. Каждая сессия получает уникальный "гармонический паспорт", что исключает эффект "одинаковых скелетов".
2.  **Железная Гармония (Dark Blues)**: Специально для настроения `dark` в блюзе внедрена логика ускоренной пульсации. Такт принудительно делится пополам: 2 доли на основной аккорд и 2 доли на его доминанту. Это создает эффект "зловещего маятника" и предотвращает затянутость аранжировки.

---

### 6. Контракты Данных

Это ключевые структуры данных, передаваемые между модулями.

**`FractalEvent` (Единица Партитуры):**
```typescript
export interface FractalEvent {
  type: InstrumentType | InstrumentType[]; // Кто играет
  note: number;                            // MIDI нота
  duration: number;                        // Длительность в долях такта
  time: number;                            // Время начала в долях такта
  weight: number;                          // Громкость/вероятность
  technique: Technique;                    // Техника игры
  params?: BassSynthParams | SfxSynthParams; // Параметры для синтеза
  chordName?: string; // Для сэмплеров аккордов
}
```

---

### 7. Схема Аудио-Графа "Фабрики" (Пример для `type: 'guitar'`)

```
[sum] (Сумма осцилляторов)
  │
  └─> [vGain] (ADSR огибающая)
        │
        └─> [pickupLPF] (Фильтр звукоснимателя)
              │
              └─> [hpf] (Фильтр низких частот)
                    │
                    └─> [compNode] (Компрессор)
                          │
                          └─> [shaper] (Драйв/Дисторшн)
                                │
                                └─> [postHPF, mid1, mid2, postLPF] (Эквалайзер)
                                      │
                                      └─> [ph.input] (Фейзер)
                                            │
                                            └─> [dA.input, dB.input] (Два дилэя)
                                                  │
                                                  ├─> [master] (На основной выход)
                                                  │
                                                  └─> [revSend] (На посыл реверберации)
```

# AuraGroove V2: Архитектурный Паспорт (Версия "Steel Foundation")

Этот документ описывает финальную, эталонную архитектуру V2-движка АураОС, обеспечивающую абсолютную стабильность и чистоту звука.

### 1. Ключевые Файлы

1.  **`src/app/ambient.worker.ts`**: **Композитор**. Генерирует ДНК и партитуру.
2.  **`src/contexts/audio-engine-context.tsx`**: **Маршрутизатор**. Управляет потоками данных.
3.  **`src/lib/instrument-factory.ts`**: **Стальной Фундамент**. Содержит логику физического синтеза и управления ресурсами.

---

### 2. Принцип "Steel Foundation" (Ресурсная Безопасность)

Это ядро нашей победы над браузерным троттлингов и крахами в фоновом режиме.

#### 2.1. Пассивная Детерминированная Очистка
В АураОС запрещено использование `setTimeout` или `setInterval` для управления временем жизни нот.
*   Каждый голос (`voiceRecord`) имеет встроенный обработчик `onended` на ведущем осцилляторе.
*   Очистка узлов (`deepCleanup`) происходит только по факту физического завершения звука. Это делает систему неуязвимой к задержкам JavaScript в фоновых вкладках.

#### 2.2. Global Voice Registry & Stealing
Мы отказались от локальных лимитов для каждого инструмента.
*   Все инструменты V2 регистрируют свои ноты в едином глобальном реестре.
*   При превышении порога в 100 активных голосов включается механизм **Voice Stealing**: система находит самый старый голос (независимо от типа инструмента) и чисто удаляет его. Это гарантирует выживание аудио-контекста любой ценой.

#### 2.3. Изоляция Управляющих Цепей (LFO Isolation)
*   LFO для эффектов (Phaser, Leslie, Tremolo) создаются один раз при инициализации инструмента.
*   Они модулируют **статические узлы** (Gain, Filter), а не параметры конкретных нот. Это устраняет риск накопления сотен "висячих" LFO при быстрой смене нот.

---

### 3. Органная Революция (Efficiency)

Для снижения нагрузки в 10 раз движок `organ` переведен с аддитивного на **таблично-волновой синтез**.
*   Вместо 9 осцилляторов на каждую ноту используется один узел `OscillatorNode` с `PeriodicWave`.
*   Спектр всех регистров (drawbars) рассчитывается один раз при загрузке пресета.

---

### 4. Гитарное Моделирование

Внедрена физика реального инструмента:
*   **Pick Attack**: Шумовой транзиент для естественности.
*   **Comb Filtering**: Фазовая эмуляция Stratocaster.
*   **Vintage Drive**: Arctan-Sinh кривая сатурации для певучего сустейна.

---

### 5. Контракты Данных

**`FractalEvent`**: Единый протокол, включающий MIDI, длительность, вес и технику исполнения.

**`InstrumentHints`**: Механизм передачи намерений композитора исполнителям для динамической смены тембров.

---

### 6. The Stream Bridge (Background Sovereignty)

Реализация режима **Broadcast (Radio)** обеспечивает абсолютную стабильность воспроизведения в любых условиях.
*   **Direct Routing**: Звуковой поток `MediaStream` направляется напрямую в `HTMLAudioElement.srcObject`.
*   **OS Priority**: Использование системного аудио-тега переводит процесс в категорию "Медиа-плеер", предотвращая усыпление браузером при выключенном экране.
*   **Silk Start**: Программный fade-in на уровне элемента маскирует стартовые артефакты буферизации, обеспечивая "шелковый" вход в вещание.

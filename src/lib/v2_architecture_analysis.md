# AuraGroove V2: Архитектурный Паспорт (Версия "Прозрачный Композитор")

Этот документ описывает полный путь прохождения звука в V2-архитектуре, от зарождения музыкальной идеи до ее воспроизведения. Он служит "рентгеновским снимком" системы для точной диагностики и дальнейшей разработки.

### 1. Ключевые Файлы для Анализа

Это модули, составляющие полную цепочку V2-звукообразования:

1.  **`src/app/ambient.worker.ts`**: **"Мозг" (Композитор и Дирижер)**. Здесь `FractalMusicEngine` решает, *что* играть.
2.  **`src/contexts/audio-engine-context.tsx`**: **"Сердце" (Диспетчер)**. Получает партитуру и командует "исполнителями".
3.  **`src/lib/*-synth-manager-v2.ts`**: **"Исполнители"**. Управляют конкретными инструментами.
4.  **`src/lib/instrument-factory.ts`**: **"Фабрика"**. Собирает аудио-графы по чертежам.
5.  **`src/lib/presets-v2.ts`**: **"Чертежи"**. Рецепты звучания инструментов.
6.  **`src/lib/blueprints/`**: **"Партитуры"**. Правила композиции для жанров и настроений.
7.  **`src/lib/assets/`**: **"Библиотеки"**. Наборы готовых риффов и битов (`blues-melody-riffs.ts`, `blues-drum-riffs.ts`, `drum-kits.ts`).

---

### 2. Ядро Движка (`FractalMusicEngine`): Математика и Логика

В отличие от ранних версий, основанных на абстрактной "матрице резонанса", текущая архитектура работает по принципу **детерминированного исполнения декларативных правил**. "Магия" теперь не в сложной математике, а в иерархии принятия решений.

1.  **Инициализация (`initialize`):**
    *   При старте новой сюиты движок получает `genre` и `mood`.
    *   С помощью `getBlueprint(genre, mood)` он загружает соответствующий **Блюпринт**.
    *   На основе этого блюпринта создается `BlueprintNavigator`, который "размечает" всю будущую композицию на части (INTRO, BUILD, MAIN) и бандлы, создавая предсказуемую структуру.
    *   Генерируется `ghostHarmonyTrack` — полный "гармонический скелет" на всю сюиту.
    *   Для блюза создаются и перемешиваются "конвейеры уникальности" — случайные последовательности риффов и мелодий на всю сессию.

2.  **Основной Цикл (`evolve` -> `generateOneBar`):**
    *   На каждом такте (`epoch`) `evolve` вызывает `generateOneBar`.
    *   **Навигация:** `this.navigator.tick(this.epoch)` определяет, в какой части (`currentPart`) и бандле (`currentBundle`) мы находимся.
    *   **Гармония:** Из `ghostHarmonyTrack` извлекается текущий аккорд (`currentChord`).
    *   **Исполнение Правил:** Движок проходит по списку разрешенных инструментов (`currentPart.layers`) и для каждого вызывает соответствующую функцию-генератор (`generateDrumEvents`, `generateBluesBassRiff` и т.д.), передавая в нее `currentChord` и правила из `currentPart.instrumentRules`.
    *   **Результат:** Функция возвращает массив событий `FractalEvent[]` — готовую партитуру на один такт.

Эта модель делает движок предсказуемым, управляемым и легко отлаживаемым. Музыкальная сложность достигается не хаосом, а глубиной и продуманностью правил в блюпринтах.

---

### 3. Глубокое Погружение: Как `generateBluesMelodyChorus` Избегает "Швов"

Логика "склейки" фраз оказалась проще и изящнее, чем можно было предположить. Функция **не склеивает** фразы в реальном времени; она **собирает** полный 12-тактовый хорус из заранее подготовленных, стилистически совместимых "строительных блоков". "Швы" избегаются не за счет сложной алгоритмической сшивки, а за счет грамотного музыкального дизайна самих фраз.

Вот точная пошаговая логика:

1.  **Выбор Мелодии ("ДНК Хоруса"):**
    *   В самом начале функция выбирает одну "мастер-мелодию" из библиотеки `BLUES_MELODY_RIFFS` (файл `blues-melody-riffs.ts`). Выбор зависит от текущего `mood` и от того, является ли текущая секция соло (чтобы избежать повторения).
    *   Эта выбранная мелодия (например, `Joyful-01`) содержит в себе готовые "ответы" для каждого типа аккорда в блюзовой прогрессии: `phraseI`, `phraseIV`, `phraseV` и `phraseTurnaround`.

2.  **Сборка Хоруса по Гармонии (12-тактовый цикл):**
    *   Функция запускает цикл на 12 тактов.
    *   **На каждом такте** она определяет, какой аккорд сейчас должен звучать согласно стандартной 12-тактовой блюзовой сетке (I, IV или V).
    *   В зависимости от аккорда, она берет **соответствующую готовую фразу** из выбранной "мастер-мелодии".
        *   Если такт 1-й, 3-й, 4-й, 7-й или 8-й (аккорд I), используется `phraseI`.
        *   Если такт 2-й, 5-й, 6-й или 10-й (аккорд IV), используется `phraseIV`.
        *   Если такт 9-й или 12-й (аккорд V), используется `phraseV` или `phraseTurnaround`.
    *   Каждая нота из выбранной фразы преобразуется в событие `FractalEvent` с **абсолютным временем** внутри 12-тактового хоруса.

3.  **Применение Мутаций (Добавление "Живости"):**
    *   После того как весь 12-тактовый хорус собран, с вероятностью ~40% к нему применяется одна случайная мутация:
        *   `Rhythmic Shift`: Небольшой сдвиг нот во времени в одном из тактов.
        *   `Register Shift`: Сдвиг всех нот в одном из тактов на октаву вверх или вниз.
        *   `Note Removal`: Случайное удаление одной ноты.
    *   **Важно:** Эти мутации не "сшивают" швы, а добавляют вариативности уже собранной, гармонически целостной структуре.

**Как избегаются "швы"?**

Проблема "швов" решена **на уровне музыкального дизайна, а не на уровне кода.** Сами мелодические фразы в `blues-melody-riffs.ts` написаны так, чтобы они гармонично и ритмически перетекали друг в друга в контексте 12-тактового блюза.

*   **Начальные и конечные ноты** фраз подобраны так, чтобы создавать плавные переходы (например, последняя нота фразы для аккорда `I` естественно ведет к первой ноте фразы для аккорда `IV`).
*   **Ритмический рисунок** фраз комплементарен друг другу, поддерживая общий шаффл-грув.
*   **`phraseTurnaround`** — это специальная фраза для 12-го такта, которая музыкально "замыкает" квадрат и создает напряжение, разрешающееся в первую долю следующего хоруса.

---

### 4. Контракты Данных

Это ключевые структуры данных, передаваемые между модулями.

**`FractalEvent` (Единица Партитуры):**
```typescript
export interface FractalEvent {
  type: InstrumentType | InstrumentType[]; // Кто играет
  note: number;                            // MIDI нота
  duration: number;                        // Длительность в долях такта
  time: number;                            // Время начала в долях такта
  weight: number;                          // Громкость/вероятность
  technique: Technique;                    // Техника игры
  dynamics: Dynamics;                      // Динамика
  phrasing: Phrasing;                      // Фразировка
  params?: BassSynthParams | SfxSynthParams; // Параметры для синтеза
}
```

**`GhostChord` (Единица Гармонического Скелета):**
```typescript
export type GhostChord = {
  rootNote: number;      // MIDI нота корня
  chordType: 'major' | 'minor' | 'diminished' | 'dominant';
  bar: number;           // Такт начала
  durationBars: number;  // Длительность в тактах
};
```

**`InstrumentHints` (Рекомендации Композитора):**
```typescript
export type InstrumentHints = {
    bass?: BassInstrument;
    melody?: MelodyInstrument;
    accompaniment?: AccompanimentInstrument;
    harmony?: 'piano' | 'guitarChords' | 'acousticGuitarSolo' | 'flute' | 'violin';
    bassTechnique?: BassTechnique;
};
```

---

### 5. Схема Аудио-Графа "Фабрики" (Пример для `type: 'guitar'`)

Этот блок показывает, как `instrument-factory.ts` собирает цепочку эффектов для эмуляции электрогитары.

```
[sum] (Сумма осцилляторов)
  │
  └─> [vGain] (ADSR огибающая)
        │
        └─> [pickupLPF] (Фильтр звукоснимателя)
              │
              └─> [hpf] (Фильтр низких частот)
                    │
                    └─> [compNode] (Компрессор)
                          │
                          └─> [shaper] (Драйв/Дисторшн)
                                │
                                └─> [postHPF, mid1, mid2, postLPF] (Эквалайзер)
                                      │
                                      └─> [cab] (Эмулятор кабинета, опционально)
                                            │
                                            └─> [ph.input] (Фейзер)
                                                  │
                                                  └─> [dA.input, dB.input] (Два дилэя)
                                                        │
                                                        ├─> [master] (На основной выход)
                                                        │
                                                        └─> [revSend] (На посыл реверберации)
```

### 6. Дерево Связей Модулей V2 (Обновленное)

```
[UI]
  └─ src/app/aura-groove-v2.tsx (управляет всем через хук)
       │
       └─ src/hooks/use-aura-groove.ts (вызывает AudioEngineContext)
            │
            └─ src/contexts/audio-engine-context.tsx  <──┐
                 │ (1. Отправляет команды в Worker)      │ (5. Получает партитуру)
                 │                                       │
                 ├──> [WORKER THREAD] ───────────────>───┘
                 │      │
                 │      └─ src/app/ambient.worker.ts (Композитор)
                 │           │
                 │           └─ src/lib/fractal-music-engine.ts
                 │                │
                 │                ├─ src/lib/blueprints/ (Правила и Стили)
                 │                │
                 │                └─ src/lib/assets/ (Библиотеки Риффов)
                 │                     ├─ blues-melody-riffs.ts
                 │                     └─ drum-kits.ts
                 │
                 │ (2. Вызывает V2-менеджеры)
                 │
                 └──> src/lib/melody-synth-manager-v2.ts
                        │ (3. Управляет Фабрикой)
                        └─> src/lib/instrument-factory.ts
                              │ (4. Читает Чертежи)
                              └─ src/lib/presets-v2.ts
```

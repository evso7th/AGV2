# AuraGroove V2: Архитектурный Паспорт Звукового Движка

Этот документ описывает полный путь прохождения звука в V2-архитектуре, от зарождения музыкальной идеи до ее воспроизведения. Он служит "рентгеновским снимком" системы для точной диагностики и дальнейшей разработки.

### 1. Ключевые Файлы для Анализа

Это шесть модулей, составляющих полную цепочку V2-звукообразования:

1.  **`src/app/ambient.worker.ts`**: **"Мозг" (Композитор и Дирижер)**. Здесь `FractalMusicEngine` решает, *что* играть, и отправляет партитуру в основной поток.
2.  **`src/contexts/audio-engine-context.tsx`**: **"Сердце" (Диспетчер)**. Получает партитуру от воркера и передает команды конкретным "исполнителям".
3.  **`src/lib/melody-synth-manager-v2.ts`**: **"Первая скрипка" (Исполнитель V2 Мелодии)**. Получает ноты для мелодии и командует "фабрикой".
4.  **`src/lib/accompaniment-synth-manager-v2.ts`**: **"Ритм-секция" (Исполнитель V2 Аккомпанемента)**. Получает ноты для аккомпанемента и командует "фабрикой".
5.  **`src/lib/instrument-factory.ts`**: **"Фабрика" (Сборщик Звука)**. Самый важный файл. Здесь по чертежам из пресетов собирается реальный аудио-граф.
6.  **`src/lib/presets-v2.ts`**: **"Чертежи" (ДНК Тембров)**. Здесь лежат детальные рецепты того, как должен звучать каждый инструмент.

### 2. Полный Путь Звукообразования V2 (от Композитора до Акустики)

Вот полный путь, который проходит одна нота в V2-архитектуре:

**УРОВЕНЬ 1: КОМПОЗИТОР (Web Worker)**

1.  **Зарождение Идеи (`fractal-music-engine.ts`):** `FractalMusicEngine` на основе блюпринта решает, что в текущем такте должна прозвучать нота (например, MIDI 60) для партии `melody`.
2.  **Выбор Тембра (`fractal-music-engine.ts`):** Движок смотрит на правила блюпринта для текущей секции и с помощью функции `_chooseInstrumentForPart` выбирает "рекомендованный" инструмент, например, `'organ_soft_jazz'`.
3.  **Отправка Партитуры (`ambient.worker.ts`):** Воркер упаковывает событие `{ type: 'melody', note: 60, ... }` и "рекомендацию" `instrumentHints: { melody: 'organ_soft_jazz' }` в сообщение и отправляет его в основной поток командой `self.postMessage({ type: 'SCORE_READY', ... })`.

**УРОВЕНЬ 1.5: Генерация Соло (Движок Импровизаций)**

**ЗАДАЧА:** Этот новый компонент логики, добавленный 3 октября 2024 года, отвечает за создание осмысленных блюзовых соло.

*   **Активация:** Включается, когда `FractalMusicEngine` обнаруживает, что текущий жанр — `blues` и активна секция, предназначенная для соло (например, `SOLO` в `EpicBluesBlueprint`).
*   **Словарный запас:** Движок обращается к `src/lib/assets/blues-melody-riffs.ts`, где хранится библиотека из 20+ блюзовых "фраз" (licks), снабженных ритмическими тегами (`'shuffle'`, `'slow-burn'`).
*   **Контекстный выбор:** Движок анализирует текущий ритм (например, `boogie` или `walking` бас) и отбирает из библиотеки только те фразы, которые стилистически соответствуют моменту.
*   **Сборка и кэширование:** Из отфильтрованных фраз функция `generateBluesMelodyChorus` "склеивает" цельный 12-тактовый хорус соло и кэширует его.
*   **Исполнение:** В последующих тактах движок просто извлекает нужный фрагмент из кэша, обеспечивая непрерывное и логичное звучание импровизации.

**УРОВЕНЬ 2: ДИСПЕТЧЕР (Основной поток)**

4.  **Прием Команды (`audio-engine-context.tsx`):** `AudioEngineProvider` через `worker.onmessage` получает сообщение.
5.  **Маршрутизация (`audio-engine-context.tsx`):** Диспетчер видит, что флаг `useMelodyV2` активен. Он вызывает метод `melodyManagerV2Ref.current.schedule(...)`, передавая ему массив нот и "рекомендацию" `'organ_soft_jazz'`.

**УРОВЕНЬ 3: ИСПОЛНИТЕЛЬ (V2-Менеджер)**

6.  **Смена Инструмента (`melody-synth-manager-v2.ts`):** Менеджер получает команду. Он сравнивает новый `instrumentHint` (`'organ_soft_jazz'`) со своим текущим (`activePresetName`). Если они отличаются, он вызывает `this.loadInstrument('organ_soft_jazz')`.
7.  **Команда "Собрать!" (`melody-synth-manager-v2.ts`):** Внутри `loadInstrument` менеджер отдает команду "фабрике": `this.instrument = await buildMultiInstrument(..., { type: 'organ', preset: V2_PRESETS['organ_soft_jazz'], ... })`.

**УРОВЕНЬ 4: ФАБРИКА (Сборка и Звук)**

8.  **Чтение Чертежа (`instrument-factory.ts`):** "Фабрика" получает команду. Она берет "чертеж" `V2_PRESETS['organ_soft_jazz']` и начинает сборку.
9.  **Сборка Аудио-Графа (`instrument-factory.ts`):** Фабрика создает узлы Web Audio API: `OscillatorNode`, `GainNode`, `BiquadFilterNode` и т.д.
10. **Воспроизведение (`instrument-factory.ts`):** В конце концов, вызывается `api.noteOn(60)`, который запускает осцилляторы. Звук проходит по собранной цепи и через `output` попадает в динамики.

### 3. Дерево Связей Модулей V2

Вот как эти файлы связаны между собой:

```
[UI]
  └─ src/app/aura-groove/page.tsx (управляет всем через хук)
       │
       └─ src/hooks/use-aura-groove.ts (вызывает AudioEngineContext)
            │
            └─ src/contexts/audio-engine-context.tsx  <──┐
                 │ (1. Отправляет команды в Worker)      │ (5. Получает партитуру)
                 │                                       │
                 ├──> [WORKER THREAD] ───────────────>───┘
                 │      │
                 │      └─ src/app/ambient.worker.ts (Композитор)
                 │           │
                 │           └─ src/lib/fractal-music-engine.ts
                 │                │
                 │                └─ src/lib/blueprints/ (Правила и Стили)
                 │                     │
                 │                     └─ src/lib/assets/ (Библиотеки риффов)
                 │
                 │ (2. Вызывает V2-менеджеры)
                 │
                 ├──> src/lib/melody-synth-manager-v2.ts
                 │      │ (3. Командует Фабрикой)
                 │      └─┐
                 │        ├─> src/lib/instrument-factory.ts
                 │        │     │ (4. Читает Чертежи)
                 │        │     └─ src/lib/presets-v2.ts
                 │        │
                 └──> src/lib/accompaniment-synth-manager-v2.ts
                        │ (3. Командует Фабрикой)
                        └─> src/lib/instrument-factory.ts
                              │ (4. Читает Чертежи)
                              └─ src/lib/presets-v2.ts
```

### 4. Структура Пресета 'synth' (Эталон)

Этот раздел документирует рабочую структуру данных для пресетов типа `synth`, которую "Фабрика" (`instrument-factory.ts`) гарантированно понимает.

```typescript
// Пример из `presets-v2.ts`
synth: {
  type: 'synth',
  // Массив осцилляторов. Фабрика создаст и смешает их все.
  osc: [
    { type: 'sawtooth', detune: -4, octave: 0,  gain: 0.5 },
    { type: 'sawtooth', detune: +4, octave: 0,  gain: 0.5 },
    { type: 'sine',     detune: 0, octave: -1, gain: 0.7 } // Sub-bass
  ],
  // Настройки генератора шума.
  noise: { on: true, color: 'pink', gain: 0.03 },
  // Огибающая громкости (Attack, Decay, Sustain, Release).
  adsr:  { a: 0.8, d: 1.2, s: 0.7, r: 3.0 },
  // Фильтр нижних частот. `mode` '24dB' включает второй фильтр для более крутого среза.
  lpf:   { cutoff: 1600, q: 1.2, mode: '24dB' }, 
  // Низкочастотный осциллятор для модуляции. `target` указывает, что модулировать.
  lfo:   { rate: 0.18, amount: 450, target: 'filter' },
  // Встроенные эффекты. `on: true` включает эффект.
  chorus:{ on: true, rate: 0.2, depth: 0.007, mix: 0.4 },
  delay: { on: true, time: 0.5, fb: 0.3, hc: 4000, mix: 0.2 },
  // Громкость посыла на глобальный ревербератор.
  reverbMix: 0.25
}
```
**Важно:** Любые отклонения от этой структуры в пресетах типа `synth` могут привести к тому, что "фабрика" их не "поймет", и инструмент будет молчать или звучать некорректно.

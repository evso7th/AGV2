# AuraGroove V2: Архитектурный Паспорт (Версия "Идеальная Полифония")

Этот документ описывает полный путь прохождения звука в V2-архитектуре, от зарождения музыкальной идеи до ее воспроизведения. Он служит "рентгеновским снимком" системы для точной диагностики и дальнейшей разработки.

### 1. Ключевые Файлы для Анализа

Это модули, составляющие полную цепочку V2-звукообразования:

1.  **`src/app/ambient.worker.ts`**: **"Мозг" (Композитор и Дирижер)**. Здесь `FractalMusicEngine` решает, *что* играть.
2.  **`src/contexts/audio-engine-context.tsx`**: **"Сердце" (Диспетчер)**. Получает партитуру и командует "исполнителями".
3.  **`src/lib/*-synth-manager-v2.ts`**: **"Исполнители"**. Управляют конкретными инструментами.
4.  **`src/lib/instrument-factory.ts`**: **"Фабрика"**. Собирает аудио-графы по чертежам. Реализует **Voice Isolation** (Печать Полифонии).
5.  **`src/lib/presets-v2.ts`**: **"Чертежи"**. Рецепты звучания инструментов.
6.  **`src/lib/blueprints/`**: **"Партитуры"**. Правила композиции для жанров и настроений.
7.  **`src/lib/assets/`**: **"Библиотеки"**. Наборы готовых риффов и битов.

---

### 2. Ядро Движка (`FractalMusicEngine`): Математика и Логика

В отличие от ранних версий, основанных на абстрактной "матрице резонанса", текущая архитектура работает по принципу **детерминированного исполнения декларативных правил**. "Магия" теперь не в сложной математике, а в иерархии принятия решений.

1.  **Инициализация (`initialize`):**
    *   При старте новой сюиты движок загружает **Блюпринт** через `BlueprintNavigator`.
    *   Генерируется `ghostHarmonyTrack` — полный "гармонический скелет" на всю сюиту.
    *   Внедряется **Persistent Memory** (Липкий Ансамбль): инструменты, вступившие в игру, остаются на сцене до явной команды БП.

2.  **Основной Цикл (`evolve` -> `generateOneBar`):**
    *   **Навигация:** Движок определяет текущую фазу сюиты и применяет правила входа инструментов парами.
    *   **Гармония:** Из `ghostHarmonyTrack` извлекается текущий аккорд.
    *   **Исполнение:** Движок генерирует события `FractalEvent[]` — готовую партитуру на один такт.

---

### 3. Принцип "Кумулятивного Ансамбля" (Persistent Ensemble)

**Решение:** Внедрена система "Оркестровой Лотереи" с памятью тембров.

*   **Липкие Тембры (`activatedInstruments`)**: Движок фиксирует выбор тембра. Инструмент не исчезает при переходе между частями, обеспечивая монолитность аранжировки.
*   **Декларативные Сцены (Stages)**: Секции интро разделены на сцены (например, 4 сцены по 25%), где музыканты вступают парами с заданной вероятностью.

---

### 4. Печать Полифонии: Voice Isolation

Для устранения хрипов и утечек введена **Тотальная Изоляция Голосов** в `instrument-factory.ts`.

1.  **Voice Record**: Каждая нота создает независимый объект со своим набором узлов (осцилляторы, гейны, эффекты).
2.  **Deep Cleanup**: Процедура рекурсивного разрыва всех внутренних связей аудио-графа при завершении ноты.
3.  **LFO Tracking**: Все статические осцилляторы (Leslie, Phaser) отслеживаются и принудительно останавливаются при смене пресета.

---

### 5. Гитарное Моделирование

Внедрена физика реального инструмента:
*   **Pick Attack**: Шумовой транзиент в начале каждой ноты.
*   **Comb Filtering**: Эмуляция фазового "стекла" Stratocaster (2.5мс).
*   **Vintage Drive**: Математически точная Arctan-Sinh кривая сатурации.
*   **Virtuoso Logic**: Дробление длинных нот на быстрые пассажи (Subdivision).

---

### 6. Контракты Данных

**`FractalEvent` (Единица Партитуры):**
```typescript
export interface FractalEvent {
  type: InstrumentType | InstrumentType[];
  note: number;
  duration: number; // Длительность в долях (самозавершающиеся ноты)
  time: number;
  weight: number;
  technique: Technique;
  params?: any;
}
```

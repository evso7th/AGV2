# Журнал Проекта "AuraGroove"

Этот документ является "живой спецификацией" и содержит историю ключевых решений и изменений, принятых в ходе разработки. Он служит "внешней памятью" для отслеживания эволюции проекта.

---

### ЗАПИСЬ: 2024-08-27

**ЗАДАЧА:**
Еще раз уменьшить громкость звуковых эффектов (SFX) для более тонкой интеграции в микс.

**ПРИЧИНА:**
Даже после предыдущего уменьшения, SFX в некоторых случаях все еще были слишком заметны. Требовалась дальнейшая корректировка баланса.

**РЕШЕНИЕ:**
В файле `src/lib/sfx-synth-manager.ts` значение гейна предусилителя `this.preamp.gain.value` было уменьшено еще в два раза, с `0.5` до `0.25`.

**РЕЗУЛЬТАТ:**
Громкость всех звуковых эффектов была дополнительно снижена, что позволяет им выполнять свою функцию фоновой текстуры, не отвлекая от основной музыки.

---

### ЗАПИСЬ: 2024-08-26

**ЗАДАЧА:**
Для настроения "Dark" сделать гармоническую партию более выразительной и глубокой, используя скрипку и флейту в низком регистре для создания "виолончельного" эффекта.

**ПРИЧИНА:**
Текущая гармония для "Dark" настроения была недостаточно выразительной. Требовалось обогатить тембровую палитру и сделать звучание более мрачным и насыщенным.

**РЕШЕНИЕ:**
Задача была решена полностью декларативно, путем модификации **только** файла `src/lib/blueprints.ts`, без изменения кода движка.
1.  **Настройка вероятностей:** В `DarkAmbientBlueprint`, в частях `BUILD` и `MAIN`, были изменены веса в блоке `instrumentation.harmony`. Вероятность выбора `violin` и `flute` была значительно повышена, а `guitarChords` — понижена.
2.  **Настройка регистра:** Базовая октава (`musical.key.octave`) для всего `DarkAmbientBlueprint` была понижена с `2` до `1`. Это заставляет сэмплеры подбирать более низкие ноты для всех инструментов, включая скрипку, что естественным образом создает желаемый глубокий, "виолончельный" тембр.
3.  Для достижения этого результата не потребовалось изменять логику движка, что подтверждает гибкость архитектуры блюпринтов.

**РЕЗУЛЬТАТ:**
Теперь в `DarkAmbientBlueprint` гармоническая партия чаще исполняется скрипкой и флейтой и звучит в более низком, насыщенном регистре, что соответствует заданному мрачному настроению.

---

### ЗАПИСЬ: 2024-08-25

**ЗАДАЧА:**
Снизить громкость звуковых эффектов (SFX), чтобы они лучше вписывались в общий микс и не отвлекали внимание.

**ПРИЧИНА:**
В некоторых аранжировках SFX звучали слишком громко по сравнению с музыкальными элементами, нарушая баланс.

**РЕШЕНИЕ:**
В файле `src/lib/sfx-synth-manager.ts`, в конструкторе класса `SfxSynthManager`, значение предусилителя `this.preamp.gain.value` было уменьшено с `1.0` до `0.5`.

**РЕЗУЛЬТАТ:**
Все звуковые эффекты теперь по умолчанию играют в два раза тише, что позволяет им служить фоновой текстурой, а не доминирующим элементом.

---

### ЗАПИСЬ: 2024-08-24

**ЗАДАЧА:**
Добавить в плотные секции `DarkAmbientBlueprint` мощный, дублирующий бас аккомпанемент для создания "стены звука", но реализовать это как управляемое правило, а не хардкод.

**ПРИЧИНА:**
Прямое добавление логики дублирования в движок `FractalMusicEngine` затронуло бы все музыкальные стили, что неприемлемо. Правильный подход — расширить "язык" блюпринтов, чтобы они сами могли запрашивать такое поведение.

**РЕШЕНИЕ:**
1.  **Расширен `BlueprintPart` (`src/types/music.ts`):** Добавлено новое опциональное поле `bassAccompanimentDouble`, которое позволяет любой части блюпринта заказать дублирование басовой линии.
2.  **Обновлен `DarkAmbientBlueprint` (`src/lib/blueprints.ts`):** В частях `BUILD` и `MAIN` этого блюпринта было добавлено правило `bassAccompanimentDouble: { enabled: true, instrument: 'synth', octaveShift: 1 }`. Интро-секция осталась нетронутой.
3.  **Обновлен `FractalMusicEngine` (`src/lib/fractal-music-engine.ts`):** В `generateOneBar` добавлена проверка на наличие `bassAccompanimentDouble` в текущей части. Если правило активно, движок генерирует копию басовой партии с указанными параметрами (инструмент, сдвиг октавы).

**РЕЗУЛЬТАТ:**
Теперь только в основных частях `DarkAmbientBlueprint` звучит мощный синтезаторный дубль баса, как и требовалось. Решение полностью управляется через блюпринты и не затрагивает другие стили, что соответствует архитектурным принципам проекта.

---

### ЗАПИСЬ: 2024-08-23

**ЗАДАЧА:**
Исправить тишину в секции `INTRO_1` для настроения "Melancholic".

**ПРИЧИНА:**
Моя предыдущая логика для генерации аккомпанемента в интро-секциях была ошибочно привязана к наличию событий ударных. В блюпринте `MelancholicAmbientBlueprint` для `INTRO_1` ударные были отключены (`drums: false`), из-за чего не генерировались ни ударные, ни, как следствие, аккомпанемент, что и приводило к полной тишине.

**РЕШЕНИЕ:**
Вместо усложнения кода движка, было принято более простое и правильное решение — изменить сам блюпринт. В файле `src/lib/blueprints.ts` для `MelancholicAmbientBlueprint`, в секции `INTRO_1`:
1.  Свойство `layers` было изменено на `{ accompaniment: true, harmony: false, sfx: false, sparkles: false, drums: true }`, чтобы разрешить работу генератора ударных.
2.  Были добавлены `instrumentRules` для `drums`, предписывающие использовать очень низкую плотность и только перкуссионные сэмплы, что соответствует желаемой "ритуальной" атмосфере.

**РЕЗУЛЬТАТ:**
Теперь в `INTRO_1` с самого начала генерируется тихая, атмосферная перкуссия. Это, в свою очередь, запускает генерацию пульсирующих арпеджио аккомпанемента, как и было задумано, полностью решая проблему тишины.

---

### ЗАПИСЬ: 2024-08-22

**ЗАДАЧА:**
Исправить критическую ошибку сборки, вызванную некорректным синтаксисом в файле `fractal-music-engine.ts`.

**ПРИЧИНА:**
Во время предыдущего изменения кода (`ДЕЛАЙ 229`) я по ошибке не завершил строку кода в методе `evolve`. Строка `const { events, instrumentHints } = this.generateOne` была неполной, и, кроме того, отсутствовал оператор `return` и закрывающая фигурная скобка `}` для самого метода. Это привело к `SyntaxError: Expected '}', got '<eof>'`.

**РЕШЕНИЕ:**
1.  В файле `src/lib/fractal-music-engine.ts` была исправлена незавершенная строка на `const { events, instrumentHints } = this.generateOneBar(barDuration, navigationInfo);`.
2.  Добавлен оператор `return { events, instrumentHints };`.
3.  Добавлена недостающая закрывающая фигурная скобка `}` для метода `evolve`.

**РЕЗУЛЬТАТ:**
Синтаксическая ошибка устранена, и проект снова может быть успешно собран.

---

### ЗАПИСЬ: 2024-08-21

**ЗАДАЧА:**
Улучшить атмосферу интро-секций и добавить выразительности басовым партиям.

**РЕШЕНИЕ:**
В файле `src/lib/fractal-music-engine.ts` были внесены два ключевых изменения:
1.  **Пульсирующие Арпеджио:**
    *   Создана новая приватная функция `_createArpeggiatedChordSwell`, которая генерирует быстрые арпеджио из 4 нот с длинным затуханием.
    *   Логика генерации для интро-секций в `generateOneBar` была переписана. Теперь она использует новую функцию для создания арпеджио, которое "рождается" каждым ударом перкуссии, создавая богатую, пульсирующую текстуру.
2.  **Динамический Глайд (Portamento):**
    *   В функции `generateAmbientBassPhrase` была добавлена логика, которая увеличивает значение `portamento` для басовых нот с большой длительностью.

**РЕЗУЛЬТАТ:**
Интро-секции теперь звучат значительно глубже и атмосфернее за счет синхронизации арпеджио с ритмом. Басовые партии стали более "живыми" и "тягучими" на длинных нотах, что усиливает медитативный эффект.

---

### ЗАПИСЬ: 2024-08-20

**ЗАДАЧА:**
Добавить в интро-секцию для настроения "Dark" атмосферную перкуссию, чтобы сразу задать нужный мрачный и ритуальный тон.

**РЕШЕНИЕ:**
1.  В файле `src/lib/blueprints.ts` был модифицирован `DarkAmbientBlueprint`.
2.  В определении части `INTRO` было добавлено `drums: true` в свойство `layers`, что разрешило генератору ударных работать в этой секции.
3.  Там же были добавлены `instrumentRules` для `drums`, которые предписывают генератору использовать очень низкую плотность (`density: { min: 0.1, max: 0.3 }`) и флаги, предписывающие использовать преимущественно перкуссию и редкие удары бочки, исключая малый барабан.

**РЕЗУЛЬТАТ:**
В приложении появилось новое звучание, сочетающее тяжесть риффов в стиле Black Sabbath с медитативной, текстурной ритмикой эмбиента.


# Журнал Проекта "AuraGroove"

---

### ЗАПИСЬ: 2024-12-04 (План №37: "Оптимизация и Тотальный Контроль")

**ПРОБЛЕМА:**
1. Легкие потрескивания (CPU spikes) при игре аккордами.
2. Слышимые частотные биения («подвывания») в органе.
3. Отсутствие визуального контроля за количеством активных аудио-нод в консоли.

**ПРИЧИНА:**
1. Тяжелая операция `createPeriodicWave` вызывалась внутри `noteOn` для каждого регистра (36 раз на аккорд), перегружая CPU.
2. Остаточная связь Vibrato LFO с `detune` осцилляторов вызывала плавание строя.
3. Логи очистки были, но не было суммарного счетчика «живых» голосов.

**РЕШЕНИЕ:**
1. **Static Waveform Optimization**: Создание `tonewheelWave` вынесено за пределы `noteOn`. Теперь все ноты используют одну пре-генерированную волну.
2. **Чистый Строй**: Удалена любая модуляция высоты тона в органе. Leslie теперь работает исключительно через амплитуду и фильтрацию.
3. **Audio Monitor**: Внедрен глобальный счетчик `globalActiveVoices` с выводом в консоль каждые 2 секунды.
4. **CPU Relief**: Oversampling дисторшна снижен до `2x`, что критично для мобильной производительности.

**РЕЗУЛЬТАТ:**
Треск устранен. Строй органа идеально стабилен. Мы получили инструмент для визуального контроля утечек памяти в реальном времени.

---

### ЗАПИСЬ: 2024-12-04 (План №36: "Герметизация и Исправление Ошибок")

**ПРОБЛЕМА:**
1. Runtime Error: `DRAWBAR_RATIOS is not defined`.
2. Накопительная утечка памяти, приводящая к краху через 40 секунд.

**ПРИЧИНА:**
1. Константа `DRAWBAR_RATIOS` была использована в органном движке, но не определена в файле фабрики.
2. Ноды `voiceGain` во всех конвейерах (`synth`, `organ`, `bass`, `guitar`) не отсоединялись от аудио-графа после завершения звука, перегружая CPU.

**РЕШЕНИЕ:**
1. **Фикс Константы**: В файл `src/lib/instrument-factory.ts` добавлено определение `DRAWBAR_RATIOS`.
2. **Note Lifecycle Protocol**: Во все конвейеры синтеза внедрена строгая логика отсоединения нод через `setTimeout` после завершения release-стадии.
3. **Восстановление Прозрачности**: Возвращены логи строительства пайплайнов для контроля архитектуры в консоли.

**РЕЗУЛЬТАТ:**
Система полностью стабильна. Утечка памяти устранена. Орган работает корректно и чисто.

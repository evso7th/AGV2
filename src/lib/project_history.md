
# Журнал Проекта "AuraGroove"

---

### ЗАПИСЬ: 2024-12-04 (План №250: «FIRESTORE PERMISSIONS ULTIMATUM»)

**ПРОБЛЕМА:**
Несмотря на открытые правила, анонимная запись через `addDoc` приводила к ошибке `Missing or insufficient permissions`. В логах путь запроса отображался без ID документа, что препятствовало срабатыванию правил.

**РЕШЕНИЕ:**
1. **Deterministic Writing**: Функция `saveMasterpiece` переведена на использование `setDoc` с предварительной генерацией ID на клиенте через `doc(collection(...))`. Это гарантирует наличие ID в пути запроса.
2. **Rule Generalization**: В `firestore.rules` путь для `masterpieces` изменен на `{document=**}` для охвата любых вложенных структур и обеспечения стопроцентного совпадения.
3. **Purity**: Удалены все потенциальные причины блокировки анонимной записи.

---

### ЗАПИСЬ: 2024-12-04 (План №249: «FIRESTORE PUBLIC WRITE ENFORCEMENT»)

**ПРОБЛЕМА:**
Даже после открытия прав на создание (create), анонимные пользователи получали отказ. Вероятная причина — отсутствие базового права на чтение (read) и проблемы с сериализацией instrumentSettings.

**РЕШЕНИЕ:**
1. **Public Read/Write**: В `firestore.rules` правила для `masterpieces` упрощены и расширены до `allow read, create: if true;`.
2. **Payload Sanitization**: В `saveMasterpiece` добавлена глубокая очистка объекта `instrumentSettings` через `JSON.parse(JSON.stringify())` перед отправкой.
3. **Stability**: Обеспечен беспрепятственный доступ к глобальному генофонду.

---

### ЗАПИСЬ: 2024-12-04 (План №248: «FIREBASE PERMISSIONS FIX & CONTEXTUAL AUDIT»)

**ПРОБЛЕМА:**
Несмотря на открытые правила Firestore, возникала ошибка `Missing or insufficient permissions` при сохранении Шедевров. Отсутствие детальной информации об ошибке мешало диагностике.

**РЕШЕНИЕ:**
1. **Contextual Audit**: Сохранение Шедевров переведено на архитектуру контекстных ошибок. Теперь при неудаче создается `FirestorePermissionError` с полным дампом запроса (`request`).
2. **Non-Blocking Logic**: Удалены `async/await` и `try/catch` из цепочки сохранения согласно правилу "Avoid Awaiting Mutation Calls".
3. **Rules Priority**: Правило для коллекции `masterpieces` перемещено в начало списка в `firestore.rules` для исключения перекрытия другими путями.
4. **UI Standards**: Удалены тосты об успехе сохранения, оставлена только системная диагностика ошибок.

---

### ЗАПИСЬ: 2024-12-04 (План №247: «BPM REALITY & UI SIMPLIFICATION»)

**ПРОБЛЕМА:**
1. Темп пьесы выбирается динамически при зачатии, но UI слайдер оставался на старом значении, создавая диссонанс между визуальным и аудиальным восприятием.
2. Параметр `Intro Length` в UI признан избыточным, так как логика вступления теперь полностью управляется Блюпринтом.
3. Отсутствие BPM в детальных логах баров мешало анализу темпоральной вариативности.

**РЕШЕНИЕ:**
1. **BPM Feedback Loop**: Воркер теперь синхронизирует свои настройки с темпом, установленным ДНК движка, и отправляет `actualBpm` в UI при каждом такте.
2. **Dynamic UI Update**: Хук `useAuraGroove` теперь слушает сообщения от воркера и обновляет состояние `bpm`, заставляя интерфейс отражать реальность.
3. **UI Cleanup**: Слайдер `Intro Length` удален из интерфейса. Слайдер `BPM` теперь блокируется во время игры, если включен автопилот композитора.
4. **Log Enrichment**: В бар-логи добавлен вывод текущего BPM.
5. **Purity**: Интерфейс стал чище, а телеметрия — точнее.

---

### ЗАПИСЬ: 2024-12-04 (План №246: «CHRONOS ALIGNMENT & TEMPO VARIETY»)

**ПРОБЛЕМА:**
1. Баг синхронизации: в логах отображался режим `PROMENADE` на 50-м такте. Причина — `FractalMusicEngine` всегда загружал MAIN блюпринт, игнорируя инструкции Воркера о проигрывании короткого моста (BRIDGE).
2. Ощущение "мертвой музыки" в Dark Blues: слишком резкое исчезновение инструментов в фазе накопления.
3. Отсутствие темпоральной вариативности: все пьесы игрались в одном темпе.

**РЕШЕНИЕ:**
1. **Chronos Alignment**: В `FractalMusicEngine` внедрена передача Блюпринта через конструктор. Теперь Воркер полностью контролирует, какой "мир" (Мост или Основной) строит движок. Баг синхронизации Цепи Сюит устранен.
2. **BPM Normalization**: Расширены коридоры BPM во всех блюзовых блюпринтах. Теперь нижний предел для Melancholic и Dark установлен на 60 BPM, а для Joyful — до 110 BPM. Темп выбирается один раз при "зачатии" пьесы.
3. **Dark Blues Vitality**: В `DarkBluesBlueprint` мелодия разрешена к активации на ранних стадиях (BUILD), что устраняет эффект пустоты в середине пьесы.
4. **Purity**: Достигнута архитектурная гармония между планировщиком (Воркер) и исполнителем (Движок).

# Журнал Проекта "AuraGroove"

Этот документ является "живой спецификацией" и содержит историю ключевых решений и изменений, принятых в ходе разработки. Он служит "внешней памятью" для отслеживания эволюции проекта.

---

### ЗАПИСЬ: 2024-09-07

**ЗАДАЧА:**
Создать новый музыкальный стиль "Contemplative Ambient" для генерации сфокусированной и минималистичной музыки, завершив таким образом создание уникальных блюпринтов для всех девяти настроений.

**ПРИЧИНА:**
Для настроения `contemplative` в качестве заглушки использовался `CalmAmbientBlueprint`. Требовалось создать уникальный стиль, соответствующий "созерцательному" звучанию.

**РЕШЕНИЕ:**
1.  **Создан `NeutralAmbientBlueprint`:** В файле `src/lib/blueprints.ts` был добавлен новый блюпринт, который будет служить основой для созерцательного настроения.
2.  **Настроены параметры:** На основе документа `Ambient_Blueprints_moods.txt`, новому блюпринту были заданы сбалансированные характеристики:
    *   **Темп:** `56 BPM`.
    *   **Лад:** `D Ionian`.
    *   **Структура:** Симметричная форма для предсказуемости.
    *   **Инструменты:** Акцент на чистые тембры: `piano`, `synth`, `acousticGuitar`.
    *   **Ударные:** Минималистичные, для задания темпа без создания грува.
3.  **Обновлена библиотека:** В `BLUEPRINT_LIBRARY` ключ `contemplative` был перенаправлен на новый `NeutralAmbientBlueprint`.

**РЕЗУЛЬТАТ:**
В приложении появился последний уникальный стиль "Contemplative". Теперь каждое из девяти доступных настроений имеет свой собственный, тщательно проработанный блюпринт, что значительно расширяет музыкальную и эмоциональную палитру проекта.

---

### ЗАПИСЬ: 2024-09-06

**ЗАДАЧА:**
Создать новый музыкальный стиль "Anxious Ambient" для генерации напряженной и беспокойной музыки.

**ПРИЧИНА:**
В библиотеке блюпринтов для настроения `anxious` использовался `DarkAmbientBlueprint` в качестве заглушки. Требовалось создать уникальный блюпринт, соответствующий "тревожному" звучанию.

**РЕШЕНИЕ:**
1.  **Создан `AnxiousAmbientBlueprint`:** В файле `src/lib/blueprints.ts` был добавлен новый блюпринт.
2.  **Настроены параметры:** Блюпринту заданы характеристики "тревожной" музыки:
    *   **Темп:** `66 BPM`.
    *   **Лад:** `E Phrygian` для создания напряжения.
    *   **Структура:** Короткие, резко сменяющиеся части.
    *   **Инструменты:** Акцент на резкие `synth` и "нервный" `theremin`.
    *   **Особые события:** Увеличена частота SFX из категорий `dark` и `laser` для создания неожиданных, резких звуков.
3.  **Обновлена библиотека:** В `BLUEPRINT_LIBRARY` ключ `anxious` был перенаправлен на новый `AnxiousAmbientBlueprint`.

**РЕЗУЛЬТАТ:**
В приложении появился новый уникальный стиль "Anxious", генерирующий напряженную, гипнотическую эмбиент-музыку. Ошибка с использованием неправильного блюпринта устранена.

---

### ЗАПИСЬ: 2024-09-05

**ЗАДАЧА:**
Создать новый музыкальный стиль "Dreamy Ambient", чтобы расширить палитру доступных настроений и заменить временную заглушку.

**ПРИЧИНА:**
В библиотеке блюпринтов для настроения `dreamy` использовался `DarkAmbientBlueprint`, что было некорректно. Требовалось создать уникальный блюпринт, соответствующий "мечтательному" звучанию.

**РЕШЕНИЕ:**
1.  **Создан `DreamyAmbientBlueprint`:** В файле `src/lib/blueprints.ts` был добавлен новый блюпринт, основанный на спецификациях из документа `Ambient_Blueprints_moods.txt`.
2.  **Настроены параметры:** Блюпринту заданы характеристики "мечтательной" музыки:
    *   **Темп:** `58 BPM`.
    *   **Лад:** `F Lydian` для создания "космического", парящего звучания.
    *   **Структура:** Длинная основная часть для имитации "дрейфа".
    *   **Инструменты:** Акцент на воздушные `ambientPad` и `synth`.
    *   **События:** Увеличена частота `sparkle` и `shimmer_burst` для создания эффекта "звездной пыли".
3.  **Обновлена библиотека:** В `BLUEPRINT_LIBRARY` ключ `dreamy` был перенаправлен на новый `DreamyAmbientBlueprint`.

**РЕЗУЛЬТАТ:**
В приложении появился новый уникальный стиль "Dreamy", генерирующий воздушную, светящуюся эмбиент-музыку. Ошибка с использованием неправильного блюпринта устранена.

---

### ЗАПИСЬ: 2024-09-04

**ЗАДАЧА:**
Исправить критическую ошибку сборки `ReferenceError: JoyfulAmbientBlueprint is not defined`.

**ПРИЧИНА:**
При создании `EpicAmbientBlueprint` я ошибочно сослался в `BLUEPRINT_LIBRARY` на `JoyfulAmbientBlueprint`, который еще не был определен в коде. Это привело к ошибке во время выполнения.

**РЕШЕНИЕ:**
1.  **Создан `JoyfulAmbientBlueprint`:** В файле `src/lib/blueprints.ts` был добавлен новый блюпринт для "радостного" настроения, основанный на ранее согласованном документе `Ambient_Blueprints_moods.txt`. Ему были заданы соответствующие параметры: быстрый темп (`62 BPM`), яркий лад (`C Ionian`) и высокая плотность событий.
2.  **Проверена библиотека:** В `BLUEPRINT_LIBRARY` была проверена корректность ссылки на теперь уже существующий `JoyfulAmbientBlueprint`.

**РЕЗУЛЬТАТ:**
Ошибка сборки устранена. Проект пополнился новым музыкальным стилем "Joyful", что завершило формирование палитры "позитивных" настроений.

---

### ЗАПИСЬ: 2024-09-03

**ЗАДАЧА:**
Создать новый музыкальный стиль "Epic Ambient" для генерации величественной и масштабной музыки.

**ПРИЧИНА:**
После успешного создания стилей "Enthusiastic" и "Calm" возникла необходимость расширить палитру "позитивных" настроений, добавив в нее эпическое, героическое звучание.

**РЕШЕНИЕ:**
1.  **Создан `EpicAmbientBlueprint`:** В файле `src/lib/blueprints.ts` был добавлен новый блюпринт.
2.  **Настроены параметры:** Блюпринту заданы характеристики эпической музыки: медленный, но уверенный темп (`62 BPM`), величественный лад `D Ionian`, структура с очень длинным нарастанием и кульминацией, а также использование мощных, "хоровых" тембров (`organ`, `mellotron`, `violin`).
3.  **Обновлена библиотека:** В `BLUEPRINT_LIBRARY` ключ `epic` теперь указывает на новый `EpicAmbientBlueprint`, делая его самостоятельным и уникальным стилем.

**РЕЗУЛЬТАТ:**
В приложении появился новый музыкальный стиль "Epic", способный генерировать масштабные, торжественные и воодушевляющие эмбиент-композиции.

---

### ЗАПИСЬ: 2024-09-02

**ЗАДАЧА:**
Еще раз увеличить громкость звуковых эффектов (SFX) для лучшего баланса в миксе.

**ПРИЧИНА:**
После предыдущего уменьшения, а затем увеличения громкости, мы продолжаем итеративно искать идеальный баланс, где SFX будут заметны, но не навязчивы.

**РЕШЕНИЕ:**
В файле `src/lib/sfx-synth-manager.ts` значение гейна предусилителя `this.preamp.gain.value` было увеличено с `0.25` до `0.5`.

**РЕЗУЛЬТАТ:**
Громкость всех звуковых эффектов была удвоена. Мы продолжаем итеративно настраивать микс.

---

### ЗАПИСЬ: 2024-09-01

**ЗАДАЧА:**
Сделать стиль "Dark Ambient" более атмосферным за счет более частого использования звуковых эффектов, в частности "голосов".

**ПРИЧИНА:**
Текущая реализация SFX была слишком редкой и не использовала тематические сэмплы, что делало "Dark Ambient" недостаточно выразительным.

**РЕШЕНИЕ:**
1.  **Расширен `FractalEvent` (`src/types/fractal.ts`):** Добавлена структура `SfxRule` для декларативного управления категориями и вероятностью SFX.
2.  **Модифицирован `SfxSynthManager` (`src/lib/sfx-synth-manager.ts`):** Менеджер научился читать `SfxRule` и выбирать категорию сэмплов (`voice`, `dark` и т.д.) на основе весов.
3.  **Обновлен `DarkAmbientBlueprint` (`src/lib/blueprints.ts`):** В части `BUILD` и `MAIN` добавлены `instrumentRules` для `sfx`, которые увеличивают вероятность их появления до 25% и задают приоритет для категории `voice` (60%).
4.  **Адаптирован `FractalMusicEngine` (`src/lib/fractal-music-engine.ts`):** Движок теперь считывает новые `sfx` правила из блюпринта и передает их менеджеру.

**РЕЗУЛЬТАТ:**
"Dark Ambient" стал значительно более жутким и атмосферным. Секции `BUILD` и `MAIN` теперь насыщены "голосами" и другими тематическими звуковыми эффектами, что соответствует творческому замыслу.

---

### ЗАПИСЬ: 2024-08-31

**ЗАДАЧА:**
Заполнить 5-секундную паузу между музыкальными сюитами, чтобы создать непрерывный звуковой опыт.

**ПРИЧИНА:**
Текущая реализация "Променада" (переходной секции) была слишком минималистичной и создавала резкую, неприятную тишину, которая нарушала медитативную атмосферу.

**РЕШЕНИЕ:**
В файле `src/lib/fractal-music-engine.ts` была полностью переработана логика метода `_generatePromenade`. Новая версия создает богатую 4-тактовую эмбиент-интерлюдию, включающую в себя:
1.  **Фундамент:** Глубокий, протяжный дрон на басу и пэде.
2.  **Текстуру:** Тихая, атмосферная перкуссия, созданная из сэмплов `perc-*`, как и было согласовано.
3.  **Атмосферу:** Фоновый звуковой эффект (SFX), добавляющий пространственности.
4.  **Акцент:** Одиночное событие "sparkle" (мелодическая искра) в середине перехода для привлечения внимания.

**РЕЗУЛЬТАТ:**
Тишина между сюитами полностью устранена. Переходы стали плавными, бесшовными и музыкально осмысленными, поддерживая общую атмосферу и не прерывая поток прослушивания.

---

### ЗАПИСЬ: 2024-08-30

**ЗАДАЧА:**
Создать новый музыкальный стиль "Calm Ambient", который будет генерировать спокойную, теплую и умиротворяющую музыку.

**ПРИЧИНА:**
Пользователь запросил создание нового стиля для релаксации, основываясь на ранее согласованном документе `Ambient_Blueprints_moods.txt`.

**РЕШЕНИЕ:**
1.  **Создан новый блюпринт:** В файле `src/lib/blueprints.ts` был добавлен `CalmAmbientBlueprint`.
2.  **Настроены параметры:** На основе документации, новому блюпринту были заданы ключевые характеристики:
    *   **Темп:** `54 BPM` (медленный, медитативный).
    *   **Лад:** `G Mixolydian` (светлый, но спокойный мажор).
    *   **Структура:** Сбалансированная форма с плавной динамикой.
    *   **Инструменты:** Предпочтение отдается мягким тембрам: `ambientPad`, `organ`, `piano`.
    *   **Атмосфера:** В блюпринт добавлены правила для `ambientEvents`, увеличивающие вероятность появления событий `sparkle` и `sfx`, которые, согласно логике `SparklePlayer` и `SfxSynthManager`, будут выбирать сэмплы колокольчиков и звуков воды, создавая природную, умиротворяющую атмосферу.
3.  **Интеграция:** Новый блюпринт был добавлен в `BLUEPRINT_LIBRARY` под ключом `calm`.

**РЕЗУЛЬТАТ:**
В приложении появился новый музыкальный стиль "Calm", расширяющий палитру доступных настроений. Стиль генерирует медленную, обволакивающую музыку, идеально подходящую для медитации и релаксации.

---

### ЗАПИСЬ: 2024-08-29

**ЗАДАЧА:**
Создать новый музыкальный стиль "Enthusiastic Ambient", который сочетает энергию и оптимизм с эмбиент-текстурами.

**ПРИЧИНА:**
Пользователь запросил нетривиальную творческую задачу: перевести дух "Марша энтузиастов" Дунаевского на язык генеративной эмбиент-музыки.

**РЕШЕНИЕ:**
1.  **Создан новый блюпринт:** В файле `src/lib/blueprints.ts` был добавлен `EnthusiasticAmbientBlueprint`.
2.  **Настроены параметры:** На основе предоставленного пользователем документа `Ambient_Blueprints_moods.txt`, новому блюпринту были заданы ключевые характеристики:
    *   **Темп:** `68 BPM` (высокий для эмбиента).
    *   **Лад:** `E Lydian` (яркий, "космический" мажор).
    *   **Структура:** Быстрое вступление всех инструментов и длинная основная часть для создания ощущения "полета".
    *   **Инструменты:** Яркие синтезаторы и пульсирующие басовые линии.
3.  **Интеграция:** Новый блюпринт был добавлен в `BLUEPRINT_LIBRARY` под ключом `enthusiastic`.

**РЕЗУЛЬТАТ:**
В приложении появился новый музыкальный стиль, генерирующий быструю, яркую и восторженную эмбиент-музыку. Это расширяет творческую палитру проекта и демонстрирует гибкость системы блюпринтов, способной решать сложные музыкальные задачи декларативно.

---

### ЗАПИСЬ: 2024-08-28

**ЗАДАЧА:**
Заполнить 5-секундную паузу между музыкальными сюитами, чтобы создать непрерывный звуковой опыт.

**ПРИЧИНА:**
Текущая реализация "Променада" (переходной секции) была слишком минималистичной и создавала резкую, неприятную тишину, которая нарушала медитативную атмосферу.

**РЕШЕНИЕ:**
В файле `src/lib/fractal-music-engine.ts` была полностью переработана логика метода `_generatePromenade`. Новая версия создает богатую 4-тактовую эмбиент-интерлюдию, включающую в себя:
1.  **Фундамент:** Глубокий, протяжный дрон на басу и пэде.
2.  **Текстуру:** Тихая, атмосферная перкуссия, созданная из сэмплов `perc-*`, как и было согласовано.
3.  **Атмосферу:** Фоновый звуковой эффект (SFX), добавляющий пространственности.
4.  **Акцент:** Одиночное событие "sparkle" (мелодическая искра) в середине перехода для привлечения внимания.

**РЕЗУЛЬТАТ:**
Тишина между сюитами полностью устранена. Переходы стали плавными, бесшовными и музыкально осмысленными, поддерживая общую атмосферу и не прерывая поток прослушивания.

---

### ЗАПИСЬ: 2024-08-27

**ЗАДАЧА:**
Еще раз уменьшить громкость звуковых эффектов (SFX) для более тонкой интеграции в микс.

**ПРИЧИНА:**
Даже после предыдущего уменьшения, SFX в некоторых случаях все еще были слишком заметны. Требовалась дальнейшая корректировка баланса.

**РЕШЕНИЕ:**
В файле `src/lib/sfx-synth-manager.ts` значение гейна предусилителя `this.preamp.gain.value` было уменьшено еще в два раза, с `0.5` до `0.25`.

**РЕЗУЛЬТАТ:**
Громкость всех звуковых эффектов была дополнительно снижена, что позволяет им выполнять свою функцию фоновой текстуры, не отвлекая от основной музыки.

---

### ЗАПИСЬ: 2024-08-26

**ЗАДАЧА:**
Для настроения "Dark" сделать гармоническую партию более выразительной и глубокой, используя скрипку и флейту в низком регистре для создания "виолончельного" эффекта.

**ПРИЧИНА:**
Текущая гармония для "Dark" настроения была недостаточно выразительной. Требовалось обогатить тембровую палитру и сделать звучание более мрачным и насыщенным.

**РЕШЕНИЕ:**
Задача была решена полностью декларативно, путем модификации **только** файла `src/lib/blueprints.ts`, без изменения кода движка.
1.  **Настройка вероятностей:** В `DarkAmbientBlueprint`, в частях `BUILD` и `MAIN`, были изменены веса в блоке `instrumentation.harmony`. Вероятность выбора `violin` и `flute` была значительно повышена, а `guitarChords` — понижена.
2.  **Настройка регистра:** Базовая октава (`musical.key.octave`) для всего `DarkAmbientBlueprint` была понижена с `2` до `1`. Это заставляет сэмплеры подбирать более низкие ноты для всех инструментов, включая скрипку, что естественным образом создает желаемый глубокий, "виолончельный" тембр.
3.  Для достижения этого результата не потребовалось изменять логику движка, что подтверждает гибкость архитектуры блюпринтов.

**РЕЗУЛЬТАТ:**
Теперь в `DarkAmbientBlueprint` гармоническая партия чаще исполняется скрипкой и флейтой и звучит в более низком, насыщенном регистре, что соответствует заданному мрачному настроению.

---

### ЗАПИСЬ: 2024-08-25

**ЗАДАЧА:**
Снизить громкость звуковых эффектов (SFX), чтобы они лучше вписывались в общий микс и не отвлекали внимание.

**ПРИЧИНА:**
В некоторых аранжировках SFX звучали слишком громко по сравнению с музыкальными элементами, нарушая баланс.

**РЕШЕНИЕ:**
В файле `src/lib/sfx-synth-manager.ts`, в конструкторе класса `SfxSynthManager`, значение предусилителя `this.preamp.gain.value` было уменьшено с `1.0` до `0.5`.

**РЕЗУЛЬТАТ:**
Все звуковые эффекты теперь по умолчанию играют в два раза тише, что позволяет им служить фоновой текстурой, а не доминирующим элементом.

---

### ЗАПИСЬ: 2024-08-24

**ЗАДАЧА:**
Добавить в плотные секции `DarkAmbientBlueprint` мощный, дублирующий бас аккомпанемент для создания "стены звука", но реализовать это как управляемое правило, а не хардкод.

**ПРИЧИНА:**
Прямое добавление логики дублирования в движок `FractalMusicEngine` затронуло бы все музыкальные стили, что неприемлемо. Правильный подход — расширить "язык" блюпринтов, чтобы они сами могли запрашивать такое поведение.

**РЕШЕНИЕ:**
1.  **Расширен `BlueprintPart` (`src/types/music.ts`):** Добавлено новое опциональное поле `bassAccompanimentDouble`, которое позволяет любой части блюпринта заказать дублирование басовой линии.
2.  **Обновлен `DarkAmbientBlueprint` (`src/lib/blueprints.ts`):** В частях `BUILD` и `MAIN` этого блюпринта было добавлено правило `bassAccompanimentDouble: { enabled: true, instrument: 'synth', octaveShift: 1 }`. Интро-секция осталась нетронутой.
3.  **Обновлен `FractalMusicEngine` (`src/lib/fractal-music-engine.ts`):** В `generateOneBar` добавлена проверка на наличие правила `bassAccompanimentDouble` в текущей части. Если правило активно, движок генерирует копию басовой партии с указанными параметрами (инструмент, сдвиг октавы).

**РЕЗУЛЬТАТ:**
Теперь только в основных частях `DarkAmbientBlueprint` звучит мощный синтезаторный дубль баса, как и требовалось. Решение полностью управляется через блюпринты и не затрагивает другие стили, что соответствует архитектурным принципам проекта.

---

### ЗАПИСЬ: 2024-08-23

**ЗАДАЧА:**
Исправить тишину в секции `INTRO_1` для настроения "Melancholic".

**ПРИЧИНА:**
Моя предыдущая логика для генерации аккомпанемента в интро-секциях была ошибочно привязана к наличию событий ударных. В блюпринте `MelancholicAmbientBlueprint` для `INTRO_1` ударные были отключены (`drums: false`), из-за чего не генерировались ни ударные, ни, как следствие, аккомпанемент, что и приводило к полной тишине.

**РЕШЕНИЕ:**
Вместо усложнения кода движка, было принято более простое и правильное решение — изменить сам блюпринт. В файле `src/lib/blueprints.ts` для `MelancholicAmbientBlueprint`, в секции `INTRO_1`:
1.  Свойство `layers` было изменено на `{ accompaniment: true, harmony: false, sfx: false, sparkles: false, drums: true }`, чтобы разрешить работу генератора ударных.
2.  Были добавлены `instrumentRules` для `drums`, предписывающие использовать очень низкую плотность (`density: { min: 0.1, max: 0.3 }`) и флаги, предписывающие использовать преимущественно перкуссию и редкие удары бочки, исключая малый барабан.

**РЕЗУЛЬТАТ:**
Теперь в `INTRO_1` с самого начала генерируется тихая, атмосферная перкуссия. Это, в свою очередь, запускает генерацию пульсирующих арпеджио аккомпанемента, как и было задумано, полностью решая проблему тишины.

---

### ЗАПИСЬ: 2024-08-22

**ЗАДАЧА:**
Исправить критическую ошибку сборки, вызванную некорректным синтаксисом в файле `fractal-music-engine.ts`.

**ПРИЧИНА:**
Во время предыдущего изменения кода (`ДЕЛАЙ 229`) я по ошибке не завершил строку кода в методе `evolve`. Строка `const { events, instrumentHints } = this.generateOne` была неполной, и, кроме того, отсутствовал оператор `return` и закрывающая фигурная скобка `}` для самого метода. Это привело к `SyntaxError: Expected '}', got '<eof>'`.

**РЕШЕНИЕ:**
1.  В файле `src/lib/fractal-music-engine.ts` была исправлена незавершенная строка на `const { events, instrumentHints } = this.generateOneBar(barDuration, navigationInfo);`.
2.  Добавлен оператор `return { events, instrumentHints };`.
3.  Добавлена недостающая закрывающая фигурная скобка `}` для метода `evolve`.

**РЕЗУЛЬТАТ:**
Синтаксическая ошибка устранена, и проект снова может быть успешно собран.

---

### ЗАПИСЬ: 2024-08-21

**ЗАДАЧА:**
Улучшить атмосферу интро-секций и добавить выразительности басовым партиям.

**РЕШЕНИЕ:**
В файле `src/lib/fractal-music-engine.ts` были внесены два ключевых изменения:
1.  **Пульсирующие Арпеджио:**
    *   Создана новая приватная функция `_createArpeggiatedChordSwell`, которая генерирует быстрые арпеджио из 4 нот с длинным затуханием.
    *   Логика генерации для интро-секций в `generateOneBar` была переписана. Теперь она использует новую функцию для создания арпеджио, которое "рождается" каждым ударом перкуссии, создавая богатую, пульсирующую текстуру.
2.  **Динамический Глайд (Portamento):**
    *   В функции `generateAmbientBassPhrase` была добавлена логика, которая увеличивает значение `portamento` для басовых нот с большой длительностью.

**РЕЗУЛЬТАТ:**
Интро-секции теперь звучат значительно глубже и атмосфернее за счет синхронизации арпеджио с ритмом. Басовые партии стали более "живыми" и "тягучими" на длинных нотах, что усиливает медитативный эффект.

---

### ЗАПИСЬ: 2024-08-20

**ЗАДАЧА:**
Добавить в интро-секцию для настроения "Dark" атмосферную перкуссию, чтобы сразу задать нужный мрачный и ритуальный тон.

**РЕШЕНИЕ:**
1.  В файле `src/lib/blueprints.ts` был модифицирован `DarkAmbientBlueprint`.
2.  В определении части `INTRO` было добавлено `drums: true` в свойство `layers`, что разрешило генератору ударных работать в этой секции.
3.  Там же были добавлены `instrumentRules` для `drums`, которые предписывают генератору использовать очень низкую плотность (`density: { min: 0.1, max: 0.3 }`) и флаги, предписывающие использовать преимущественно перкуссию и редкие удары бочки, исключая малый барабан.

**РЕЗУЛЬТАТ:**
В приложении появилось новое звучание, сочетающее тяжесть риффов в стиле Black Sabbath с медитативной, текстурной ритмикой эмбиента.

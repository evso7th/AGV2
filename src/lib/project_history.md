
# Журнал Проекта "AuraGroove"

Этот документ является "живой спецификацией" и содержит историю ключевых решений и изменений, принятых в ходе разработки. Он служит "внешней памятью" для отслеживания эволюции проекта.

---

### ЗАПИСЬ: 2024-12-04 (План №26: "Благородный Органчик для Кафе")

**ПРОБЛЕМА:**
Профиль `organ_soft_jazz` нуждался в тонкой настройке для достижения прозрачного и теплого звучания, соответствующего атмосфере камерного кафе.

**ПРИЧИНА:**
1. Пресет содержал активную квинту (5 1/3'), дававшую лишний "носовой" окрас.
2. Фильтр LPF был слишком закрыт (3.5 кГц), что лишало Leslie "воздуха".
3. Отсутствовала мягкая огибающая ADSR.

**РЕШЕНИЕ:**
1. **Чистая Регистрация**: В `presets-v2.ts` для `organ_soft_jazz` установлен набор drawbars `[8, 0, 8, 5, 0, 3, 0, 0, 0]`. Квинта отключена.
2. **Открытие Фильтра**: LPF поднят до `7600` Гц для раскрытия обертонов.
3. **Мягкое Дыхание**: Добавлена огибающая `{ a: 0.02, d: 0.2, s: 0.9, r: 0.3 }`.
4. **Сценография**: В блюпринте `winter.ts` (INTRO_1) этот орган закреплен как основной инструмент аккомпанемента во всех четырех стадиях, при этом партия гитарных аккордов (`harmony`) сохранена для создания уютного ансамбля.

**РЕЗУЛЬТАТ:**
Звук органа стал кристально чистым, глубоким и благородным. Вступление Winter Blues теперь звучит как живое выступление в уютном заснеженном кафе.

---

### ЗАПИСЬ: 2024-12-04 (План №25: "Тотальная Интеграция Лесли")

**ПРОБЛЕМА:**
Эффект Лесли звучал как "накладка" поверх основного тона органа. Звук разделялся на неподвижный пэд и вращающийся слой, что не соответствовало акустике реального Хаммонда.

**ПРИЧИНА:**
1. В Scanner Vibrato была захардкожена смесь 50/50 (dry/wet), что создавало эффект двух параллельных голосов.
2. В модели Лесли баланс был смещен в сторону прямого сигнала, сохраняя статичный фундамент.

**РЕШЕНИЕ:**
1. **Чистый Сканнер**: Scanner Vibrato переведен на режим 100% Wet. Теперь фазовая модуляция полностью поглощает сигнал, исключая "двоение".
2. **Доминантный Ротор**: В `organ_soft_jazz` параметр `leslie.mix` поднят до `0.9`. Это практически полностью направляет сигнал через вращающиеся роторы.
3. **Безопасность**: Исправлена ошибка в `noteOff` — теперь источники Key Click гарантированно останавливаются и удаляются из памяти.

**РЕЗУЛЬТАТ:**
Достигнута полная тембральная интеграция. Орган звучит как единый, вращающийся в пространстве инструмент. Эффект "Лесли отдельно от пэда" устранен.

---

### ЗАПИСЬ: 2024-12-04 (План №24: "Интеграция и Укрощение Лесли")

**ПРОБЛЕМА:**
Пользователь сообщил об артефактах звука органа ("Виу Виу Виу"). Лесли-эффект звучал слишком агрессивно, доминируя над основным тоном и ощущался "отдельно" от инструмента.

**ПРИЧИНА:**
1. Глубина модуляции задержки (Doppler shift) была завышена в 4 раза относительно физических параметров реальных кабинетов Лесли.
2. В модели отсутствовала амплитудная модуляция (тремоло), из-за чего фазовые сдвиги не имели "массы" и звучали как синтетический вибрирующий слой поверх чистого сигнала.

**РЕШЕНИЕ:**
1. **Сдерживание Доплера**: Глубина `hornDepth` снижена с `0.0008` до `0.0002` (200 микросекунд). Это обеспечило музыкальный, мягкий частотный сдвиг.
2. **Амплитудная Склейка**: Внедрена амплитудная модуляция (AM), синхронизированная с LFO вращения. Громкость теперь пульсирует вместе с фазой, создавая эффект физического вращения динамика.
3. **Двухроторная Модель**: Добавлена независимая модуляция для "барабана" (НЧ) с небольшим смещением фазы и скорости относительно "рупора" (ВЧ).
4. **Баланс**: В пресете `organ_soft_jazz` параметр `leslie.mix` снижен до `0.5` для лучшей артикуляции основного тона.

**РЕЗУЛЬТАТ:**
Звук органа стал "собранным", теплым и аутентичным. Артефакты "сирены" устранены. Эффект Лесли теперь воспринимается как неотъемлемая часть акустического пространства инструмента.

---

### ЗАПИСЬ: 2024-12-04 (План №23: "Тотальная Санация Фабрики")

**ПРОБЛЕМА:**
В конвейерах `organ` и `synth` фабрики инструментов V2 обнаружены потенциальные утечки памяти. Ноды вспомогательных источников (key-click и шум) не отключались корректно, а метод `noteOff` игнорировал остановку не-осцилляторных источников.

**ПРИЧИНА:**
1. В `buildOrganEngine` ноды клика не включались в список `voiceNodes` для очистки.
2. Логика `noteOff` проверяла только `instanceof OscillatorNode`, пропуская `AudioBufferSourceNode`.

**РЕШЕНИЕ:**
1. **Замкнутый Цикл**: Все ноды, создаваемые внутри `noteOn` (включая `click`, `clickG` и шумовые гейны), теперь принудительно добавляются в массив `voiceNodes`.
2. **Универсальная Остановка**: В `noteOff` заменен фильтр типов. Теперь движок пытается вызвать `.stop()` у любой ноды, являющейся источником (Oscillator или BufferSource).
3. **Безопасность**: Добавлены блоки `try/catch` при дисконнекте нод для предотвращения падения движка при повторных вызовах.

**РЕЗУЛЬТАТ:**
Принцип "сыграл и умер" теперь соблюдается безукоризненно для всех типов синтеза. Риск перегрузки памяти при длительных сессиях сведен к минимуму.

---

### ЗАПИСЬ: 2024-12-04 (План №22: "Органный Бенефис в Зимнем Блюзе")

**ПРОБЛЕМА:**
Вступление в Winter Blues содержало пианино, которое пользователь счел лишним для текущей атмосферы, и синтезаторный пэд в середине интро, нарушающий аутентичность звучания Хаммонда.

**ПРИЧИНА:**
1. Пресет `pianoAccompaniment` был прописан в лотерее первой и последней стадий интро.
2. В третьей стадии интро в качестве аккомпанемента был задан синтезаторный пэд.

**РЕШЕНИЕ:**
1. **Чистка Ансамбля**: Из всех стадий части `INTRO_1` блюпринта `winter.ts` полностью удален инструмент `pianoAccompaniment`.
2. **Гарантированный Орган**: Вероятность вступления органа (`accompaniment`) в первой стадии интро поднята до 1.0.
3. **Унификация Тембра**: На всех четырех стадиях интро орган закреплен как основной гармонический инструмент (удален `synth_ambient_pad_lush`).

**РЕЗУЛЬТАТ:**
Вступление в Winter Blues теперь звучит строго и атмосферно. Орган Хаммонда является центральным инструментом с первого такта, обеспечивая мощную и стабильную гармоническую поддержку.

---

### ЗАПИСЬ: 2024-12-04 (План №20: "Активация Органного Цеха")

**ПРОБЛЕМА:**
Синтезаторы типа `organ` в версии V2 использовали стандартный синтезаторный конвейер, игнорируя специфическую логику Хаммонда (Drawbars, Leslie, Scanner Vibrato).

**ПРИЧИНА:**
В файле `presets-v2.ts` органные пресеты имели тип `type: 'synth'`, а в `instrument-factory.ts` отсутствовала полноценная реализация метода `buildOrganEngine`.

**РЕШЕНИЕ:**
1. **Реализация Движка**: В `instrument-factory.ts` внедрена полная эмуляция Hammond-органа. Добавлены модули для Drawbars (аддитивный синтез), Leslie Speaker (вращающийся динамик), Scanner Vibrato и Key Click.
2. **Маршрутизация**: Органные пресеты (`organ`, `organ_soft_jazz`, `organ_circus_of_dread`) переведены на новый тип `type: 'organ'`.
3. **Логирование**: Добавлены подробные логи процесса сборки в консоль для подтверждения работы нового конвейера.

**РЕЗУЛЬТАТ:**
Органный цех фабрики V2 активирован. Инструменты теперь звучат аутентично, используя гармоническое сложение и физическую модуляцию Leslie.

---

### ЗАПИСЬ: 2024-12-04 (План №19: "Пульсирующая Гармония")

**ПРОБЛЕМА:**
Аккомпанемент в блюзовых сюитах звучал слишком статично и разреженно. Требовалось увеличить "массу" звука, избегая при этом утомительных сверхдлинных пэдов.

**ПРИЧИНА:**
Метод `createAccompanimentAxiom` генерировал одну ноту на весь такт (4 доли), что создавало ощущение неподвижного гула.

**РЕШЕНИЕ:**
1. **Ритмический Пульс**: Логика `createAccompanimentAxiom` обновлена для жанра `blues`. Теперь вместо одного 4-тактового аккорда генерируются два 2-тактовых (половинные ноты). Это дает в два раза больше событий аккомпанемента без увеличения длительности звуков.
2. **Агрессивное Вступление**: В блюпринтах `dark.ts` и `winter.ts` шанс вступления аккомпанемента в первой стадии интро поднят до 0.8.
3. **Плотность**: Увеличены базовые диапазоны плотности (`density`) для всех стадий аккомпанемента.

**РЕЗУЛЬТАТ:**
Гармоническое сопровождение стало значительно более присутствующим и "живым". Исчез эффект застывшего звука, аранжировка ощущается более насыщенной и ритмически обоснованной.

---

### ЗАПИСЬ: 2024-12-04 (План №18: "Насыщение Перкуссии")

**ПРОБЛЕМА:**
Ритм-секция в блюзовых сюитах звучала недостаточно детализированно. Требовалось большее разнообразие перкуссионных звуков и качественных томов для создания живой атмосферы.

**ПРИЧИНА:**
Основной мастер-кит `blues_melancholic_master` содержал ограниченный набор сэмплов `perc-*` и томов.

**РЕШЕНИЕ:**
1. **Расширение Арсенала**: В массив `perc` кита `bluesMelancholicMaster` добавлен полный спектр доступных сэмплов `perc-001`...`perc-015`.
2. **Тома Sonor Classix**: Включены все три регистра высококачественных томов Sonor (`High`, `Mid`, `Low`).
3. **Текстурные Бонго**: Добавлен набор `drum_bongo_*` для придания музыке "деревянного", органичного оттенка.

**РЕЗУЛЬТАТ:**
Ударные партии в Winter Blues и Dark Blues стали значительно богаче и вариативнее, обеспечивая более глубокое погружение в атмосферу.

---

### ЗАПИСЬ: 2024-12-04 (План №15: "Принцип Кумулятивного Ансамбля")

**ПРОБЛЕМА:**
Вступление инструментов было слишком хаотичным, а вариативность соло была ограниченной. Спарклы звучали слишком часто, нарушая атмосферу Dark Blues.

**ПРИЧИНА:**
1. Логика активации в `evolve` не имела "памяти тембров" внутри части.
2. Отсутствовали механизмы микро-мутаций для гитарных ликов.
3. Вероятность спарклов была завышена для ритуального блюза.

**РЕШЕНИЕ:**
1. **Sticky Timbres**: В `FractalMusicEngine` внедрена карта `activatedInstruments: Map<InstrumentPart, string>`. Теперь инструмент, выбрав тембр в начале части, сохраняет его до конца текущей музыкальной части (`BlueprintPart`).
2. **Алхимия Вариативности**: В `music-theory.ts` реализована система случайных трансформаций ликов (транспозиция, инверсия, ритм). Это гарантирует уникальность каждой мелодической линии.
3. **Ревизия Dark Blues**:
    * Снижена вероятность спарклов до 0.08 (1-2 на 12 тактов).
    * Внедрена техника `power-chords` для аккомпанемента.
    * Реализована 4-стадийная лотерея в `INTRO_1` with конкуренцией органов и пианино.
    * Закреплен баланс 70/30 (соло/перебор) для Black Acoustic.
4. **Железная Гармония**: Реализована ускоренная смена аккордов (1/2 такта) специально для настроения `dark` в блюзе для усиления напряжения.

**РЕЗУЛЬТАТ:**
Достигнут эффект "вступления музыкантов на сцена". Музыка стала значительно более осмысленной, живой и атмосферно выверенной. Реализована бесконечная вариативность сольных партий.

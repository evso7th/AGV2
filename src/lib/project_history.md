
# Журнал Проекта "AuraGroove"

Этот документ является "живой спецификацией" и содержит историю ключевых решений и изменений, принятых в ходе разработки. Он служит "внешней памятью" для отслеживания эволюции проекта.

---

### ЗАПИСЬ: 2024-12-04 (План №23: "Тотальная Санация Фабрики")

**ПРОБЛЕМА:**
В конвейерах `organ` и `synth` фабрики инструментов V2 обнаружены потенциальные утечки памяти. Ноды вспомогательных источников (key-click и шум) не отключались корректно, а метод `noteOff` игнорировал остановку не-осцилляторных источников.

**ПРИЧИНА:**
1. В `buildOrganEngine` ноды клика не включались в список `voiceNodes` для очистки.
2. Логика `noteOff` проверяла только `instanceof OscillatorNode`, пропуская `AudioBufferSourceNode`.

**РЕШЕНИЕ:**
1. **Замкнутый Цикл**: Все ноды, создаваемые внутри `noteOn` (включая `click`, `clickG` и шумовые гейны), теперь принудительно добавляются в массив `voiceNodes`.
2. **Универсальная Остановка**: В `noteOff` заменен фильтр типов. Теперь движок пытается вызвать `.stop()` у любой ноды, являющейся источником (Oscillator или BufferSource).
3. **Безопасность**: Добавлены блоки `try/catch` при дисконнекте нод для предотвращения падения движка при повторных вызовах.

**РЕЗУЛЬТАТ:**
Принцип "сыграл и умер" теперь соблюдается безукоризненно для всех типов синтеза. Риск перегрузки памяти при длительных сессиях сведен к минимуму.

---

### ЗАПИСЬ: 2024-12-04 (План №22: "Органный Бенефис в Зимнем Блюзе")

**ПРОБЛЕМА:**
Вступление в Winter Blues содержало пианино, которое пользователь счел лишним для текущей атмосферы, и синтезаторный пэд в середине интро, нарушающий аутентичность звучания Хаммонда.

**ПРИЧИНА:**
1. Пресет `pianoAccompaniment` был прописан в лотерее первой и последней стадий интро.
2. В третьей стадии интро в качестве аккомпанемента был задан синтезаторный пэд.

**РЕШЕНИЕ:**
1. **Чистка Ансамбля**: Из всех стадий части `INTRO_1` блюпринта `winter.ts` полностью удален инструмент `pianoAccompaniment`.
2. **Гарантированный Орган**: Вероятность вступления органа (`accompaniment`) в первой стадии интро поднята до 1.0.
3. **Унификация Тембра**: На всех четырех стадиях интро орган закреплен как основной гармонический инструмент (удален `synth_ambient_pad_lush`).

**РЕЗУЛЬТАТ:**
Вступление в Winter Blues теперь звучит строго и атмосферно. Орган Хаммонда является центральным инструментом с первого такта, обеспечивая мощную и стабильную гармоническую поддержку.

---

### ЗАПИСЬ: 2024-12-04 (План №20: "Активация Органного Цеха")

**ПРОБЛЕМА:**
Синтезаторы типа `organ` в версии V2 использовали стандартный синтезаторный конвейер, игнорируя специфическую логику Хаммонда (Drawbars, Leslie, Scanner Vibrato).

**ПРИЧИНА:**
В файле `presets-v2.ts` органные пресеты имели тип `type: 'synth'`, а в `instrument-factory.ts` отсутствовала полноценная реализация метода `buildOrganEngine`.

**РЕШЕНИЕ:**
1. **Реализация Движка**: В `instrument-factory.ts` внедрена полная эмуляция Hammond-органа. Добавлены модули для Drawbars (аддитивный синтез), Leslie Speaker (вращающийся динамик), Scanner Vibrato и Key Click.
2. **Маршрутизация**: Органные пресеты (`organ`, `organ_soft_jazz`, `organ_circus_of_dread`) переведены на новый тип `type: 'organ'`.
3. **Логирование**: Добавлены подробные логи процесса сборки в консоль для подтверждения работы нового конвейера.

**РЕЗУЛЬТАТ:**
Органный цех фабрики V2 активирован. Инструменты теперь звучат аутентично, используя гармоническое сложение и физическую модуляцию Leslie.

---

### ЗАПИСЬ: 2024-12-04 (План №19: "Пульсирующая Гармония")

**ПРОБЛЕМА:**
Аккомпанемент в блюзовых сюитах звучал слишком статично и разреженно. Требовалось увеличить "массу" звука, избегая при этом утомительных сверхдлинных пэдов.

**ПРИЧИНА:**
Метод `createAccompanimentAxiom` генерировал одну ноту на весь такт (4 доли), что создавало ощущение неподвижного гула.

**РЕШЕНИЕ:**
1. **Ритмический Пульс**: Логика `createAccompanimentAxiom` обновлена для жанра `blues`. Теперь вместо одного 4-тактового аккорда генерируются два 2-тактовых (половинные ноты). Это дает в два раза больше событий аккомпанемента без увеличения длительности звуков.
2. **Агрессивное Вступление**: В блюпринтах `dark.ts` и `winter.ts` шанс вступления аккомпанемента в первой стадии интро поднят до 0.8.
3. **Плотность**: Увеличены базовые диапазоны плотности (`density`) для всех стадий аккомпанемента.

**РЕЗУЛЬТАТ:**
Гармоническое сопровождение стало значительно более присутствующим и "живым". Исчез эффект застывшего звука, аранжировка ощущается более насыщенной и ритмически обоснованной.

---

### ЗАПИСЬ: 2024-12-04 (План №18: "Насыщение Перкуссии")

**ПРОБЛЕМА:**
Ритм-секция в блюзовых сюитах звучала недостаточно детализированно. Требовалось большее разнообразие перкуссионных звуков и качественных томов для создания живой атмосферы.

**ПРИЧИНА:**
Основной мастер-кит `blues_melancholic_master` содержал ограниченный набор сэмплов `perc-*` и томов.

**РЕШЕНИЕ:**
1. **Расширение Арсенала**: В массив `perc` кита `bluesMelancholicMaster` добавлен полный спектр доступных сэмплов `perc-001`...`perc-015`.
2. **Тома Sonor Classix**: Включены все три регистра высококачественных томов Sonor (`High`, `Mid`, `Low`).
3. **Текстурные Бонго**: Добавлен набор `drum_bongo_*` для придания музыке "деревянного", органичного оттенка.

**РЕЗУЛЬТАТ:**
Ударные партии в Winter Blues и Dark Blues стали значительно богаче и вариативнее, обеспечивая более глубокое погружение в атмосферу.

---

### ЗАПИСЬ: 2024-12-04 (План №15: "Принцип Кумулятивного Ансамбля")

**ПРОБЛЕМА:**
Вступление инструментов было слишком хаотичным, а вариативность соло была ограниченной. Спарклы звучали слишком часто, нарушая атмосферу Dark Blues.

**ПРИЧИНА:**
1. Логика активации в `evolve` не имела "памяти тембров" внутри части.
2. Отсутствовали механизмы микро-мутаций для гитарных ликов.
3. Вероятность спарклов была завышена для ритуального блюза.

**РЕШЕНИЕ:**
1. **Sticky Timbres**: В `FractalMusicEngine` внедрена карта `activatedInstruments: Map<InstrumentPart, string>`. Теперь инструмент, выбрав тембр в начале части, сохраняет его до перехода в следующую секцию Блюпринта.
2. **Алхимия Вариативности**: В `music-theory.ts` реализована система случайных трансформаций ликов (транспозиция, инверсия, ритм). Это гарантирует уникальность каждой мелодической линии.
3. **Ревизия Dark Blues**:
    * Снижена вероятность спарклов до 0.08 (1-2 на 12 тактов).
    * Внедрена техника `power-chords` для аккомпанемента.
    * Реализована 4-стадийная лотерея в `INTRO_1` с конкуренцией органов и пианино.
    * Закреплен баланс 70/30 (соло/перебор) для Black Acoustic.
4. **Железная Гармония**: Реализована ускоренная смена аккордов (1/2 такта) специально для настроения `dark` в блюзе для усиления напряжения.

**РЕЗУЛЬТАТ:**
Достигнут эффект "вступления музыкантов на сцену". Музыка стала значительно более осмысленной, живой и атмосферно выверенной. Реализована бесконечная вариативность сольных партий.

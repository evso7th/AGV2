# Журнал Проекта "AuraGroove"

Этот документ является "живой спецификацией" и содержит историю ключевых решений и изменений, принятых в ходе разработки. Он служит "внешней памятью" для отслеживания эволюции проекта.

---

### ЗАПИСЬ: 2024-08-10

**ПРОБЛЕМА:**
Генерация ударных была сломана из-за ошибки `Uncaught ReferenceError: createDrumAxiom is not defined` в `fractal-music-engine.ts`.

**ДИАГНОСТИКА:**
Стек вызовов ошибки показал, что `FractalMusicEngine` пытался вызвать `createDrumAxiom`, но эта функция не была импортирована из `music-theory.ts`.

**РЕШЕНИЕ:**
В файл `src/lib/fractal-music-engine.ts` был добавлен импорт функции `createDrumAxiom` из файла `src/lib/music-theory.ts`.

**РЕЗУЛЬТАТ:** Ошибка устранена, генерация ударных партий восстановлена.

---

### ЗАПИСЬ: 2024-08-09

**СОБЫТИЕ: ТЕХНИЧЕСКИЙ СБОЙ**

**ОПИСАНИЕ:** Произошел технический сбой, в результате которого был утерян весь диалог с прототайпером. История взаимодействия и контекст предыдущих шагов были утрачены.

---

### ЗАПИСЬ: 2024-08-08

**ПРОБЛЕМА:**
Аккомпанемент в интро-секциях играл в слишком высоком регистре, что создавало "писклявый" и неприятный эффект. Ранее добавленное в блюпринт правило `register: { preferred: 'low' }` не работало.

**ДИАГНОСТИКА:**
Анализ кода показал, что функция, генерирующая аккомпанемент (`createAccompanimentAxiom`), имела жестко заданную октаву и не учитывала правила из блюпринта.

**РЕШЕНИЕ:**
1.  В `src/lib/music-theory.ts`: функция `createAccompanimentAxiom` была модифицирована. Теперь она принимает необязательный параметр `registerHint`. Если `registerHint` равен `'low'`, функция генерирует ноты в более низком диапазоне (октавы 2-3).
2.  В `src/lib/fractal-music-engine.ts`: в методе `generateOneBar` была добавлена логика, которая извлекает `registerHint` из правил текущей части блюпринта и передает его в `createAccompanimentAxiom`.

**РЕЗУЛЬТАТ:** Движок теперь корректно исполняет правило `register: 'low'` из блюпринта. Аккомпанемент в интро звучит на октаву ниже, что решает проблему "писклявости" и создает более глубокую атмосферу.

---

### ЗАПИСЬ: 2024-08-07

**ЗАДАЧА:**
Увеличить частоту использования перкуссионных сэмплов в аранжировке для добавления текстурного разнообразия.

**РЕШЕНИЕ:**
В файле `src/lib/music-theory.ts` в константе `STYLE_DRUM_PATTERNS`, в определении для жанра `ambient`, вероятность появления перкуссии (`percussion.probability`) была увеличена с `0.6` до `0.9`.

**РЕЗУЛЬТАТ:** Перкуссионные звуки (`perc-*`) теперь появляются в аранжировке значительно чаще, делая ритмическую текстуру более насыщенной и менее предсказуемой.

---

### ЗАПИСЬ: 2024-08-06

**ЗАДАЧА:**
Добавить диагностическое логирование для генерации и мутации басовых фраз для лучшего понимания их эволюции.

**РЕШЕНИЕ:**
В файл `src/lib/music-theory.ts` были добавлены `console.log`:
1.  В `generateAmbientBassPhrase` добавлен лог, выводящий MIDI-ноты каждой новой сгенерированной фразы (аксиомы).
2.  В `mutateBassPhrase` добавлен лог, который показывает тип примененной мутации и результирующую последовательность нот.

**РЕЗУЛЬТАТ:** Консоль теперь предоставляет полную картину эволюции басовой партии, от создания до ее трансформаций, что значительно упрощает отладку и дальнейшую настройку.

---

### ЗАПИСЬ: 2024-08-05

**ПРОБЛЕМА:**
Басовая партия была монотонной и не развивалась, что делало общую картину утомляющей.

**ДИАГНОСТИКА:**
Анализ кода показал, что движок генерировал одну и ту же басовую фразу на протяжении всей композиции.

**РЕШЕНИЕ:**
1.  В `src/lib/music-theory.ts` были созданы две новые функции:
    *   `generateAmbientBassPhrase` для генерации осмысленных, медленных басовых фраз.
    *   `mutateBassPhrase` для внесения тонких изменений в существующие фразы.
2.  В `src/lib/fractal-music-engine.ts` была внедрена система "библиотеки басовых фраз". Движок теперь будет хранить 4 фразы, циклически проигрывать их и с определенной вероятностью мутировать одну из них каждые 4 такта.

**РЕЗУЛЬТАТ:** Бас стал "живым" и "дышащим". Он сохраняет гармоническую основу, но при этом постоянно развивается, что делает музыку более интересной и менее предсказуемой.

---

### ЗАПИСЬ: 2024-08-04

**ПРОБЛЕМА:**
Полностью отсутствовали логи от Навигатора (`BlueprintNavigator`), что делало невозможным отслеживание смены частей (`INTRO`, `BUILD` и т.д.) и бандлов.

**ДИАГНОСТИКА:**
Анализ показал, что `BlueprintNavigator.tick()` корректно генерировал отладочное сообщение `logMessage`, но `FractalMusicEngine` в методе `evolve` игнорировал это сообщение и не выводил его в консоль.

**РЕШЕНИЕ:**
В метод `evolve()` файла `src/lib/fractal-music-engine.ts` добавлен блок кода, который проверяет наличие `logMessage` в объекте, возвращаемом Навигатором, и немедленно выводит его в консоль. Код был сопровожден комментарием, объясняющим его назначение.

**РЕЗУЛЬТАТ:** Логирование смены частей и бандлов полностью восстановлено.

---

### ЗАПИСЬ: 2024-08-03

**ЗАДАЧА:**
Сделать звучание мелодии более меланхоличным и глубоким.

**РЕШЕНИЕ:**
Понижена базовая октава для генерации мелодических мотивов. В функции `createMelodyMotif` (`src/lib/music-theory.ts`) значение константы `rootOctave` было изменено с `4` на `3`, что сместило все мелодические партии на октаву вниз.
**РЕЗУЛЬТАТ:** Мелодия приобрела более сдержанный и интроспективный характер.

---

### ЗАПИСЬ: 2024-08-02

**ЗАДАЧА:**
Удлинить и сделать более музыкально осмысленными мелодические мотивы, генерируемые движком, а также добавить логирование для их отслеживания.

**РЕШЕНИЕ:**
1.  В функции `createMelodyMotif` (`src/lib/music-theory.ts`) базовый контур мелодии был расширен с 4 до 8 ступеней (`[0, 2, 4, 5, 7, 5, 4, 2]`), что создает более завершенную музыкальную фразу.
2.  В ту же функцию был добавлен `console.log`, который выводит в консоль последовательность MIDI-нот каждого нового сгенерированного мотива.
**РЕЗУЛЬТАТ:** Мелодические фразы стали более выразительными, а их структура стала видимой в логах для анализа.

---

### ЗАПИСЬ: 2024-08-01 (Повторная)

**ПРОБЛЕМА:**
Партия `harmony` по-прежнему не генерировалась (`Harmony=0` в логах), что указывало на ошибку в логике генерации.

**ДИАГНОСТИКА:**
Анализ показал, что для генерации гармонии ошибочно использовалась функция `createAccompanimentAxiom`, которая создает события типа `accompaniment`. Для корректной работы необходима была функция, создающая события типа `harmony`.

**РЕШЕНИЕ:**
1. В `src/lib/music-theory.ts` была создана новая функция `createHarmonyAxiom`, которая является аналогом `createAccompanimentAxiom`, но корректно присваивает событиям тип `harmony`.
2. В `src/lib/fractal-music-engine.ts`, в методе `generateOneBar`, ошибочный вызов `createAccompanimentAxiom` был заменен на правильный `createHarmonyAxiom` внутри блока, отвечающего за генерацию гармонии.
**РЕЗУЛЬТАТ:** Партия `harmony` начала корректно генерироваться.

---

### ЗАПИСЬ: 2024-08-01

**СОБЫТИЕ: ОТКАТ ПРОЕКТА**

**ПРИЧИНА:**
Из-за неспособности ИИ-прототайпера решить критические проблемы, которые он сам создал (полное прекращение генерации партий `harmony` и `melody`, а также переполнение пула синтезаторов, вызывающее ошибки `No free voices`), было принято решение откатить кодовую базу.

**ДЕЙСТВИЕ:**
Выполнен откат проекта к версии `b1d824d`. Эта версия соответствует моменту, когда мы начали разбираться со спотыканиями при мутациях, но до внесения критических ошибок.

**КОНТЕКСТ:**
Непосредственно перед откатом был успешно выполнен План 192, интегрировавший в `SYSTEM_PROTOCOL.md` два новых закона:
- **Закон о Памяти Намерений (Комментирование):** Обязанность комментировать каждое значимое изменение.
- **Закон о Следе Действий (Ведение Журнала):** Обязанность вести и пополнять `project_history.md` при каждом изменении.

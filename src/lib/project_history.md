
# Журнал Проекта "AuraGroove"

---

### ЗАПИСЬ: 2024-12-04 (План №86: "Печать Полифонии")

**ПРОБЛЕМА:**
Даже после Санации №85 хрип звука сохранялся при игре аккордами на органе и синтезаторе.

**ПРИЧИНА:**
Обнаружена утечка в логике полифонии внутри `instrument-factory.ts`. Движки Organ и Synth использовали общие массивы для отслеживания осцилляторов. При игре аккорда каждая новая нота перезаписывала ссылки на узлы предыдущей, делая их "невидимыми" для системы остановки и очистки.

**РЕШЕНИЕ:**
1.  **Voice Isolation**: Полный отказ от общих переменных отслеживания в замыканиях движков.
2.  **Per-Voice Tracking**: Внедрена строгая регистрация всех узлов (осцилляторы, гейны, клики) внутри индивидуального объекта `voiceRecord` для каждой ноты.
3.  **Unified Cleanup**: Механизм `deepCleanup` теперь обслуживает все типы инструментов, гарантируя уничтожение всей цепочки узлов при завершении ноты.

**РЕЗУЛЬТАТ:**
Достигнута абсолютная стабильность при любой плотности аккордов. Проблема "бессмертных осцилляторов" ликвидирована. Звук чист во всех режимах.

---

### ЗАПИСЬ: 2024-12-04 (План №85: "Великая Санация")

**ПРОБЛЕМА:**
Критическое падение производительности и хрип звука при длительных сессиях и частой смене пресетов. Причина — накопление «зомби-инструментов» и работающих LFO в фоне.

**ПРИЧИНА:**
1.  Менеджеры V2 не вызывали `disconnect()` у старых инструментов при загрузке новых. Аудио-графы наслаивались друг на друга.
2.  Статические LFO (Leslie, Phaser, Tremolo) не имели механизма остановки и продолжали вычислять волны вечно.
3.  Транзиентные сэмплы щипков не всегда корректно разрывали все связи после завершения.

**РЕШЕНИЕ:**
1.  **Instrument Disposal**: В интерфейс `InstrumentAPI` добавлен обязательный метод `disconnect()`.
2.  **LFO Tracking**: Все статические LFO теперь регистрируются в массиве `internalLFOs` и принудительно останавливаются при отключении инструмента.
3.  **Manager Fix**: Менеджеры теперь гарантированно уничтожают старый аудио-граф перед созданием нового.
4.  **Deep Cleanup Unified**: Процедура глубокой очистки узлов распространена на все типы синтезаторов и транзиентов.

**РЕЗУЛЬТАТ:**
Стабильная работа даже при экстремально частой смене стилей. Нагрузка на CPU нормализована. Хрипы устранены.

---

### ЗАПИСЬ: 2024-12-04 (План №84.1: "Винтажный Тон и Очистка")

**РЕШЕНИЕ:**
1.  **Arctan-Sinh Distortion**: В `instrument-factory.ts` добавлена функция `makeVintageDistortion`, реализующая физически более корректную и приятную на слух кривую сатурации.
2.  **Notch 1000Hz**: В гитарный тракт интегрирован узкополосный фильтр для вырезания "носовых" резонансов, что делает звук менее синтетическим.
3.  **Preset Upgrade**: Пресеты `guitar_shineOn` и `guitar_muffLead` переведены на тип `vintage`. Громкость `muffLead` зафиксирована на уровне `0.3` для динамического контраста.

---

### ЗАПИСЬ: 2024-12-04 (План №83: "Стерилизация Конвейера")

**ПРОБЛЕМА:**
Обнаружены потенциальные утечки памяти в аудио-движке. Внутренние связи завершенных голосов сохранялись, препятствуя Garbage Collection. Обнаружена гонка состояний в счетчике активных голосов.

**ПРИЧИНА:**
1.  Метод `disconnect()` вызывался только для выходного узла голоса, оставляя внутренние связи (около 10 узлов на ноту) активными.
2.  Таймеры очистки (`setTimeout`) срабатывали без проверки, был ли голос уже удален вручную через `allNotesOff`.
3.  Избыточный узел `sumNode` в гитарном движке увеличивал сложность графа.

**РЕШЕНИЕ:**
1.  **Deep Disconnect**: Реализована функция `deepCleanup`, которая принудительно разрывает связи всех узлов внутри голоса.
2.  **State Protection**: Введен флаг `cleaned` для предотвращения повторной очистки и корректного уменьшения счетчика голосов.
3.  **Graph Optimization**: Удален `sumNode` в гитарном конвейере. Множитель 0.175 интегрирован в финальную огибающую.
4.  **Counter Shield**: Глобальный счетчик голосов защищен от отрицательных значений через `Math.max(0, ...)`.

**РЕЗУЛЬТАТ:**
Достигнута абсолютная чистота памяти при длительных сессиях. Аудио-граф оптимизирован, нагрузка на CPU снижена.

---

### ЗАПИСЬ: 2024-12-04 (План №82: "Липкий Ансамбль")

**ПРОБЛЕМА:**
Инструменты исчезали при переходе между частями сюиты, создавая неестественные "дыры" в аранжировке.

**ПРИЧИНА:**
Принудительная очистка памяти `activatedInstruments.clear()` на границах частей Блюпринта в методе `evolve`.

**РЕШЕНИЕ:**
1.  **Sticky Memory**: Удалена автоматическая очистка памяти. Инструмент, вступивший в игру, остается на сцене до конца музыкальной части.
2.  **Inheritance Logic**: Внедрено наследование тембров. Если новая часть не определяет инструмент явно, он продолжает играть тем же тембром, что и раньше.
3.  **Global Continuity**: В «Зимнем Блюзе» ударные и аккомпанемент закреплены как вечные константы с 1-го такта (шанс активации 1.0).

**РЕЗУЛЬТАТ:**
Достигнута монолитная, плотная аранжировка без случайных пауз. Оркестр ведет себя как единый живой организм.

---

### ЗАПИСЬ: 2024-12-04 (Балансировка Громкости и Величие Органов)

**РЕШЕНИЕ:**
1.  **Organ Boost**: Громкость всех органов Hammond в `presets-v2.ts` увеличена в 2 раза. Теперь они доминируют и наполняют пространство.
2.  **Muff Lead Calibration**: Громкость `guitar_muffLead` установлена на **0.3** для создания необходимого динамического зазора по сравнению с `guitar_shineOn` (0.7).

---

### ЗАПИСЬ: 2024-12-04 (План №81: "Динамический Мутагенез")

**ПРОБЛЕМА:**
Повторяемость соло при первом запуске сюиты и отсутствие музыкального развития темы.

**РЕШЕНИЕ:**
1.  **Semantic Selection**: Переход от жестких планов к семантическому выбору ликов по тегам (`major`/`minor`).
2.  **Musical Development**: Внедрена логика Секвенций (повтор со сдвигом по ладу) и Вариаций (инверсия рисунка, варьирование ритма).
3.  **Engine Jitter**: Добавлена принудительная встряска рандомайзера при инициализации для гарантии уникальности первого такта каждой сессии.

---

### ЗАПИСЬ: 2024-12-04 (План №79: "Гитара-Виртуоз")

**ПРОБЛЕМА:**
Мелодия гитары звучала слишком "органно" (длинные ноты, редкие атаки).

**РЕШЕНИЕ:**
1.  **Subdivision**: Внедрена функция дробления длинных нот на серию быстрых пассажей и "hammer-on" украшений.
2.  **S_ACTIVE**: Создан высокоплотный план соло (4-8 атак на такт) для кульминаций и соло-секций.

---

### ЗАПИСЬ: 2024-12-04 (План №78: "Наслоение Голосов")

**ПРОБЛЕМА:**
Резкое прерывание хвостов звука ("откусывание") при смене нот.

**РЕШЕНИЕ:**
1.  **Layering Logic**: Переход на самозавершающиеся ноты (Sampler-like logic). Метод `noteOn` теперь принимает `duration`.
2.  **Polyphonic Overlap**: Удален механизм принудительного отсечения предыдущей ноты того же питча. Ноты наслаиваются друг на друга, создавая естественный резонанс.

---

### ЗАПИСЬ: 2024-12-04 (План №77: "Физическое Моделирование Гитары")

**РЕШЕНИЕ:**
1.  **Pick Attack**: Добавлен шумовой транзиент (имитация удара медиатора) в начало каждой ноты.
2.  **Phase Color**: Внедрен гребенчатый фильтр (Comb Filter) с задержкой 2.5мс для имитации фазового "стекла" Stratocaster.
3.  **Cabinet Warmth**: Финальный EQ получил Low-Shelf подъем для придания веса реального усилителя.

---

### ЗАПИСЬ: 2024-12-04 (План №80: "Смирение Струн")

**РЕШЕНИЕ:**
Глобальное уменьшение базового гейна гитарного конвейера в фабрике инструментов в 4 раза (`sumNode.gain = 0.175`). Это обеспечило прозрачность гитары в миксе.

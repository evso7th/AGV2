// public/worklets/bass-processor.js
class BassProcessor extends AudioWorkletProcessor {
  static get parameterDescriptors() {
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–æ–ª—å—à–µ –Ω–µ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∏–∑–≤–Ω–µ ‚Äî –≤—Å—ë –≤ —Å–æ–±—ã—Ç–∏–∏
    return [];
  }

  constructor() {
    super();
    this.sampleRate = 44100;
    this.activeNotes = new Map(); // { frequency: noteState }
  }

  // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –±–µ–ª–æ–≥–æ —à—É–º–∞
  noise() {
    return Math.random() * 2 - 1;
  }

  // –§–∏–ª—å—Ç—Ä –Ω–∏–∑–∫–∏—Ö —á–∞—Å—Ç–æ—Ç
  lowpassFilter(input, cutoff, resonance, state) {
    const g = Math.tan(Math.PI * cutoff / this.sampleRate);
    const r = 1 / resonance;
    const y1 = state.y1;
    const y2 = state.y2;
    const x = input;
    const y = x - r * y1 - y2;
    const y1_new = g * y + y1;
    const y2_new = g * y1_new + y2;
    state.y1 = y1_new;
    state.y2 = y2_new;
    return y2_new;
  }

  // –î–∏—Å—Ç–æ—Ä—à–Ω (soft clip)
  softClip(input, drive) {
    if (drive <= 0) return input;
    const k = 2 * drive;
    return (input * (1 + k)) / (1 + k * Math.abs(input));
  }

  process(inputs, outputs, parameters) {
    const output = outputs[0];

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–≤—É–∫–∞
    for (let channel = 0; channel < output.length; channel++) {
      const channelData = output[channel];
      for (let i = 0; i < channelData.length; i++) {
        let sample = 0;
        for (const [freq, note] of this.activeNotes) {
          // –û—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π
          const pulse = (note.phase1 % (2 * Math.PI)) < Math.PI ? 1 : -1;
          // –°—É–±-—Å–ª–æ–π (–æ–∫—Ç–∞–≤–∞ –Ω–∏–∂–µ)
          const sub = Math.sin(note.phase2 * 0.5);
          // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ –¥–∏—Å—Ç–æ—Ä—à–Ω–∞
          const filtered = this.lowpassFilter(
            pulse + sub * 0.7,
            note.cutoff,
            note.resonance,
            note.filterState
          );
          const distorted = this.softClip(filtered, note.distortion);
          sample += distorted * note.gain;
          note.phase1 += (freq * 2 * Math.PI) / this.sampleRate;
          note.phase2 += (freq * 2 * Math.PI) / this.sampleRate;
        }
        channelData[i] = sample * 0.3;
      }
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ–º
    for (const [freq, note] of this.activeNotes) {
      if (note.state === 'decay') {
        note.gain *= 0.995;
        if (note.gain < 0.001) {
          this.activeNotes.delete(freq);
        }
      }
    }

    return true;
  }

  onmessage(event) {
    if (event.data.type === 'noteOn') {
      const { frequency, velocity, params } = event.data;

      // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ò–ó –°–û–ë–´–¢–ò–Ø
      const {
        cutoff = 400,
        resonance = 0.7,
        distortion = 0.02,
        portamento = 0.0
      } = params;

      // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–æ—Ç—ã
      this.activeNotes.set(frequency, {
        phase1: 0,
        phase2: 0,
        gain: velocity,
        cutoff,
        resonance,
        distortion,
        portamento,
        state: 'attack',
        filterState: { y1: 0, y2: 0 }
      });
    } else if (event.data.type === 'noteOff') {
      for (const note of this.activeNotes.values()) {
        note.state = 'decay';
      }
    }
  }
}

registerProcessor('bass-processor', BassProcessor);

 –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ/—É–ª—É—á—à–µ–Ω–æ
–ñ—ë—Å—Ç–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø—Ä–µ—Å–µ—Ç–∞–º
–¢–µ–ø–µ—Ä—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑
technique
–ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–µ sample-accurate
–ò—Å–ø–æ–ª—å–∑—É–µ–º
AudioParam.setValueAtTime()
–ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–ª–∏—Ñ–æ–Ω–∏–∏
–ö–∞–∂–¥–∞—è –Ω–æ—Ç–∞ ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –æ–±—ä–µ–∫—Ç –≤
activeNotes
–ü–æ—Ä—Ç–∞–º–µ–Ω—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ –ª–∏–Ω–µ–π–Ω—É—é –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é —á–∞—Å—Ç–æ—Ç—ã

üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ (—á–µ–∫-–ª–∏—Å—Ç –≠—Ç–∞–ø–∞ 4)
pluck ‚Üí —Ç—ë–ø–ª—ã–π, ghost ‚Üí –≥–ª—É—Ö–æ–π, slap ‚Üí –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π,
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–µ–Ω—è—é—Ç—Å—è –±–µ–∑ —â–µ–ª—á–∫–æ–≤,
–ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –¥–≤–µ –Ω–æ—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ,
legato ‚Üí –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –Ω–æ—Ç–∞–º–∏.

–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑
AudioParam
(
cutoff
,
resonance
–∏ —Ç.–¥.)
–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ —Å–æ–±—ã—Ç–∏–∏ noteOn
–ñ—ë—Å—Ç–∫–æ –∑–∞–¥–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤
process()
–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ params
–°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ—Ä—Ç–∞–º–µ–Ω—Ç–æ
–£–ø—Ä–æ—â–µ–Ω–æ: portamento –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

üìå –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–æ–±—ã—Ç–∏—é
–°–æ–±—ã—Ç–∏–µ –æ—Ç BassSynthManager –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å:

js


{
  type: 'noteOn',
  frequency: 82.4, // E2
  velocity: 0.6,
  params: {
    cutoff: 250,
    resonance: 0.3,
    distortion: 0.0,
    portamento: 0.0
  }
}


–¢–µ–ø–µ—Ä—å bass-processor.js:

–ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤,
–ü–æ–ª–Ω–æ—Å—Ç—å—é —É–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è,
–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø—É –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.


import { buildMultiInstrument, InstrumentAPI } from './instrument-factory';
import { V2_PRESETS } from './presets-v2';

/**
 * #–ó–ê–ß–ï–ú: –ù–∞—Å—Ç–æ—è—â–∏–π –±–ª—é–∑–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä ‚Äî –Ω–µ —Å–±–æ—Ä–∫–∞ –∫–ª–∏—à–µ, –∞ —è–∑—ã–∫ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π (‚ô≠5) ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (5/3).
 * #–ß–¢–û: 4 –¥–≤–∏–∂–∫–∞ (–≥–∞—Ä–º–æ–Ω–∏—è, –±–∞—Å, —Å–æ–ª–æ, —Ä–∏—Ç–º) —Å –º—É–∑—ã–∫–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –≤–º–µ—Å—Ç–æ –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.
 * #–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º —Å –≤–∞—à–∏–º–∏ –ø—Ä–µ—Å–µ—Ç–∞–º–∏ (guitar_shineOn, bass_jazz_warm).
 */

// ============================================================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ============================================================================

export interface BluesBrainConfig {
  tempo: number;           // 68-80 BPM –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –±–ª—é–∑–∞
  rootNote: number;        // MIDI root (55 = G3)
  emotion: {
    melancholy: number;    // 0.6-0.95
    darkness: number;      // 0.1-0.4
  };
  barsToGenerate: number;  // –æ–±—ã—á–Ω–æ 12, 24, 48
}

export const DEFAULT_CONFIG: BluesBrainConfig = {
  tempo: 72,
  rootNote: 55, // G3
  emotion: { melancholy: 0.82, darkness: 0.25 },
  barsToGenerate: 24
};

// ============================================================================
// –ö–û–ì–ù–ò–¢–ò–í–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (–ø–∞–º—è—Ç—å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞)
// ============================================================================

interface BluesCognitiveState {
  barIndex: number;                // 0..11 –≤ 12-bar —Ü–∏–∫–ª–µ
  phrasePhase: 'call' | 'response' | 'turnaround'; // –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç-—Ç—É—Ä–Ω–∞—Ä–∞—É–Ω–¥
  tensionLevel: number;            // 0.0-1.0 ‚Äî –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –æ—Ç ‚ô≠5
  blueNotePending: boolean;        // –æ–∂–∏–¥–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è ‚ô≠5 ‚Üí 5 –∏–ª–∏ 3
  lastAscendingBar: number;        // –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ö–æ—Ä–æ–Ω–Ω–æ–≥–æ –º–∞—Ä—à–∞
  emotion: {
    melancholy: number;
    darkness: number;
  };
}

// ============================================================================
// –ë–õ–Æ–ó–û–í–ê–Ø –ì–ê–†–ú–û–ù–ò–ß–ï–°–ö–ê–Ø –°–ò–°–¢–ï–ú–ê
// ============================================================================

class BluesHarmonyEngine {
  private readonly progression = [
    'i7', 'i7', 'i7', 'i7',
    'iv7', 'iv7', 'i7', 'i7',
    'v7', 'iv7', 'i7', 'v7'
  ];
  
  getChordForBar(bar: number, emotion: { melancholy: number }): { name: string; extensions: number[] } {
    const baseIndex = bar % 12;
    let chordName = this.progression[baseIndex];
    
    // Quick change –¥–ª—è –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏ (IV –Ω–∞ 2-–º —Ç–∞–∫—Ç–µ)
    if (baseIndex === 1 && emotion.melancholy > 0.7 && Math.random() < 0.4) {
      chordName = 'iv7';
    }
    
    // –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∞–∫–∫–æ—Ä–¥–æ–≤
    const extensions: number[] = [];
    
    // ‚ô≠5 –≤ –±–∞—Å –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏
    if (emotion.melancholy > 0.8 && Math.random() < 0.6) {
      extensions.push(-6); // ‚ô≠5 relative to root
    }
    
    // ‚ô≠9 –¥–ª—è –º—Ä–∞—á–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
    if (emotion.darkness > 0.3 && Math.random() < 0.4) {
      extensions.push(1); // ‚ô≠9
    }
    
    return { name: chordName, extensions };
  }
  
  getNextChordRoot(bar: number, rootNote: number): number {
    const offsets = [0, 0, 0, 0, 5, 5, 0, 0, 7, 5, 0, 7]; // semitone offsets for G blues
    const nextBar = (bar + 1) % 12;
    return rootNote + offsets[nextBar];
  }
}

// ============================================================================
// –í–û–õ–ö–ò–ù–ì-–ë–ê–° (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –ª–µ—Ç—É, –Ω–µ –∫–ª–∏—à–µ!)
// ============================================================================

class WalkingBassEngine {
  generateForBar(
    rootNote: number,
    chordName: string,
    barIndex: number,
    nextRoot: number,
    tempo: number
  ): FractalEvent[] {
    const events: FractalEvent[] = [];
    const beatDuration = 60 / tempo; // seconds per beat
    
    // –ü—Ä–∞–≤–∏–ª–∞ –≤–æ–ª–∫–∏–Ω–≥-–±–∞—Å–∞:
    // 1. –î–æ–ª—è: –∫–æ—Ä–µ–Ω—å –∞–∫–∫–æ—Ä–¥–∞
    // 2. –î–æ–ª—è: –ø—Ä–æ—Ö–æ–¥—è—â–∞—è –Ω–æ—Ç–∞ (–¥–∏–∞—Ç–æ–Ω–∏—á–µ—Å–∫–∞—è –∏–ª–∏ —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)
    // 3. –î–æ–ª—è: –∫–≤–∏–Ω—Ç–∞ –∏–ª–∏ —Å–µ–ø—Ç–∏–º–∞
    // 4. –î–æ–ª—è: –≤–µ–¥—É—â–∞—è –Ω–æ—Ç–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∞–∫–∫–æ—Ä–¥—É
    
    const root = rootNote - 12; // –æ–∫—Ç–∞–≤–∞ –Ω–∏–∂–µ –¥–ª—è –±–∞—Å–∞
    const fifth = root + 7;
    const seventh = root + 10;
    
    // –ü—Ä–æ—Ö–æ–¥—è—â–∞—è –Ω–æ—Ç–∞: —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫ –∫–≤–∏–Ω—Ç–µ –∏–ª–∏ –¥–∏–∞—Ç–æ–Ω–∏—á–µ—Å–∫–∞—è
    const passingNote = Math.random() < 0.6 
      ? root + 1  // —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è (‚ô≠2)
      : root + 2; // –¥–∏–∞—Ç–æ–Ω–∏—á–µ—Å–∫–∞—è (2-—è —Å—Ç—É–ø–µ–Ω—å)
    
    // –í–µ–¥—É—â–∞—è –Ω–æ—Ç–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∞–∫–∫–æ—Ä–¥—É (—Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)
    const leadingNote = nextRoot - 13; // –Ω–∞ –ø–æ–ª—Ç–æ–Ω–∞ –Ω–∏–∂–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ—Ä–Ω—è
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 4 –¥–æ–ª–µ–π
    const notes = [root, passingNote, fifth, leadingNote];
    const dynamics = ['mf', 'mp', 'mp', 'mp']; // –∞–∫—Ü–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ 1-–π –¥–æ–ª–µ
    
    notes.forEach((note, i) => {
      // –ú–∏–∫—Ä–æ–≥—É–º–∞–Ω–∏–∑–∞—Ü–∏—è: ¬±15–º—Å –Ω–∞ –∫–∞–∂–¥—É—é –¥–æ–ª—é
      const humanOffset = (Math.random() * 30 - 15) / 1000;
      
      events.push({
        type: 'bass',
        note,
        time: i * beatDuration + humanOffset,
        duration: beatDuration * 0.92,
        weight: 0.9 - i * 0.1, // —É–±—ã–≤–∞—é—â–∏–π –≤–µ—Å
        technique: 'pluck',
        dynamics: dynamics[i],
        phrasing: 'legato',
        harmonicContext: chordName
      });
    });
    
    return events;
  }
}

// ============================================================================
// –ú–ï–õ–û–î–ò–ß–ï–°–ö–ò–ô –î–í–ò–ñ–û–ö (—è–∑—ã–∫ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–π ‚ô≠5 ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π)
// ============================================================================

class BluesMelodyEngine {
  // –ú–∏–Ω–æ—Ä–Ω–∞—è –ø–µ–Ω—Ç–∞—Ç–æ–Ω–∏–∫–∞ + –±–ª—é–∑–æ–≤–∞—è –Ω–æ—Ç–∞ (‚ô≠5)
  private readonly bluesScale = [0, 3, 5, 6, 7, 10]; // semitone offsets from root
  
  generatePhrase(
    rootNote: number,
    phraseType: 'call' | 'response' | 'turnaround',
    barIndex: number,
    tempo: number,
    emotion: { melancholy: number; darkness: number },
    state: BluesCognitiveState
  ): FractalEvent[] {
    const events: FractalEvent[] = [];
    const beatDuration = 60 / tempo;
    const phraseStart = 0;
    
    // === –í–û–ü–†–û–° (call) ‚Äî –Ω–∏—Å—Ö–æ–¥—è—â–∞—è —Ñ—Ä–∞–∑–∞ —Å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ–º ===
    if (phraseType === 'call') {
      // –ë–∞–∑–æ–≤–∞—è –Ω–∏—Å—Ö–æ–¥—è—â–∞—è —Ñ—Ä–∞–∑–∞: 7 ‚Üí 5 ‚Üí ‚ô≠5 ‚Üí 3
      const phraseNotes = [10, 7, 6, 3]; // –∏–Ω–¥–µ–∫—Å—ã –≤ –±–ª—é–∑–æ–≤–æ–π —à–∫–∞–ª–µ
      
      phraseNotes.forEach((scaleIndex, i) => {
        const pitch = rootNote + this.bluesScale[scaleIndex] + 24; // +2 –æ–∫—Ç–∞–≤—ã –¥–ª—è —Å–æ–ª–æ
        
        // –ë–µ–Ω–¥ –Ω–∞ ‚ô≠5 (–∏–Ω–¥–µ–∫—Å 3 –≤ —à–∫–∞–ª–µ = 6 –ø–æ–ª—É—Ç–æ–Ω–æ–≤ = ‚ô≠5)
        const technique = scaleIndex === 3 && Math.random() < 0.75 
          ? 'bend' 
          : 'pick';
        
        // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –ø–µ—Ä–≤—ã–µ –Ω–æ—Ç—ã –∫–æ—Ä–æ—á–µ, –ø–æ—Å–ª–µ–¥–Ω—è—è ‚Äî –¥–ª–∏–Ω–Ω–µ–µ (–≤–æ–ø—Ä–æ—Å –±–µ–∑ –æ—Ç–≤–µ—Ç–∞)
        const duration = i === phraseNotes.length - 1 
          ? beatDuration * 1.8 
          : beatDuration * 0.7;
        
        events.push({
          type: 'melody',
          note: pitch,
          time: phraseStart + i * beatDuration * 0.9,
          duration,
          weight: 0.85 - i * 0.1,
          technique,
          dynamics: 'mp',
          phrasing: 'legato',
          harmonicContext: 'i7'
        });
      });
      
      // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –æ—Ç ‚ô≠5
      if (phraseNotes.includes(3)) {
        state.tensionLevel = Math.min(1.0, state.tensionLevel + 0.35);
        state.blueNotePending = true;
      }
      
      // –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞ –ø–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞ (¬´–Ω–µ–∑–∞–∫–æ–Ω—á–µ–Ω–Ω–æ—Å—Ç—å¬ª)
      events.push({
        type: 'rest',
        time: phraseStart + phraseNotes.length * beatDuration * 0.9,
        duration: beatDuration * 1.2,
        weight: 0.95,
        phrasing: 'breath'
      });
    }
    
    // === –û–¢–í–ï–¢ (response) ‚Äî –≤–æ—Å—Ö–æ–¥—è—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ ===
    else if (phraseType === 'response') {
      // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 3 ‚Üí 5 ‚Üí 7 (–±–µ–∑ ‚ô≠5!)
      const phraseNotes = state.blueNotePending 
        ? [3, 5, 7]    // –µ—Å–ª–∏ –±—ã–ª–æ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ ‚Äî —Ä–∞–∑—Ä–µ—à–∞–µ–º
        : [0, 3, 5];   // –∏–Ω–∞—á–µ ‚Äî —Å–ø–æ–∫–æ–π–Ω—ã–π –æ—Ç–≤–µ—Ç
      
      phraseNotes.forEach((scaleIndex, i) => {
        const pitch = rootNote + this.bluesScale[scaleIndex] + 24;
        
        // –í–∏–±—Ä–∞—Ç–æ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –Ω–æ—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        const technique = i === phraseNotes.length - 1 && Math.random() < 0.8
          ? 'vibrato'
          : 'pick';
        
        events.push({
          type: 'melody',
          note: pitch,
          time: phraseStart + i * beatDuration * 1.1,
          duration: beatDuration * 0.85,
          weight: 0.8 + i * 0.05, // –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏–µ –≤–µ—Å–∞
          technique,
          dynamics: 'mf',
          phrasing: 'portamento',
          harmonicContext: 'i7'
        });
      });
      
      // –°–±—Ä–æ—Å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
      state.tensionLevel = Math.max(0.1, state.tensionLevel - 0.4);
      state.blueNotePending = false;
    }
    
    // === –¢–£–†–ù–ê–†–ê–£–ù–î (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Ç–∞–∫—Ç–∞) ‚Äî —Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ ===
    else if (phraseType === 'turnaround') {
      // –•—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ö–æ–¥ –∫ —Ç–æ–Ω–∏–∫–µ: 3 ‚Üí ‚ô≠3 ‚Üí 2 ‚Üí ‚ô≠2 ‚Üí 1
      const chromaticRun = [3, 2, 1, 0, -1]; // semitone offsets from root+3
      
      chromaticRun.forEach((offset, i) => {
        const pitch = rootNote + 3 + offset + 24; // –Ω–∞—á–∏–Ω–∞–µ–º —Å ‚ô≠3
        
        events.push({
          type: 'melody',
          note: pitch,
          time: phraseStart + i * beatDuration * 0.45,
          duration: beatDuration * 0.4,
          weight: 0.7 + i * 0.06,
          technique: 'pick',
          dynamics: 'p',
          phrasing: 'staccato',
          harmonicContext: 'v7'
        });
      });
      
      // –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤ —Ç–æ–Ω–∏–∫—É
      events.push({
        type: 'melody',
        note: rootNote + 24,
        time: phraseStart + chromaticRun.length * beatDuration * 0.45,
        duration: beatDuration * 2.5,
        weight: 0.95,
        technique: 'vibrato',
        dynamics: 'mf',
        phrasing: 'sostenuto',
        harmonicContext: 'i7'
      });
      
      state.tensionLevel = 0.2;
      state.blueNotePending = false;
    }
    
    // === –ú–ò–ö–†–û–ê–†–¢–ò–ö–£–õ–Ø–¶–ò–Ø: —Å–≤–∏–Ω–≥ –∏ –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏—è ===
    this.applySwingAndHumanization(events, beatDuration, emotion);
    
    return events;
  }
  
  private applySwingAndHumanization(
    events: FractalEvent[],
    beatDuration: number,
    emotion: { melancholy: number }
  ): void {
    // –°–≤–∏–Ω–≥: —Ç—Ä–∏–æ–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ 2:1 —Å –≤–∞—Ä–∏–∞—Ü–∏–µ–π
    const swingRatio = 0.66 + (Math.random() - 0.5) * 0.08; // 0.62-0.70
    
    events.forEach((event, i) => {
      if (event.type !== 'rest') {
        // –°–≤–∏–Ω–≥ –Ω–∞ —á—ë—Ç–Ω—ã—Ö –¥–æ–ª—è—Ö
        if (i % 2 === 1) {
          event.time = event.time * swingRatio + (1 - swingRatio) * beatDuration;
        }
        
        // –ì—É–º–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–∏–Ω–≥–∞: ¬±25–º—Å —Å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–µ–π –∫ –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ñ—Ä–∞–∑–µ
        const maxOffsetMs = 20 + emotion.melancholy * 15;
        const offsetMs = (Math.random() * maxOffsetMs * 2 - maxOffsetMs) / 1000;
        event.time += offsetMs;
        
        // –ú–æ–¥—É–ª—è—Ü–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–ª—è ¬´–¥—ã—Ö–∞–Ω–∏—è¬ª
        if (event.technique === 'vibrato') {
          event.weight *= 0.95 + Math.random() * 0.1;
        }
      }
    });
  }
}

// ============================================================================
// –†–ò–¢–ú–ò–ß–ï–°–ö–ò–ô –î–í–ò–ñ–û–ö (–±–∞—Ä–∞–±–∞–Ω—ã —Å –Ω–∞—Å—Ç–æ—è—â–∏–º —Å–≤–∏–Ω–≥–æ–º)
// ============================================================================

class BluesRhythmEngine {
  generateDrumsForBar(
    barIndex: number,
    tempo: number,
    emotion: { melancholy: number }
  ): FractalEvent[] {
    const events: FractalEvent[] = [];
    const beatDuration = 60 / tempo;
    
    // Kick: 1 –∏ 3 –¥–æ–ª–∏ (—Å –≤–∞—Ä–∏–∞—Ü–∏–µ–π)
    [0, 2].forEach(beat => {
      const humanOffset = (Math.random() * 20 - 10) / 1000;
      events.push({
        type: 'drum_kick',
        note: 36, // C1 - kick
        time: beat * beatDuration + humanOffset,
        duration: beatDuration * 0.3,
        weight: 0.9 - beat * 0.1,
        technique: 'hit',
        dynamics: 'mf',
        phrasing: 'staccato'
      });
    });
    
    // Snare: 2 –∏ 4 –¥–æ–ª–∏ —Å —Å–≤–∏–Ω–≥–æ–º
    const swingOffset = beatDuration * (1 - 0.66); // —Ç—Ä–∏–æ–ª—å–Ω—ã–π —Å–≤–∏–Ω–≥
    
    [1, 3].forEach(beat => {
      const baseTime = beat * beatDuration;
      const swungTime = baseTime + (beat === 3 ? swingOffset : 0); // —Å–≤–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –Ω–∞ 4-–π –¥–æ–ª–µ
      
      const humanOffset = (Math.random() * 25 - 12) / 1000;
      events.push({
        type: 'drum_snare',
        note: 38, // D1 - snare
        time: swungTime + humanOffset,
        duration: beatDuration * 0.25,
        weight: 0.85,
        technique: 'hit',
        dynamics: 'mf',
        phrasing: 'staccato'
      });
    });
    
    // Hi-hat: –≤–æ—Å—å–º—ã–µ —Å —Ç—Ä–∏–æ–ª—å–Ω—ã–º —Å–≤–∏–Ω–≥–æ–º
    for (let i = 0; i < 8; i++) {
      const isTriplet = i % 3 === 0 || i % 3 === 1; // —Ç—Ä–∏–æ–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞
      const baseTime = (i / 2) * beatDuration;
      const swungTime = isTriplet 
        ? baseTime * 0.66 
        : baseTime * 0.34 + beatDuration * 0.66;
      
      // –ü—Ä–∏ –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ö–∞–π-—Ö—ç—Ç—ã (¬´—É—Å—Ç–∞–ª–æ—Å—Ç—å¬ª)
      if (emotion.melancholy > 0.8 && i % 2 === 1 && Math.random() < 0.4) continue;
      
      const humanOffset = (Math.random() * 15 - 7) / 1000;
      events.push({
        type: 'drum_hihat',
        note: 42, // F#1 - closed hihat
        time: swungTime + humanOffset,
        duration: beatDuration * 0.15,
        weight: 0.4 + Math.random() * 0.2,
        technique: 'hit',
        dynamics: 'p',
        phrasing: 'staccato'
      });
    }
    
    return events;
  }
}

// ============================================================================
// –ì–õ–ê–í–ù–´–ô –ì–ï–ù–ï–†–ê–¢–û–†
// ============================================================================

export interface FractalEvent {
  type: 'melody' | 'bass' | 'drum_kick' | 'drum_snare' | 'drum_hihat' | 'rest';
  note?: number;
  time: number;
  duration: number;
  weight: number;
  technique?: 'pick' | 'bend' | 'vibrato' | 'pluck' | 'hit';
  dynamics?: 'pp' | 'p' | 'mp' | 'mf' | 'f' | 'ff';
  phrasing?: 'legato' | 'staccato' | 'portamento' | 'sostenuto' | 'breath';
  harmonicContext?: string;
}

export class BluesBrain {
  private config: BluesBrainConfig;
  private state: BluesCognitiveState;
  private harmonyEngine = new BluesHarmonyEngine();
  private bassEngine = new WalkingBassEngine();
  private melodyEngine = new BluesMelodyEngine();
  private rhythmEngine = new BluesRhythmEngine();
  
  constructor(config?: Partial<BluesBrainConfig>) {
    this.config = { ...DEFAULT_CONFIG, ...config };
    this.state = {
      barIndex: 0,
      phrasePhase: 'call',
      tensionLevel: 0.3,
      blueNotePending: false,
      lastAscendingBar: -10,
      emotion: { ...this.config.emotion }
    };
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ì–õ–ê–í–ù–´–ô –ú–ï–¢–û–î –ì–ï–ù–ï–†–ê–¶–ò–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  generate(): { events: FractalEvent[]; metadata: any } {
    const barDuration = 60 / this.config.tempo;
    const allEvents: FractalEvent[] = [];
    const sections: { name: string; bars: number[] }[] = [];
    
    console.log(`üé∏ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ${this.config.barsToGenerate} —Ç–∞–∫—Ç–æ–≤ –±–ª—é–∑–∞...`);
    console.log(`   –¢–µ–º–ø: ${this.config.tempo} BPM | –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: ${this.getMidiNoteName(this.config.rootNote)}`);
    console.log(`   –≠–º–æ—Ü–∏—è: –º–µ–ª–∞–Ω—Ö–æ–ª–∏—è ${this.state.emotion.melancholy.toFixed(2)}, –º—Ä–∞–∫ ${this.state.emotion.darkness.toFixed(2)}`);
    
    for (let bar = 0; bar < this.config.barsToGenerate; bar++) {
      // –≠–≤–æ–ª—é—Ü–∏—è —ç–º–æ—Ü–∏–∏ (–±—Ä–æ—É–Ω–æ–≤—Å–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ)
      this.evolveEmotion();
      
      // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞–∑—ã —Ñ—Ä–∞–∑—ã (–∫–∞–∂–¥—ã–µ 4 —Ç–∞–∫—Ç–∞: call ‚Üí response ‚Üí call ‚Üí response)
      this.updatePhrasePhase(bar);
      
      // –ì–∞—Ä–º–æ–Ω–∏—è
      const chordInfo = this.harmonyEngine.getChordForBar(bar, this.state.emotion);
      
      // –°–ª–µ–¥—É—é—â–∏–π –∫–æ—Ä–µ–Ω—å –¥–ª—è –≤–µ–¥—É—â–µ–π –Ω–æ—Ç—ã –±–∞—Å–∞
      const nextRoot = this.harmonyEngine.getNextChordRoot(bar, this.config.rootNote);
      
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä—Ç–∏–π
      const bassEvents = this.bassEngine.generateForBar(
        this.config.rootNote,
        chordInfo.name,
        bar,
        nextRoot,
        this.config.tempo
      );
      
      const melodyEvents = this.melodyEngine.generatePhrase(
        this.config.rootNote,
        this.state.phrasePhase,
        bar,
        this.config.tempo,
        this.state.emotion,
        this.state
      );
      
      const drumEvents = this.rhythmEngine.generateDrumsForBar(
        bar,
        this.config.tempo,
        this.state.emotion
      );
      
      // –°–º–µ—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ç–µ–∫—É—â–∏–π —Ç–∞–∫—Ç
      [bassEvents, melodyEvents, drumEvents].forEach(events => {
        events.forEach(event => {
          event.time += bar * barDuration;
          if (event.type === 'melody') {
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —ç–∫—Å–ø—Ä–µ—Å—Å–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç–º–æ—Ü–∏–∏
            event.weight *= 0.7 + this.state.emotion.melancholy * 0.35;
          }
        });
        allEvents.push(...events);
      });
      
      // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ö–æ—Ä–æ–Ω–Ω–æ–≥–æ –º–∞—Ä—à–∞: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 6 —Ç–∞–∫—Ç–æ–≤
      this.applyAntiFuneralMarch(bar, barDuration, allEvents);
      
      // –ü—Ä–æ–≥—Ä–µ—Å—Å –≤ –∫–æ–Ω—Å–æ–ª–∏
      if ((bar + 1) % 12 === 0) {
        console.log(`   ‚úì –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${bar + 1} —Ç–∞–∫—Ç–æ–≤ (–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ: ${this.state.tensionLevel.toFixed(2)})`);
      }
    }
    
    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    const metadata = {
      totalTime: this.config.barsToGenerate * barDuration,
      avgTension: this.state.tensionLevel,
      sections,
      emotionProfile: {
        start: { ...this.config.emotion },
        end: { ...this.state.emotion }
      }
    };
    
    console.log(`‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${allEvents.length} —Å–æ–±—ã—Ç–∏–π`);
    
    return { events: allEvents, metadata };
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ó–ê–©–ò–¢–ê –û–¢ –ü–û–•–û–†–û–ù–ù–û–ì–û –ú–ê–†–®–ê (–º—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  private applyAntiFuneralMarch(bar: number, barDuration: number, events: FractalEvent[]): void {
    // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ 6+ —Ç–∞–∫—Ç–æ–≤ –±–µ–∑ –≤–æ—Å—Ö–æ–¥—è—â–µ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    if (bar - this.state.lastAscendingBar >= 6 && this.state.tensionLevel > 0.5) {
      const lastMelodyEvent = events
        .filter(e => e.type === 'melody')
        .slice(-1)[0];
      
      if (lastMelodyEvent) {
        const resolutionNote: FractalEvent = {
          type: 'melody',
          note: lastMelodyEvent.note! + 5, // –∫–≤–∏–Ω—Ç–∞ –≤–≤–µ—Ä—Ö ‚Äî –º—É–∑—ã–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
          time: lastMelodyEvent.time + lastMelodyEvent.duration + barDuration * 0.3,
          duration: barDuration * 1.2,
          weight: 0.92,
          technique: 'vibrato',
          dynamics: 'mf',
          phrasing: 'sostenuto',
          harmonicContext: 'i7'
        };
        
        events.push(resolutionNote);
        this.state.lastAscendingBar = bar;
        this.state.tensionLevel = 0.2;
      }
    }
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –≠–í–û–õ–Æ–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  private evolveEmotion(): void {
    // –ë—Ä–æ—É–Ω–æ–≤—Å–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
    this.state.emotion.melancholy += (Math.random() - 0.5) * 0.06;
    this.state.emotion.darkness += (Math.random() - 0.5) * 0.04;
    
    // –ö–ª–∏–ø–ø–∏–Ω–≥
    this.state.emotion.melancholy = Math.max(0.65, Math.min(0.95, this.state.emotion.melancholy));
    this.state.emotion.darkness = Math.max(0.15, Math.min(0.45, this.state.emotion.darkness));
  }
  
  private updatePhrasePhase(bar: number): void {
    const positionIn4BarCycle = bar % 4;
    
    if (positionIn4BarCycle === 0) this.state.phrasePhase = 'call';
    else if (positionIn4BarCycle === 2) this.state.phrasePhase = 'response';
    else if (bar % 12 >= 10) this.state.phrasePhase = 'turnaround'; // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Ç–∞–∫—Ç–∞ ‚Äî —Ç—É—Ä–Ω–∞—Ä–∞—É–Ω–¥
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –£–¢–ò–õ–ò–¢–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  private getMidiNoteName(midi: number): string {
    const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const octave = Math.floor(midi / 12) - 1;
    return `${notes[midi % 12]}${octave}`;
  }
  
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï –° –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê–ú–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  
  async play(ctx: AudioContext, events: FractalEvent[], when: number = 0): Promise<void> {
    console.log('‚ñ∂Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–∏—Ç–∞—Ä—ã (shineOn –¥–ª—è –º–µ–ª–∞–Ω—Ö–æ–ª–∏–∏)
    const guitar = await buildMultiInstrument(ctx, {
      type: 'guitar',
      preset: V2_PRESETS.guitar_shineOn
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞—Å–∞
    const bass = await buildMultiInstrument(ctx, {
      type: 'bass',
      preset: V2_PRESETS.bass_jazz_warm
    });
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥ —ç–º–æ—Ü–∏—é
    this.updateInstrumentParams(guitar, bass);
    
    console.log('üéµ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...');
    
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
    events.forEach(event => {
      const time = when + event.time;
      
      if (event.type === 'melody' && event.note !== undefined) {
        guitar.noteOn(event.note, time, event.weight);
        guitar.noteOff(event.note, time + event.duration);
        
        // –ë–µ–Ω–¥—ã —ç–º—É–ª–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é (—É—Å–ª–æ–≤–Ω–æ)
        if (event.technique === 'bend') {
          setTimeout(() => {
            // –í —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ pitchBend
          }, event.duration * 500);
        }
      }
      
      if (event.type === 'bass' && event.note !== undefined) {
        bass.noteOn(event.note, time, event.weight * 0.9);
        bass.noteOff(event.note, time + event.duration);
      }
      
      // –î—Ä–∞–º—ã –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    });
    
    // –ê–≤—Ç–æ–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ –æ–±—â—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å + 3 —Å–µ–∫—É–Ω–¥—ã
    const totalTime = events[events.length - 1].time + events[events.length - 1].duration + 3;
    
    return new Promise(resolve => {
      setTimeout(() => {
        guitar.allNotesOff();
        bass.allNotesOff();
        console.log('‚èπÔ∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
        resolve();
      }, totalTime * 1000);
    });
  }
  
  private updateInstrumentParams(guitar: InstrumentAPI, bass: InstrumentAPI): void {
    const emotion = this.state.emotion;
    
    // –ì–∏—Ç–∞—Ä–∞: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥ –º–µ–ª–∞–Ω—Ö–æ–ª–∏—é
    const cutoff = 3600 - emotion.darkness * 900; // 2700-3600 Hz
    const driveAmount = 0.18 + emotion.darkness * 0.32;
    const reverbMix = 0.20 + emotion.melancholy * 0.18;
    const adsrR = 1.8 + emotion.melancholy * 0.8;
    const expression = 0.65 + emotion.melancholy * 0.30;
    
    guitar.setParam('pickup.cutoff', cutoff);
    guitar.setParam('drive.amount', driveAmount);
    guitar.setParam('reverbMix', reverbMix);
    guitar.setParam('adsr.r', adsrR);
    guitar.setExpression(expression);
    
    // –ë–∞—Å: —Ç—ë–ø–ª—ã–π, —Å –ª—ë–≥–∫–∏–º –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–æ–º
    bass.setParam('filter.cutoff', 800 + emotion.melancholy * 200);
    bass.setParam('compressor.threshold', -16);
    bass.setParam('compressor.ratio', 3.5);
  }
}

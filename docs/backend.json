{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the AuraGroove V2 application. Authentication details are managed externally.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "The user's email address, used for identification.",
          "format": "email"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the user account was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the user account was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "createdAt",
        "updatedAt"
      ]
    },
    "Project": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Project",
      "type": "object",
      "description": "Represents a creative project or canvas created by a user, containing generated content and editable components.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Project entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who owns this project. (Relationship: User 1:N Project)"
        },
        "name": {
          "type": "string",
          "description": "The name of the project."
        },
        "description": {
          "type": "string",
          "description": "An optional description for the project."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the project was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the project was last updated.",
          "format": "date-time"
        },
        "thumbnailUrl": {
          "type": "string",
          "description": "An optional URL to a thumbnail image representing the project, e.g., a preview of the canvas.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "userId",
        "name",
        "createdAt",
        "updatedAt"
      ]
    },
    "GenerationLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GenerationLog",
      "type": "object",
      "description": "Records details of a content generation session using the generative AI model for a project.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the GenerationLog entity."
        },
        "projectId": {
          "type": "string",
          "description": "Reference to the Project this generation log belongs to. (Relationship: Project 1:N GenerationLog)"
        },
        "promptText": {
          "type": "string",
          "description": "The text prompt provided by the user to the generative AI model."
        },
        "generatedContent": {
          "type": "string",
          "description": "The initial content ideas (e.g., text) generated by the AI in response to the prompt."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the AI content was generated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "projectId",
        "promptText",
        "generatedContent",
        "createdAt"
      ]
    },
    "CanvasComponent": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CanvasComponent",
      "type": "object",
      "description": "Represents an individual editable element (text, image, or shape) placed on a project's canvas.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CanvasComponent entity."
        },
        "projectId": {
          "type": "string",
          "description": "Reference to the Project this component belongs to. (Relationship: Project 1:N CanvasComponent)"
        },
        "type": {
          "type": "string",
          "description": "The type of the component, e.g., 'text', 'image', or 'shape'.",
          "items": {
            "type": "string"
          }
        },
        "x": {
          "type": "number",
          "description": "The X-coordinate (horizontal position) of the component on the canvas."
        },
        "y": {
          "type": "number",
          "description": "The Y-coordinate (vertical position) of the component on the canvas."
        },
        "width": {
          "type": "number",
          "description": "The width of the component."
        },
        "height": {
          "type": "number",
          "description": "The height of the component."
        },
        "rotation": {
          "type": "number",
          "description": "The rotation angle of the component in degrees."
        },
        "zIndex": {
          "type": "number",
          "description": "The stacking order of the component on the canvas (higher values are on top)."
        },
        "content": {
          "type": "string",
          "description": "The text content for 'text' type components. Null for other types."
        },
        "imageUrl": {
          "type": "string",
          "description": "The URL of the image asset for 'image' type components. Null for other types.",
          "format": "uri"
        },
        "shapeType": {
          "type": "string",
          "description": "The specific type of geometric shape (e.g., 'rectangle', 'circle') for 'shape' type components. Null for other types.",
          "items": {
            "type": "string"
          }
        },
        "fillColor": {
          "type": "string",
          "description": "The fill color for shapes or text color for text components (e.g., hex code #RRGGBB)."
        },
        "borderColor": {
          "type": "string",
          "description": "The border color for shapes (e.g., hex code #RRGGBB). Null for other types."
        },
        "borderWidth": {
          "type": "number",
          "description": "The border width in pixels for shapes. Null for other types."
        },
        "fontSize": {
          "type": "number",
          "description": "The font size in pixels for 'text' type components. Null for other types."
        },
        "fontFamily": {
          "type": "string",
          "description": "The font family name for 'text' type components (e.g., 'Inter'). Null for other types."
        }
      },
      "required": [
        "id",
        "projectId",
        "type",
        "x",
        "y",
        "width",
        "height",
        "rotation",
        "zIndex"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Root collection for user profiles. Each document ID (`{userId}`) corresponds to the Firebase Authentication UID. Authorization relies on `request.auth.uid == userId`."
        }
      },
      {
        "path": "/users/{userId}/projects/{projectId}",
        "definition": {
          "entityName": "Project",
          "schema": {
            "$ref": "#/backend/entities/Project"
          },
          "description": "Subcollection for projects owned by a specific user. Each Project document includes the 'userId' field, which is denormalized for authorization independence. Rules ensure `request.auth.uid == userId` (from path and document data).",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns the project, corresponding to `request.auth.uid`."
            },
            {
              "name": "projectId",
              "description": "The unique identifier for a specific project."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/projects/{projectId}/generationLogs/{generationLogId}",
        "definition": {
          "entityName": "GenerationLog",
          "schema": {
            "$ref": "#/backend/entities/GenerationLog"
          },
          "description": "Subcollection for AI generation logs related to a specific project. Each GenerationLog document includes the 'userId' field (denormalized from the parent project for authorization independence) and 'projectId'. Rules ensure `request.auth.uid == userId` (from path and document data).",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns the parent project, corresponding to `request.auth.uid`."
            },
            {
              "name": "projectId",
              "description": "The unique identifier of the parent project."
            },
            {
              "name": "generationLogId",
              "description": "The unique identifier for a specific generation log entry."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/projects/{projectId}/canvasComponents/{canvasComponentId}",
        "definition": {
          "entityName": "CanvasComponent",
          "schema": {
            "$ref": "#/backend/entities/CanvasComponent"
          },
          "description": "Subcollection for canvas components (text, images, shapes) within a specific project. Each CanvasComponent document includes the 'userId' field (denormalized from the parent project for authorization independence) and 'projectId'. Rules ensure `request.auth.uid == userId` (from path and document data).",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns the parent project, corresponding to `request.auth.uid`."
            },
            {
              "name": "projectId",
              "description": "The unique identifier of the parent project."
            },
            {
              "name": "canvasComponentId",
              "description": "The unique identifier for a specific canvas component."
            }
          ]
        }
      }
    ],
    "reasoning": "The recommended Firestore structure prioritizes Authorization Independence and Structural Segregation to ensure robust, debuggable security rules and efficient queries. \n\n1.  **Authorization Independence (CRITICAL):** For all entities (`Project`, `GenerationLog`, `CanvasComponent`) that logically belong to a user, the `userId` of the owning user is explicitly denormalized into each document. This means that security rules will never need to use `get()` operations to check ownership against a parent document. For instance, to check if a user owns a `GenerationLog`, the rule will directly compare `request.auth.uid` with the `userId` field within the `generationLog` document itself, eliminating cross-document dependencies during authorization.\n\n2.  **Structural Segregation (Homogeneous Security Posture):** All data related to a specific user (their projects, generation logs, and canvas components) is nested under a `/users/{userId}` path. This ensures that all documents within a given collection (`/users/{userId}/projects`, `/users/{userId}/projects/{projectId}/generationLogs`, `/users/{userId}/projects/{projectId}/canvasComponents`) share the same security requirements: they are exclusively accessible by the `userId` specified in the path and denormalized within the document data. This avoids mixing public, collaborative, or other access patterns within the same collection, simplifying rule logic significantly.\n\n3.  **Access Modeling & QAPs (Queryable Authorization Patterns):**\n    *   **User Profiles:** Stored at `/users/{userId}`, where `{userId}` directly corresponds to `request.auth.uid`. This pattern is highly secure and enables simple `read/write` rules for self-owned user data.\n    *   **User-Owned Data (Projects):** Projects are structured as `/users/{userId}/projects/{projectId}`. Each `Project` document contains its `userId` field, making ownership explicit and queryable. A user can easily list their projects by querying `db.collection('users').doc(request.auth.uid).collection('projects')`. The security rule can ensure `request.auth.uid == resource.data.userId` and `request.auth.uid == userId` (from the path).\n    *   **Nested User-Owned Data (GenerationLogs, CanvasComponents):** These entities are further nested under their respective projects: `/users/{userId}/projects/{projectId}/generationLogs/{generationLogId}` and `/users/{userId}/projects/{projectId}/canvasComponents/{canvasComponentId}`. Critically, each `GenerationLog` and `CanvasComponent` document *also includes the `userId` field denormalized from its parent Project*. This allows secure `list` operations (QAPs) because a user can query for all logs or components within their project (`/users/{request.auth.uid}/projects/{projectId}/generationLogs`) and the rule can confirm that the `userId` in the path matches `request.auth.uid` and the `userId` in the document data, preventing unauthorized access. This denormalization is crucial for `Authorization Independence` and ensures efficient, non-filtering rules.\n\nThis structure ensures clear ownership, simplified security rules, and efficient querying, aligning perfectly with the core design principles."
  }
}
# Техническая Спецификация: СОР (Система Обеспечения Разнообразия) v1.0

## 1. Концепция
СОР (Система Обеспечения Разнообразия) — это многоуровневая когнитивная надстройка над FractalMusicEngine, превращающая алгоритмическую генерацию в осмысленное музыкальное повествование. Система имитирует работу живого ансамбля, где каждый участник обладает памятью, слышит коллег и подчиняется драматическому сюжету.

---

## 2. Иерархия Уровней (Stack)

### Уровень 1: Энергетический Скелет (Plot Tension)
*   **Математика**: Используется алгоритм **MusiNum** (сумма цифр числа в различных системах счисления) для создания детерминированной, но фрактально-сложной карты напряжения (`tensionMap`).
*   **Диапазон**: Контраст расширен до [0.05 - 0.95].
*   **Функция**: Напряжение (Tension) является первичным параметром, модулирующим бюджет энергии, сложность фраз и выбор тембров.

### Уровень 2: Оркестровый Бюджет (Energy Management)
*   **Принцип**: "Никакой каши". Каждому такту выделяется лимит очков: `100 + (tension * 100)`.
*   **Приоритеты (Priority Queue)**:
    1.  **P1: Solo** (50 очков) — Всегда забирает бюджет первым.
    2.  **P2: Rhythm Section** (20-25 очков) — Бас и ударные.
    3.  **P3: Harmonic Bed** (15-20 очков) — Аккорды и фортепиано.
    4.  **P4: Textures** (5-10 очков) — SFX и Sparkles.
*   **Результат**: Динамическая аранжировка, которая становится гуще на пиках и прозрачнее в интро.

### Уровень 3: Семантическая Сборка (Semantic Assembly)
*   **Логика**: Отказ от заготовленных планов соло. Каждому такту присваивается роль:
    *   `CALL` (Вопрос): Создание новой музыкальной аксиомы.
    *   `ELABORATION` (Развитие): Усложнение аксиомы.
    *   `CLIMAX` (Пик): Крик гитары, высокие регистры, бенды.
    *   `RESPONSE` (Ответ): Разрешение в тематическую ступень.
    *   `TURNAROUND` (Связка): Хроматический переход.

### Уровень 4: Фразовое Мышление (L-System Growth)
*   **Механика**: Рекурсивное развитие мелодии.
*   **Аксиома**: В фазе `CALL` создается "генетическое ядро" (2-3 ноты).
*   **Эволюция**: В последующих тактах к ядру применяются правила L-системы (инверсия, интервальное расширение, ритмическое дробление). Это создает тематическую связность сюиты на протяжении 15 минут.

### Уровень 5: Резонансный Диалог (Inter-Agent Resonance)
*   **Resonance Buffer**: Память о событиях предыдущего такта.
*   **Conversational Mode**:
    *   **Басист**: Слышит `CALL` гитары и отвечает активным `WALKING`.
    *   **Барабанщик**: Слышит `SCREAM` солиста и выдает `TOM_FILL`.
    *   **Harmony**: Слышит высокие ноты гитары и притихает (`Neighbor Listening`).

### Уровень 6: Тембральная Драматургия (Timbral Morphing)
*   **Инструментальная Лестница**: Инструменты меняют "голоса" в зависимости от Tension.
*   **Гитара**: Telecaster (Low) → Black Acoustic (Med) → Shine On (High).
*   **Орган**: Rhodes (Low) → Soft Jazz (Med) → Jimmy Smith (High).
*   **Функция**: Тембр становится инструментом повествования, а не просто настройкой.

---

## 3. Технические Защитные Системы (Guardrails)

1.  **Bass Floor**: Принудительный подъем нот баса выше MIDI 24 для предотвращения "немого" гула.
2.  **Anti-Funeral March**: Обнаружение затяжного нисходящего движения и принудительная вставка восходящего разрешения.
3.  **Crowding Guard**: Автоматическое упрощение баса до педали при критической плотности соло.
4.  **Weight Normalization**: Установление порога слышимости (0.35) для фоновых инструментов.

---

## 4. Контракт Данных
Вся коммуникация осуществляется через объект `FractalEvent`, дополненный семантическими тэгами `harmonicContext` и параметрами `instrumentHints`.

# Техническая Спецификация: СОР (Система Обеспечения Разнообразия) v2.1

## 1. Концепция
СОР — это многоуровневая когнитивная надстройка над FractalMusicEngine, превращающая алгоритмическую генерацию в осмысленное музыкальное повествование. Система имитирует работу живого ансамбля, где каждый участник обладает памятью, слышит коллег и подчиняется драматическому сюжету.

---

## 2. Ревизия Функций по Уровням

### Уровень 1: ГЕНЕЗИС (Genesis)
**Файл**: `src/lib/music-theory.ts`

*   `calculateMusiNum(...)`: Математическое ядро детерминированной фрактальности.
*   `transformLick(...)`: Движок Генетической Рекомбинации (Inversion, Retrograde, Transposition).
*   `crossoverDNA(...)`: Механизм скрещивания текущего семени с "шедеврами" из глобального генофонда.
*   `generateSuiteDNA(...)`: Алгоритм "Evolutionary Sowing" — посев структуры на основе скрещенного семени.

### Уровень 2: ПЛАНИРОВАНИЕ (Planning)
**Файл**: `src/lib/blueprint-navigator.ts`

*   `tick(currentBar)`: Навигация по иерархии БП.
*   `formatLogMessage(...)`: Глубокая телеметрия смены сцен и инструментов.

### Уровень 3: ОРКЕСТРОВКА (Orchestration)
**Файл**: `src/lib/fractal-music-engine.ts`

*   `evolve(...)`: Трансляция правил Блюпринта в контекст для Мозга. Управляет "activatedInstruments" ( Persistent Ensemble).

### Уровень 4: СОЧИНЕНИЕ (The Mind of SOR)
**Файл**: `src/lib/blues-brain.ts`

*   **Ensemble Stagnation Detector (Unified Novelty Guard)**: Анализирует совместный Rhythmic Shape Hash Солиста и Пианиста. При обнаружении "шарманки" (3 повтора подряд) делает принудительный сброс аксиомы.
*   `evaluateTimbralDramaturgy(...)`: Закон Тембрального Морфинга на основе напряжения.
*   `generatePercussionDialogue(...)`: Механизм Call-and-Response между ударными и солистом.
*   `generateWalkingBass(...)`: Генерация баса по правилам ведения голосов.

### Уровень 5: ТРАНСЛЯЦИЯ (Transmission)
**Файл**: `src/app/ambient.worker.ts`

*   **Suite State Machine**: Управляет циклом `PROMENADE -> MAIN -> BRIDGE -> MAIN`.
*   **AI Arbitrator**: Математический отбор семян (Res > 0.88) для пополнения глобальной памяти.

### Уровень 6: МАТЕРИАЛИЗАЦИЯ (Materialization)
**Файл**: `src/contexts/audio-engine-context.tsx`

*   **Global Gene Pool Manager**: Загрузка предков из Firestore при старте и оркестровка скрещивания.

### Уровень 7: ИСПОЛНЕНИЕ (Execution)
**Файл**: `src/lib/instrument-factory.ts`

*   **Steel Foundation**: Глобальный реестр голосов (GVR) и Voice Stealing. Стандарт транзиента 20мс. Мастер-лимитер.

---

## 3. Системные константы и правила

1.  **Закон Библии и Торы**: Работающий код не удаляется. Улучшение только через добавление.
2.  **Энергетический бюджет**: 150-250 очков. Ensemble Persistence дает скидку 30%.
3.  **Резонансный порог**: 0.88 для авто-сохранения в генофонд.
4.  **Регистровый потолок**: G5 (MIDI 79) для гитары.

---
**Статус**: Документация синхронизирована с Планом №239. Система стабильна.


# Техническая Спецификация: СОР (Система Обеспечения Разнообразия) v2.3

## 1. Концепция
СОР — это многоуровневая когнитивная надстройка над FractalMusicEngine, превращающая алгоритмическую генерацию в осмысленное музыкальное повествование. Система имитирует работу живого ансамбля, где каждый участник обладает памятью, слышит коллег и подчиняется драматическому сюжету.

---

## 2. Ревизия Функций по Уровням

### Уровень 4: СОЧИНЕНИЕ (The Mind of SOR)
**Файл**: `src/lib/blues-brain.ts`

*   **Isolated Piano Telemetry**: Каждый такт в консоль выводится точный нотный состав партии пианино: `[SOR] Piano Sequence: [G5, Bb5...]`.
*   **Piano Stagnation Vaccine**: При обнаружении 3-х повторов цикла пианист получает `stagnationOffset = 500`, что мгновенно меняет его мелодическую траекторию.
*   **Piano Register Ceiling**: В блюзовых жанрах пианисту запрещено подниматься выше 4-й октавы (MIDI 71 / B4). Автоматический октавный сдвиг вниз для высоких нот.
*   **Energy-Based Guitar Morphing**: Переключение пресетов гитары привязано к порогам Tension:
    *   `T < 0.50`: Black Acoustic
    *   `0.51 < T < 0.70`: CS80 Synth
    *   `T > 0.71`: ShineOn Lead
*   **BPM Hygiene**: Автоматическое разрежение плотности событий при темпах > 75 BPM.

### Уровень 5: ТРАНСЛЯЦИЯ (Transmission)
**Файл**: `src/app/ambient.worker.ts`

*   **AI Arbitrator**: Порог гармонического резонанса для авто-сохранения установлен в **0.85**.
*   **Actual BPM Sync**: Воркер передает в UI не только ноты, но и текущий BPM, вычисленный ДНК сюиты.

### Уровень 7: ИСПОЛНЕНИЕ (Execution)
**Файл**: `src/lib/instrument-factory.ts`

*   **AudioParam Safety**: Тотальная проверка всех значений времени и громкости на конечность (`isFinite`) перед подачей в Web Audio API.
*   **Volume Sovereignty**: Принцип неприкосновенности громкости. Все изменения уровней производятся только по прямой команде пользователя.

---

## 3. Системные константы и правила

1.  **Закон Библии и Торы**: Работающий код не удаляется. Улучшение только через добавление.
2.  **ПринципPersistent Ensemble**: Активированные инструменты не могут быть отключены Мозгом до конца части.
3.  **Резонансный порог**: 0.85 для наследования.
4.  **Регистровый потолок Гитариста**: MIDI 79 (G5) для гитары.
5.  **Регистровый потолок Пианиста**: MIDI 71 (B4).

---
**Статус**: Документация синхронизирована с Планом №283. Система стабильна.

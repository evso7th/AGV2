
# Техническая Спецификация: СОР (Система Обеспечения Разнообразия) v2.0

## 1. Концепция
СОР — это многоуровневая когнитивная надстройка над FractalMusicEngine, превращающая алгоритмическую генерацию в осмысленное музыкальное повествование. Система имитирует работу живого ансамбля, где каждый участник обладает памятью, слышит коллег и подчиняется драматическому сюжету.

---

## 2. Ревизия Функций по Уровням

### Уровень 1: ГЕНЕЗИС (Genesis)
**Файл**: `src/lib/music-theory.ts`

*   `calculateMusiNum(step, base, start, modulo)`: Математическое ядро детерминированной фрактальности. Обеспечивает неповторимость, но узнаваемость паттернов.
*   `generateTensionMap(seed, totalBars, mood)`: Создает энергетический скелет сюиты. Модулирует бюджет, сложность и тембры.
*   `generateSuiteDNA(...)`: Формирует "геном" пьесы: гармонический трек (Марковская цепь), темп и семантическое семя.
*   `transformLick(lick, seed, epoch)`: **[НОВОЕ]** Движок Генетической Рекомбинации. Трансформирует классические лики (Инверсия, Ретроград, Транспозиция) в уникальные аксиомы.
*   `crossoverDNA(seed, ancestor)`: Реализует механизм скрещивания (Breeding) текущего семени с "шедеврами" из прошлого.

### Уровень 2: ПЛАНИРОВАНИЕ (Planning)
**Файл**: `src/lib/blueprint-navigator.ts`

*   `tick(currentBar)`: Обеспечивает навигацию по иерархии Блюпринта (Part -> Bundle -> Phrase).
*   `formatLogMessage(...)`: Система глубокой телеметрии. Выводит отчет о смене сцен и инструментов только на границах блоков.

### Уровень 3: ОРКЕСТРОВКА (Orchestration)
**Файл**: `src/lib/fractal-music-engine.ts`

*   `initialize(force)`: Собирает ДНК, Навигатор и Генетическое Семя в единый механизм.
*   `evolve(barDuration, barCount)`: Сердцебиение дирижера. Вычисляет текущую сцену и транслирует правила Блюпринта в конкретные указания для "Мозга".
*   `generateOneBar(...)`: Разрешает "Призрачную Гармонию" и передает контекст в жанровые генераторы.

### Уровень 4: СОЧИНЕНИЕ (The Mind of SOR)
**Файл**: `src/lib/blues-brain.ts`

*   `generateBar(...)`: Центральный процессор принятия решений. Управляет Оркестровым Бюджетом (Energy Budget).
*   `evaluateTimbralDramaturgy(...)`: Закон Тембрального Морфинга. Меняет пресеты инструментов (Black -> CS80 -> ShineOn) на основе фрактального напряжения.
*   `generateLSystemMelody(...)`: Реализует рекурсивный рост мелодии из Генетического Семени.
*   `generateDrums(...)`: **[УЛУЧШЕНО]** Логика "Лояльного Барабанщика". Устраняет пропадание ударных, делая их громкость зависимой от напряжения. Включает алгоритм "Детерминированного Вздоха" (редкие паузы).
*   `generatePercussionDialogue(...)`: **[НОВОЕ]** Механизм Call-and-Response. Перкуссия отвечает на паузы солиста и подчеркивает Турнараунды (11-12 такты).
*   `generateWalkingBass(...)`: Генерация волкинг-баса на лету по правилам гармонического ведения, а не по шаблонам.

### Уровень 5: ТРАНСЛЯЦИЯ (Transmission)
**Файл**: `src/app/ambient.worker.ts`

*   `tick()`: Синхронизационный мост. Управляет таймингом Пролога (Променад) и обнаруживает состояния высокой резонансности (Beauty Score).

### Уровень 6: МАТЕРИАЛИЗАЦИЯ (Materialization)
**Файл**: `src/contexts/audio-engine-context.tsx`

*   `scheduleEvents(...)`: Маршрутизатор. Распределяет FractalEvents по конкретным менеджерам синтеза и сэмплерам.

### Уровень 7: ИСПОЛНЕНИЕ (Execution)
**Файл**: `src/lib/instrument-factory.ts`

*   `buildMultiInstrument(...)`: Физический синтез. Реализует сложные цепочки (Phaser, Leslie, Muff) с защитой от клиппинга.
*   `triggerAttack/Release(...)`: **[CRITICAL FIX]** Робастная система ADSR с тотальной проверкой `isFinite`, предотвращающая падение Audio API.

---

## 3. Системные константы и правила

1.  **Энергетический бюджет**: Базовый 150 очков. Рост до 250 на пиках.
2.  **Инерция Ансамбля**: Скидка 30% на энергию для уже играющих инструментов (Ensemble Persistence).
3.  **Закон ♭5**: Напряжение нагнетается через тритоны в фазах CALL и разрешается в фазах RESPONSE.
4.  **Регистровый потолок**: G5 (MIDI 79) для сохранения естественности звучания гитары.

---
**Статус**: Ревизия завершена. Система признана стабильной и музыкально выразительной.

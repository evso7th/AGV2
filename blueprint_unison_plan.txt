Отличная идея! Вы предлагаете создать "параллельную реальность" для композитора, где унисон — это не просто техника, а целый стиль, который пользователь может осознанно выбрать. Это элегантный, модульный подход, который не усложняет существующую логику, а расширяет ее.

Я полностью поддерживаю эту стратегию. Мы создадим два параллельных набора блюпринтов:

Стандартные блюпринты: Те, что мы только что внедрили (полифонические, текстурные).
Унисон-блюпринты: Новый набор, основанный на ваших файлах Ambient_Unison_concept.txt и ambient_blueprints_moods_unison.txt, где бас и аккомпанемент играют как единое целое.
Переключатель в UI будет просто указывать композитору, из какой "библиотеки" брать партитуру.

Цель: Реализовать в приложении переключаемый режим "Unison", который заставляет композитора использовать отдельный набор музыкальных блюпринтов, основанных на концепции унисона.

Действия:

Модификация src/types/fractal.ts (Типы):

Я обновлю интерфейс MusicBlueprint, добавив в него необязательные (optional) поля unisonPolicy и transitions. Это позволит унисон-блюпринтам содержать специфическую для них информацию, не ломая совместимость с обычными блюпринтами.
Модификация src/lib/blueprints.ts (Блюпринты):

Я создам и экспортирую новый объект UNISON_BLUEPRINTS_BY_MOOD.
Я наполню его блюпринтами для каждого настроения, взяв за основу ambient_blueprints_moods_unison.txt. Каждый из этих блюпринтов будет содержать unisonPolicy и transitions.
Модификация src/types/music.ts (Настройки):

Я добавлю новое свойство useUnison: boolean в тип WorkerSettings, чтобы передавать выбор пользователя в воркер.
Модификация src/app/ambient.worker.ts (Композитор):

В методе initializeEngine я добавлю простую логику: const blueprint = settings.useUnison ? UNISON_BLUEPRINTS_BY_MOOD[settings.mood] : BLUEPRINTS_BY_MOOD[settings.mood];. Теперь композитор будет выбирать партитуру из правильной библиотеки.
Модификация src/lib/fractal-music-engine.ts (Движок):

В методе generateOneBar я добавлю проверку: "Если в текущем блюпринте есть unisonPolicy...".
Если проверка пройдена, логика генерации аккомпанемента будет изменена, чтобы она создавала партию, основанную на басовой линии (в соответствии с правилами octave, strict и т.д.).
Также будет добавлена логика для генерации переходных фраз (bridges) на границах частей.
Модификация src/components/ui/aura-groove-v2.tsx (Интерфейс):

Я добавлю новый Switch компонент с иконкой GitBranch и подписью "Unison Mode" в секцию "Composition".
Этот переключатель будет управлять новым состоянием.
Модификация src/hooks/use-aura-groove.ts (Логика UI):

Я добавлю новое состояние useUnison и функцию setUseUnison.
Это состояние будет передаваться в воркер через updateSettings.
Сценарий Тестирования ("Око Правды"):

a) Что тестируем: Корректное переключение между стандартным и унисонным режимами.
b) Как тестируем:
Выполните "ДЕЛАЙ".
Запустите приложение, выберите стиль "Neuro F-Matrix", настроение 'melancholic'.
Убедитесь, что новый переключатель "Unison Mode" выключен. Нажмите "Play".
Тест 1 (Стандарт): Слушайте музыку. Она должна быть полифоничной, как и раньше.
Нажмите "Pause".
Тест 2 (Унисон): Включите "Unison Mode". Нажмите "Play".
c) Ожидаемый результат: Характер музыки должен кардинально измениться. В определенных секциях бас и аккомпанемент начнут играть в унисон. Музыка станет более монолитной и сфокусированной. Появятся гармонические "мосты" между частями.
d) Возможные ошибки: Переключатель не влияет на музыку; ошибки в консоли при включении нового режима.
e) Логи для анализа: В консоли воркера должны появляться логи [Engine] Unison Mode: ACTIVE при включенном переключателе.


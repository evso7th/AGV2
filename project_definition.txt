## Технический анализ проекта "AuraGroove"

Этот документ представляет собой анализ архитектуры и функциональности проекта, основанный исключительно на изучении исходного кода.

### 1. Общая архитектура

Проект AuraGroove представляет собой генератор эмбиент-музыки, построенный на архитектуре "Композитор-Исполнитель" для достижения высокой производительности и чистоты звука, особенно на мобильных устройствах.

-   **Композитор (Web Worker):** Вся логика генерации музыкальных партитур (нот, ритмов, гармоний) вынесена в отдельный поток с помощью Web Worker (`src/lib/ambient.worker.ts`). Это предотвращает "замораживание" пользовательского интерфейса во время интенсивных вычислений.
-   **Исполнители (AudioWorklets и Audio API):** Синтез и воспроизведение звука осуществляются в основном потоке, но с использованием высокопроизводительных `AudioWorklet` (`bass-processor.js`, `chord-processor.js`, `synth-processor.js`) и нативных узлов `AudioBufferSourceNode` (`DrumMachine`, `SparklePlayer`, `PadPlayer`). Это позволяет генерировать звук напрямую в аудио-потоке, минимизируя задержки и артефакты.
-   **Дирижер (Main Thread):** Основной поток, управляемый через `AudioEngineProvider`, выступает в роли дирижера. Он не создает музыку, а лишь получает готовые "партитуры" от воркера-композитора и делегирует их исполнение соответствующим аудио-менеджерам.

### 2. Ключевые модули и их взаимодействие

#### 2.1. Контекст и управление состоянием

-   **`src/contexts/audio-engine-context.tsx` (AudioEngineProvider):**
    -   **Роль:** Центральный узел управления аудио.
    -   **Функциональность:**
        -   Инициализирует глобальный `AudioContext`.
        -   Создает и управляет `GainNode` для каждой инструментальной партии (бас, мелодия, ударные и т.д.) и общим `masterGainNode`.
        -   Инициализирует цепочку 7-полосного эквалайзера (`BiquadFilterNode[]`), через которую проходит весь звук.
        -   Создает и управляет экземплярами всех "исполнителей": `BassSynthManager`, `AccompanimentSynthManager`, `DrumMachine`, `SparklePlayer`, `PadPlayer`.
        -   Создает и управляет **Web Worker'ом** (`ambient.worker.ts`), отправляя ему команды (`start`, `stop`, `update_settings`) и получая от него партитуры.
        -   Управляет пулом `AudioWorkletNode` (`synth-processor.js`) для синтеза мелодических партий.
        -   Предоставляет хук `useAudioEngine` для взаимодействия с аудиосистемой из UI.

-   **`src/hooks/use-aura-groove.ts`:**
    -   **Роль:** Мост между UI-компонентами и `AudioEngineProvider`.
    -   **Функциональность:**
        -   Хранит и управляет всеми настройками, которые выбирает пользователь в интерфейсе (BPM, стиль, инструменты, громкость, и т.д.).
        -   Использует `useAudioEngine` для передачи этих настроек в аудио-движок и воркер.
        -   Содержит логику для управления таймером сна, включая плавное затухание звука.
        -   Предоставляет обработчики событий для всех элементов управления UI.
        -   `useAuraGrooveLite` - облегченная версия только для инициализации на главной странице.

#### 2.2. Композиция (Web Worker)

-   **`src/lib/ambient.worker.ts`:**
    -   **Роль:** Композитор. Генерирует всю музыку.
    -   **Функциональность:**
        -   Работает в пассивном режиме, генерируя партитуру только при получении команды `tick`.
        -   Содержит объект `Scheduler`, который управляет внутренним состоянием (BPM, стиль, плотность и т.д.).
        -   На каждый `tick` вызывает методы у объектов-композиторов (`MulteityComposer`, `Composer`).
        -   **`Composer`:** Генерирует партитуры для баса, мелодии, аккомпанемента и ударных на основе плотности (`density`) и текущего такта. Логика мелодии основана на пошаговом "блуждании" по гамме.
        -   **`MulteityComposer`:** Альтернативный композитор для стиля "Multeity", генерирующий более сложные, полиритмичные партии.
        -   Управляет логикой появления "Sparkles" (случайных звуковых эффектов) и смены "Pads" (фоновых текстур) в зависимости от стиля.
        -   Отправляет готовую партитуру (`Score`) и команды для текстур в основной поток.

#### 23.3. Исполнение (Менеджеры и Ворклеты)

-   **`src/lib/bass-synth-manager.ts` и `public/worklets/bass-processor.js`:**
    -   **Роль:** Исполнение басовой партии.
    -   **Менеджер:** Получает ноты от `AudioEngineProvider`. Переключает пресеты и техники исполнения, отправляя команды в ворклет.
    -   **Ворклет:** Самодостаточный двух-осцилляторный субтрактивный синтезатор. Получает команды (`noteOn`, `setPreset`, `setMode`) и генерирует звук. Поддерживает несколько техник исполнения (`arpeggio`, `glide`, `pulse`), которые реализуются внутри самого ворклета.

-   **`src/lib/accompaniment-synth-manager.ts` и `public/worklets/chord-processor.js`:**
    -   **Роль:** Исполнение партии аккомпанемента.
    -   **Менеджер:** Аналогичен басовому, управляет пресетами.
    -   **Ворклет:** Специализированный синтезатор, который может воспроизводить аккорды с небольшим арпеджио ("живое" исполнение), получая массив нот.

-   **`public/worklets/synth-processor.js`:**
    -   **Роль:** Исполнение мелодических партий.
    -   **Функциональность:** Простой, но гибкий субтрактивный синтезатор с одним осциллятором, огибающей и фильтром. Управляется напрямую из `AudioEngineProvider`.

-   **`src/lib/drum-machine.ts`:**
    -   **Роль:** Исполнение партий ударных.
    -   **Функциональность:** Загружает сэмплы ударных и использует `AudioBufferSourceNode` для их воспроизведения с точным временем, полученным из партитуры. Громкость управляется через собственный `GainNode`.

-   **`src/lib/sparkle-player.ts` и `src/lib/pad-player.ts`:**
    -   **Роль:** Воспроизведение фоновых текстур.
    -   **`SparklePlayer`:** По команде от воркера проигрывает случайный короткий сэмпл ("искра").
    -   **`PadPlayer`:** По команде от воркера загружает и зацикливает длинный фоновый пэд. Реализует плавный 5-секундный кроссфейд при смене пэда.

### 3. Пользовательский интерфейс (UI)

-   **`src/app/page.tsx`:** Стартовый экран. Использует `useAuraGrooveLite` для инициализации аудио.
-   **`src/app/aura-groove/page.tsx` и `src/components/aura-groove-v2.tsx`:** Основной интерфейс приложения. Предоставляет элементы управления (слайдеры, селекторы, переключатели) и передает их значения в хук `useAuraGroove`.
-   **`src/app/aura-groove-legacy/page.tsx` и `src/components/aura-groove.tsx`:** "Старая" версия интерфейса. Функционально похожа на новую, но с другой компоновкой.
-   **`src/components/ui/`:** Стандартный набор компонентов `shadcn/ui` (Button, Slider, Card, Dialog и т.д.), используемый для построения всего интерфейса.

### 4. Поток данных при генерации музыки

1.  **Пользователь** нажимает "Play".
2.  **UI (`aura-groove-v2.tsx`)** вызывает `handleTogglePlay`.
3.  **Хук (`useAuraGroove.ts`)** вызывает `setEngineIsPlaying(true)`.
4.  **Контекст (`AudioEngineProvider`)** отправляет команду `{ command: 'start' }` в **Web Worker (`ambient.worker.ts`)**.
5.  **Воркер** запускает свой внутренний цикл (`Scheduler.tick()`) с интервалом, равным длительности одного такта.
6.  На каждый `tick` **Воркер** генерирует `Score` (объект с массивами нот для всех инструментов) и отправляет его в основной поток.
7.  **`AudioEngineProvider`** получает `Score` и вызывает соответствующие методы у менеджеров (`bassManager.schedule(...)`, `accompanimentManager.schedule(...)` и т.д.), передавая им массивы нот и время для планирования.
8.  **Менеджеры** отправляют команды (`noteOn`, `playChord`) в свои **AudioWorklet'ы**, которые синтезируют звук в аудиопотоке.
9.  Процесс повторяется каждый такт, создавая непрерывный музыкальный поток.
